Return-Path: <amd-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+amd-gfx@lfdr.de
Delivered-To: lists+amd-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 3102945668
	for <lists+amd-gfx@lfdr.de>; Fri, 14 Jun 2019 09:32:48 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id B3A8889938;
	Fri, 14 Jun 2019 07:32:42 +0000 (UTC)
X-Original-To: amd-gfx@lists.freedesktop.org
Delivered-To: amd-gfx@lists.freedesktop.org
Received: from mail-qt1-x843.google.com (mail-qt1-x843.google.com
 [IPv6:2607:f8b0:4864:20::843])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 7FE52892F3
 for <amd-gfx@lists.freedesktop.org>; Fri, 14 Jun 2019 00:44:55 +0000 (UTC)
Received: by mail-qt1-x843.google.com with SMTP id x47so569018qtk.11
 for <amd-gfx@lists.freedesktop.org>; Thu, 13 Jun 2019 17:44:55 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=pwIeL+wG8OH0fR+HAJUAqgJL6j2cGj41BLXWfdyXw+8=;
 b=DutC1Nvcu6SOGgUhLRWv9ke7s/CrPComCliSZW+H9berytiCPmkNjenEGT/dTl2/E5
 ZoBxRXMUw4D78W/42OLSYMkj/OGgaKOnEMC7bWEBufKyigsBuwFN4tofd8MeHGGNOaAH
 CovKePZcW+CKy3kq33HdF4/AAUtr17sZKO+jYzma2xHK3ZEv9t/O4wlZHRaEdhc41RpP
 ugY1Cgtfm8BYaXnIyD1fHPU1rtz+bYvM9P1TSKtmGBLWHcf2HQjPgElK85d8cwULyVsA
 JXuOE2HmHFWcBLU76p9bleAqfN5fURK0CnvstU7FNoYGNA5+8vOC93R/FancXHW1NjfA
 4jNA==
X-Gm-Message-State: APjAAAV3mA6DNO4nkqw2GxmOF/02Ct9bKT3rm1sGMVX01grPKEqylJ7C
 1sEl8R9QsCo+qasCb8dTQuzTFg==
X-Google-Smtp-Source: APXvYqwfWvFSMiMgzDqFFMCY1VR/I1m7UwfYWn0XpXg+QyDkHYMt7hRBdXD727WohxKVcOUw6fUB+w==
X-Received: by 2002:ac8:1a3c:: with SMTP id v57mr77400825qtj.339.1560473094617; 
 Thu, 13 Jun 2019 17:44:54 -0700 (PDT)
Received: from ziepe.ca
 (hlfxns017vw-156-34-55-100.dhcp-dynamic.fibreop.ns.bellaliant.net.
 [156.34.55.100])
 by smtp.gmail.com with ESMTPSA id w55sm902620qtw.11.2019.06.13.17.44.53
 (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
 Thu, 13 Jun 2019 17:44:54 -0700 (PDT)
Received: from jgg by mlx.ziepe.ca with local (Exim 4.90_1)
 (envelope-from <jgg@ziepe.ca>)
 id 1hbaKr-0005JX-Je; Thu, 13 Jun 2019 21:44:53 -0300
From: Jason Gunthorpe <jgg@ziepe.ca>
To: Jerome Glisse <jglisse@redhat.com>, Ralph Campbell <rcampbell@nvidia.com>,
 John Hubbard <jhubbard@nvidia.com>, Felix.Kuehling@amd.com
Subject: [PATCH v3 hmm 01/12] mm/hmm: fix use after free with struct hmm in
 the mmu notifiers
Date: Thu, 13 Jun 2019 21:44:39 -0300
Message-Id: <20190614004450.20252-2-jgg@ziepe.ca>
X-Mailer: git-send-email 2.21.0
In-Reply-To: <20190614004450.20252-1-jgg@ziepe.ca>
References: <20190614004450.20252-1-jgg@ziepe.ca>
MIME-Version: 1.0
X-Mailman-Approved-At: Fri, 14 Jun 2019 07:32:38 +0000
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=ziepe.ca; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=pwIeL+wG8OH0fR+HAJUAqgJL6j2cGj41BLXWfdyXw+8=;
 b=ceFocxAlhwC8ooDNQRZa8uwa3+dU+B2w/i8m8E2hFOYMSjwgE+QDjK2xkLm6VD72gE
 WwLJsyaKZvlbLH1T3GBNub1NlDlCK6BubNsnv1WbkKG8RNUlggQq8bBRTYJ5ZD3RlBUe
 5Xc4hRx6laHCPEGJWrsK7S9WLrDOWPmFo5Th/r3RbossSgw6mMZGxENAPWZu3X3SfIxe
 NKWPsMMCkPfwjaA/cZXhWZkA83335+sxM+8H517upoEyeM0OgJPsn7GyvWZ56NeXZYZ/
 EkASXeoAhhhAsXq8AEvm382rhtOeMbcMdaynxt6xBN1zXqpJZUfvbUeY29aKi9gpY3TE
 tkiw==
X-BeenThere: amd-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Discussion list for AMD gfx <amd-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/amd-gfx>
List-Post: <mailto:amd-gfx@lists.freedesktop.org>
List-Help: <mailto:amd-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Andrea Arcangeli <aarcange@redhat.com>, Philip Yang <Philip.Yang@amd.com>,
 linux-rdma@vger.kernel.org, amd-gfx@lists.freedesktop.org, linux-mm@kvack.org,
 Jason Gunthorpe <jgg@mellanox.com>, dri-devel@lists.freedesktop.org,
 Ira Weiny <ira.weiny@intel.com>, Ben Skeggs <bskeggs@redhat.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: amd-gfx-bounces@lists.freedesktop.org
Sender: "amd-gfx" <amd-gfx-bounces@lists.freedesktop.org>

RnJvbTogSmFzb24gR3VudGhvcnBlIDxqZ2dAbWVsbGFub3guY29tPgoKbW11X25vdGlmaWVyX3Vu
cmVnaXN0ZXJfbm9fcmVsZWFzZSgpIGlzIG5vdCBhIGZlbmNlIGFuZCB0aGUgbW11X25vdGlmaWVy
CnN5c3RlbSB3aWxsIGNvbnRpbnVlIHRvIHJlZmVyZW5jZSBobW0tPm1uIHVudGlsIHRoZSBzcmN1
IGdyYWNlIHBlcmlvZApleHBpcmVzLgoKUmVzdWx0aW5nIGluIHVzZSBhZnRlciBmcmVlIHJhY2Vz
IGxpa2UgdGhpczoKCiAgICAgICAgIENQVTAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgQ1BVMQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IF9fbW11X25vdGlmaWVyX2ludmFsaWRhdGVfcmFuZ2Vfc3RhcnQoKQogICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjdV9yZWFkX2xvY2sKICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhsaXN0X2Zvcl9lYWNoICgp
CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1u
ID09IGhtbS0+bW4KaG1tX21pcnJvcl91bnJlZ2lzdGVyKCkKICBobW1fcHV0KCkKICAgIGhtbV9m
cmVlKCkKICAgICAgbW11X25vdGlmaWVyX3VucmVnaXN0ZXJfbm9fcmVsZWFzZSgpCiAgICAgICAg
IGhsaXN0X2RlbF9pbml0X3JjdShobW0tbW4tPmxpc3QpCgkJCSAgICAgICAgICAgICAgICAgICAg
ICAgICAgIG1uLT5vcHMtPmludmFsaWRhdGVfcmFuZ2Vfc3RhcnQobW4sIHJhbmdlKTsKCQkJCQkg
ICAgICAgICAgICAgbW1fZ2V0X2htbSgpCiAgICAgIG1tLT5obW0gPSBOVUxMOwogICAgICBrZnJl
ZShobW0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgbXV0ZXhfbG9jaygmaG1tLT5sb2NrKTsKClVzZSBTUkNVIHRvIGtmcmVlIHRoZSBobW0gbWVt
b3J5IHNvIHRoYXQgdGhlIG5vdGlmaWVycyBjYW4gcmVseSBvbiBobW0KZXhpc3RpbmcuIEdldCB0
aGUgbm93LXNhZmUgaG1tIHN0cnVjdCB0aHJvdWdoIGNvbnRhaW5lcl9vZiBhbmQgZGlyZWN0bHkK
Y2hlY2sga3JlZl9nZXRfdW5sZXNzX3plcm8gdG8gbG9jayBpdCBhZ2FpbnN0IGZyZWUuCgpTaWdu
ZWQtb2ZmLWJ5OiBKYXNvbiBHdW50aG9ycGUgPGpnZ0BtZWxsYW5veC5jb20+ClJldmlld2VkLWJ5
OiBJcmEgV2VpbnkgPGlyYS53ZWlueUBpbnRlbC5jb20+ClJldmlld2VkLWJ5OiBKb2huIEh1YmJh
cmQgPGpodWJiYXJkQG52aWRpYS5jb20+ClJldmlld2VkLWJ5OiBSYWxwaCBDYW1wYmVsbCA8cmNh
bXBiZWxsQG52aWRpYS5jb20+ClRlc3RlZC1ieTogUGhpbGlwIFlhbmcgPFBoaWxpcC5ZYW5nQGFt
ZC5jb20+Ci0tLQp2MjoKLSBTcGVsbCAnZnJlZScgcHJvcGVybHkgKEplcm9tZS9SYWxwaCkKdjM6
Ci0gSGF2ZSBvbmx5IG9uZSBjbGVhcmVyIGNvbW1lbnQgYWJvdXQga3JlZl9nZXRfdW5sZXNzX3pl
cm8gKEpvaG4pCi0tLQogaW5jbHVkZS9saW51eC9obW0uaCB8ICAxICsKIG1tL2htbS5jICAgICAg
ICAgICAgfCAyMyArKysrKysrKysrKysrKysrKy0tLS0tLQogMiBmaWxlcyBjaGFuZ2VkLCAxOCBp
bnNlcnRpb25zKCspLCA2IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2luY2x1ZGUvbGludXgv
aG1tLmggYi9pbmNsdWRlL2xpbnV4L2htbS5oCmluZGV4IDcwMDcxMjM4NDJiYTc2Li5jYjAxY2Yx
ZmEzYzA4YiAxMDA2NDQKLS0tIGEvaW5jbHVkZS9saW51eC9obW0uaAorKysgYi9pbmNsdWRlL2xp
bnV4L2htbS5oCkBAIC05Myw2ICs5Myw3IEBAIHN0cnVjdCBobW0gewogCXN0cnVjdCBtbXVfbm90
aWZpZXIJbW11X25vdGlmaWVyOwogCXN0cnVjdCByd19zZW1hcGhvcmUJbWlycm9yc19zZW07CiAJ
d2FpdF9xdWV1ZV9oZWFkX3QJd3E7CisJc3RydWN0IHJjdV9oZWFkCQlyY3U7CiAJbG9uZwkJCW5v
dGlmaWVyczsKIAlib29sCQkJZGVhZDsKIH07CmRpZmYgLS1naXQgYS9tbS9obW0uYyBiL21tL2ht
bS5jCmluZGV4IDgyNjgxNmFiMjM3Nzk5Li5mNjk1NmQ3OGUzY2IyNSAxMDA2NDQKLS0tIGEvbW0v
aG1tLmMKKysrIGIvbW0vaG1tLmMKQEAgLTEwNCw2ICsxMDQsMTEgQEAgc3RhdGljIHN0cnVjdCBo
bW0gKmhtbV9nZXRfb3JfY3JlYXRlKHN0cnVjdCBtbV9zdHJ1Y3QgKm1tKQogCXJldHVybiBOVUxM
OwogfQogCitzdGF0aWMgdm9pZCBobW1fZnJlZV9yY3Uoc3RydWN0IHJjdV9oZWFkICpyY3UpCit7
CisJa2ZyZWUoY29udGFpbmVyX29mKHJjdSwgc3RydWN0IGhtbSwgcmN1KSk7Cit9CisKIHN0YXRp
YyB2b2lkIGhtbV9mcmVlKHN0cnVjdCBrcmVmICprcmVmKQogewogCXN0cnVjdCBobW0gKmhtbSA9
IGNvbnRhaW5lcl9vZihrcmVmLCBzdHJ1Y3QgaG1tLCBrcmVmKTsKQEAgLTExNiw3ICsxMjEsNyBA
QCBzdGF0aWMgdm9pZCBobW1fZnJlZShzdHJ1Y3Qga3JlZiAqa3JlZikKIAkJbW0tPmhtbSA9IE5V
TEw7CiAJc3Bpbl91bmxvY2soJm1tLT5wYWdlX3RhYmxlX2xvY2spOwogCi0Ja2ZyZWUoaG1tKTsK
KwltbXVfbm90aWZpZXJfY2FsbF9zcmN1KCZobW0tPnJjdSwgaG1tX2ZyZWVfcmN1KTsKIH0KIAog
c3RhdGljIGlubGluZSB2b2lkIGhtbV9wdXQoc3RydWN0IGhtbSAqaG1tKQpAQCAtMTQ0LDEwICsx
NDksMTQgQEAgdm9pZCBobW1fbW1fZGVzdHJveShzdHJ1Y3QgbW1fc3RydWN0ICptbSkKIAogc3Rh
dGljIHZvaWQgaG1tX3JlbGVhc2Uoc3RydWN0IG1tdV9ub3RpZmllciAqbW4sIHN0cnVjdCBtbV9z
dHJ1Y3QgKm1tKQogewotCXN0cnVjdCBobW0gKmhtbSA9IG1tX2dldF9obW0obW0pOworCXN0cnVj
dCBobW0gKmhtbSA9IGNvbnRhaW5lcl9vZihtbiwgc3RydWN0IGhtbSwgbW11X25vdGlmaWVyKTsK
IAlzdHJ1Y3QgaG1tX21pcnJvciAqbWlycm9yOwogCXN0cnVjdCBobW1fcmFuZ2UgKnJhbmdlOwog
CisJLyogQmFpbCBvdXQgaWYgaG1tIGlzIGluIHRoZSBwcm9jZXNzIG9mIGJlaW5nIGZyZWVkICov
CisJaWYgKCFrcmVmX2dldF91bmxlc3NfemVybygmaG1tLT5rcmVmKSkKKwkJcmV0dXJuOworCiAJ
LyogUmVwb3J0IHRoaXMgSE1NIGFzIGR5aW5nLiAqLwogCWhtbS0+ZGVhZCA9IHRydWU7CiAKQEAg
LTE4NSwxMyArMTk0LDE0IEBAIHN0YXRpYyB2b2lkIGhtbV9yZWxlYXNlKHN0cnVjdCBtbXVfbm90
aWZpZXIgKm1uLCBzdHJ1Y3QgbW1fc3RydWN0ICptbSkKIHN0YXRpYyBpbnQgaG1tX2ludmFsaWRh
dGVfcmFuZ2Vfc3RhcnQoc3RydWN0IG1tdV9ub3RpZmllciAqbW4sCiAJCQljb25zdCBzdHJ1Y3Qg
bW11X25vdGlmaWVyX3JhbmdlICpucmFuZ2UpCiB7Ci0Jc3RydWN0IGhtbSAqaG1tID0gbW1fZ2V0
X2htbShucmFuZ2UtPm1tKTsKKwlzdHJ1Y3QgaG1tICpobW0gPSBjb250YWluZXJfb2YobW4sIHN0
cnVjdCBobW0sIG1tdV9ub3RpZmllcik7CiAJc3RydWN0IGhtbV9taXJyb3IgKm1pcnJvcjsKIAlz
dHJ1Y3QgaG1tX3VwZGF0ZSB1cGRhdGU7CiAJc3RydWN0IGhtbV9yYW5nZSAqcmFuZ2U7CiAJaW50
IHJldCA9IDA7CiAKLQlWTV9CVUdfT04oIWhtbSk7CisJaWYgKCFrcmVmX2dldF91bmxlc3NfemVy
bygmaG1tLT5rcmVmKSkKKwkJcmV0dXJuIDA7CiAKIAl1cGRhdGUuc3RhcnQgPSBucmFuZ2UtPnN0
YXJ0OwogCXVwZGF0ZS5lbmQgPSBucmFuZ2UtPmVuZDsKQEAgLTIzNiw5ICsyNDYsMTAgQEAgc3Rh
dGljIGludCBobW1faW52YWxpZGF0ZV9yYW5nZV9zdGFydChzdHJ1Y3QgbW11X25vdGlmaWVyICpt
biwKIHN0YXRpYyB2b2lkIGhtbV9pbnZhbGlkYXRlX3JhbmdlX2VuZChzdHJ1Y3QgbW11X25vdGlm
aWVyICptbiwKIAkJCWNvbnN0IHN0cnVjdCBtbXVfbm90aWZpZXJfcmFuZ2UgKm5yYW5nZSkKIHsK
LQlzdHJ1Y3QgaG1tICpobW0gPSBtbV9nZXRfaG1tKG5yYW5nZS0+bW0pOworCXN0cnVjdCBobW0g
KmhtbSA9IGNvbnRhaW5lcl9vZihtbiwgc3RydWN0IGhtbSwgbW11X25vdGlmaWVyKTsKIAotCVZN
X0JVR19PTighaG1tKTsKKwlpZiAoIWtyZWZfZ2V0X3VubGVzc196ZXJvKCZobW0tPmtyZWYpKQor
CQlyZXR1cm47CiAKIAltdXRleF9sb2NrKCZobW0tPmxvY2spOwogCWhtbS0+bm90aWZpZXJzLS07
Ci0tIAoyLjIxLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fCmFtZC1nZnggbWFpbGluZyBsaXN0CmFtZC1nZnhAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0
dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vYW1kLWdmeA==
