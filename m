Return-Path: <amd-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+amd-gfx@lfdr.de
Delivered-To: lists+amd-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 08E5C18B838
	for <lists+amd-gfx@lfdr.de>; Thu, 19 Mar 2020 14:41:09 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 777AE6E2C4;
	Thu, 19 Mar 2020 13:41:06 +0000 (UTC)
X-Original-To: amd-gfx@lists.freedesktop.org
Delivered-To: amd-gfx@lists.freedesktop.org
Received: from mail-wr1-x441.google.com (mail-wr1-x441.google.com
 [IPv6:2a00:1450:4864:20::441])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 12C2F6E2C0
 for <amd-gfx@lists.freedesktop.org>; Thu, 19 Mar 2020 13:41:05 +0000 (UTC)
Received: by mail-wr1-x441.google.com with SMTP id w16so2998641wrv.13
 for <amd-gfx@lists.freedesktop.org>; Thu, 19 Mar 2020 06:41:04 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20161025;
 h=from:to:cc:subject:date:message-id:mime-version
 :content-transfer-encoding;
 bh=1/B6g7KaWygipa8vBWB6rm4EKmpOJXveEuWJBziW/zA=;
 b=tgIVIggOTo97muH8mvllOR/2dM8mUqxRv9Q2mjAeKpxxxyF37eKy/sb5Buz5IlClG9
 FmH64zowRa7wElNxP3skZP+ZiZWhQzgIXRJ1hAhSZyM3misO/Edl2AtIDgUg9Bbsx6UT
 Pmvnzh75aOU+8LOY+txybpgC2G4cQ//QuWkJvyTfl8p81ep4X4cq8e0vQJMLLwJ9/No4
 YhLCNlxN0Es1udYZeUwAbR8WHY8pySnhZmgAhMp/GFawteVvx8Hr3UakKnXxyHRiUUHv
 Ed5upnDRlt8etilL3MAKM9zsmMaokHMFo2AXVpo76IAza+H0J2AU4CdyQ5snldFEfqRL
 5Rtw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:mime-version
 :content-transfer-encoding;
 bh=1/B6g7KaWygipa8vBWB6rm4EKmpOJXveEuWJBziW/zA=;
 b=Hd6JOi0HSTrxaTiphhQXYLLd3Tei9pmxuo5RNXAnqkiwAIolk/kjX7ppa1FiUb0+q1
 hgyVhsI/asjYtpHzusUHSLQpxQZJAzV/MiioR5dUw7Bh5l40grpu5IUXp9B/xMSwG4Gy
 ekNE3kYNqdnooKZWAmXTjUwJl+7bAkk/vXsTHL55gBmsTfnKu6daGDOlVsiXGrOwIPvU
 CyjqoSaIzAEGAU9mE6kUMBBqC+xYCYnyA06XiuYnRStmIDaGku3qfMWJfqy4IFThI3jt
 ZDPHNW72dbkgTTwWwGtSk9hsv2LlbjsINrsEqt1Qh+Sb83rPOA+fuH+dk1h8YA1DB9he
 DDTA==
X-Gm-Message-State: ANhLgQ3n/6sY1uGnzETwoXtasutGNarOBvy/iEoWK0OQl8kS1j5VxVoW
 2svwBS5lDf+AFruiHPKQajErvq/D
X-Google-Smtp-Source: ADFU+vv73JjOaQ/r6uVsbOp5VfivnYi6NmdjeEb/ofN3SV4q/eigaDAuMYXZqus5fSQTwaMLwgOanw==
X-Received: by 2002:adf:ea4c:: with SMTP id j12mr4276954wrn.167.1584625263255; 
 Thu, 19 Mar 2020 06:41:03 -0700 (PDT)
Received: from abel.fritz.box ([2a02:908:1252:fb60:eca2:7dcd:fca0:220d])
 by smtp.gmail.com with ESMTPSA id s131sm3243833wmf.35.2020.03.19.06.41.02
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Thu, 19 Mar 2020 06:41:02 -0700 (PDT)
From: "=?UTF-8?q?Christian=20K=C3=B6nig?=" <ckoenig.leichtzumerken@gmail.com>
X-Google-Original-From: =?UTF-8?q?Christian=20K=C3=B6nig?=
 <christian.koenig@amd.com>
To: amd-gfx@lists.freedesktop.org
Subject: [PATCH 1/2] drm/amdgpu: cleanup amdgpu_ttm_copy_mem_to_mem and
 amdgpu_map_buffer
Date: Thu, 19 Mar 2020 14:41:01 +0100
Message-Id: <20200319134102.25679-1-christian.koenig@amd.com>
X-Mailer: git-send-email 2.17.1
MIME-Version: 1.0
X-BeenThere: amd-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Discussion list for AMD gfx <amd-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/amd-gfx>
List-Post: <mailto:amd-gfx@lists.freedesktop.org>
List-Help: <mailto:amd-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Felix.Kuehling@amd.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: amd-gfx-bounces@lists.freedesktop.org
Sender: "amd-gfx" <amd-gfx-bounces@lists.freedesktop.org>

Q2xlYW51cCBhbWRncHVfdHRtX2NvcHlfbWVtX3RvX21lbSBieSB1c2luZyBmZXdlciB2YXJpYWJs
ZXMKZm9yIHRoZSBzYW1lIHZhbHVlLgoKUmVuYW1lIGFtZGdwdV9tYXBfYnVmZmVyIHRvIGFtZGdw
dV90dG1fbWFwX2J1ZmZlciwgbW92ZSBpdAp0byBhdm9pZCB0aGUgZm9yd2FyZCBkZWNsZXJhdGlv
biwgY2xlYW51cCBieSBtb3ZpbmcgdGhlIG1hcApkZWNpc3Npb24gaW50byB0aGUgZnVuY3Rpb24g
YW5kIGFkZCBzb21lIGRvY3VtZW50YXRpb24uCgpObyBmdW5jdGlvbmFsIGNoYW5nZS4KClNpZ25l
ZC1vZmYtYnk6IENocmlzdGlhbiBLw7ZuaWcgPGNocmlzdGlhbi5rb2VuaWdAYW1kLmNvbT4KLS0t
CiBkcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdHRtLmMgfCAyNDQgKysrKysrKysr
KysrLS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgMTE4IGluc2VydGlvbnMoKyksIDEyNiBk
ZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRn
cHVfdHRtLmMgYi9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdHRtLmMKaW5kZXgg
NjY1ZGIyMzUzYTc4Li4yYjU5NzQyNjhlNjMgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9h
bWQvYW1kZ3B1L2FtZGdwdV90dG0uYworKysgYi9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9h
bWRncHVfdHRtLmMKQEAgLTYyLDEyICs2Miw2IEBACiAKICNkZWZpbmUgQU1ER1BVX1RUTV9WUkFN
X01BWF9EV19SRUFECShzaXplX3QpMTI4CiAKLXN0YXRpYyBpbnQgYW1kZ3B1X21hcF9idWZmZXIo
c3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibywKLQkJCSAgICAgc3RydWN0IHR0bV9tZW1fcmVn
ICptZW0sIHVuc2lnbmVkIG51bV9wYWdlcywKLQkJCSAgICAgdWludDY0X3Qgb2Zmc2V0LCB1bnNp
Z25lZCB3aW5kb3csCi0JCQkgICAgIHN0cnVjdCBhbWRncHVfcmluZyAqcmluZywgYm9vbCB0bXos
Ci0JCQkgICAgIHVpbnQ2NF90ICphZGRyKTsKLQogc3RhdGljIGludCBhbWRncHVfaW52YWxpZGF0
ZV9jYWNoZXMoc3RydWN0IHR0bV9ib19kZXZpY2UgKmJkZXYsIHVpbnQzMl90IGZsYWdzKQogewog
CXJldHVybiAwOwpAQCAtMjkzLDYgKzI4Nyw5MiBAQCBzdGF0aWMgc3RydWN0IGRybV9tbV9ub2Rl
ICphbWRncHVfZmluZF9tbV9ub2RlKHN0cnVjdCB0dG1fbWVtX3JlZyAqbWVtLAogCXJldHVybiBt
bV9ub2RlOwogfQogCisvKioKKyAqIGFtZGdwdV90dG1fbWFwX2J1ZmZlciAtIE1hcCBtZW1vcnkg
aW50byB0aGUgR0FSVCB3aW5kb3dzCisgKiBAYm86IGJ1ZmZlciBvYmplY3QgdG8gbWFwCisgKiBA
bWVtOiBtZW1vcnkgb2JqZWN0IHRvIG1hcAorICogQG51bV9wYWdlczogbnVtYmVyIG9mIHBhZ2Vz
IHRvIG1hcAorICogQG9mZnNldDogb2Zmc2V0IGludG8gQG1lbSB3aGVyZSB0byBzdGFydAorICog
QHdpbmRvd3M6IHdoaWNoIEdBUlQgd2luZG93IHRvIHVzZQorICogQHJpbmc6IERNQSByaW5nIHRv
IHVzZSBmb3IgdGhlIGNvcHkKKyAqIEB0bXo6IGlmIHdlIHNob3VsZCBzZXR1cCBhIFRNWiBlbmFi
bGVkIG1hcHBpbmcKKyAqIEBhZGRyOiByZXN1bHRpbmcgYWRkcmVzcyBpbnNpZGUgdGhlIE1DIGFk
ZHJlc3Mgc3BhY2UKKyAqCisgKiBTZXR1cCBvbmUgb2YgdGhlIEdBUlQgd2luZG93cyB0byBhY2Nl
c3MgYSBzcGVjaWZpYyBwaWVjZSBvZiBtZW1vcnkuCisgKi8KK3N0YXRpYyBpbnQgYW1kZ3B1X3R0
bV9tYXBfYnVmZmVyKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCisJCQkJIHN0cnVjdCB0
dG1fbWVtX3JlZyAqbWVtLAorCQkJCSBzdHJ1Y3QgZHJtX21tX25vZGUgKm1tX25vZGUsCisJCQkJ
IHVuc2lnbmVkIG51bV9wYWdlcywgdWludDY0X3Qgb2Zmc2V0LAorCQkJCSB1bnNpZ25lZCB3aW5k
b3csIHN0cnVjdCBhbWRncHVfcmluZyAqcmluZywKKwkJCQkgYm9vbCB0bXosIHVpbnQ2NF90ICph
ZGRyKQoreworCXN0cnVjdCB0dG1fZG1hX3R0ICpkbWEgPSBjb250YWluZXJfb2YoYm8tPnR0bSwg
c3RydWN0IHR0bV9kbWFfdHQsIHR0bSk7CisJc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYgPSBy
aW5nLT5hZGV2OworCXN0cnVjdCBhbWRncHVfam9iICpqb2I7CisJdW5zaWduZWQgbnVtX2R3LCBu
dW1fYnl0ZXM7CisJZG1hX2FkZHJfdCAqZG1hX2FkZHJlc3M7CisJc3RydWN0IGRtYV9mZW5jZSAq
ZmVuY2U7CisJdWludDY0X3Qgc3JjX2FkZHIsIGRzdF9hZGRyOworCXVpbnQ2NF90IGZsYWdzOwor
CWludCByOworCisJQlVHX09OKGFkZXYtPm1tYW4uYnVmZmVyX2Z1bmNzLT5jb3B5X21heF9ieXRl
cyA8CisJICAgICAgIEFNREdQVV9HVFRfTUFYX1RSQU5TRkVSX1NJWkUgKiA4KTsKKworCS8qIE1h
cCBvbmx5IHdoYXQgY2FuJ3QgYmUgYWNjZXNzZWQgZGlyZWN0bHkgKi8KKwlpZiAobWVtLT5zdGFy
dCAhPSBBTURHUFVfQk9fSU5WQUxJRF9PRkZTRVQpIHsKKwkJKmFkZHIgPSBhbWRncHVfbW1fbm9k
ZV9hZGRyKGJvLCBtbV9ub2RlLCBtZW0pICsgb2Zmc2V0OworCQlyZXR1cm4gMDsKKwl9CisKKwkq
YWRkciA9IGFkZXYtPmdtYy5nYXJ0X3N0YXJ0OworCSphZGRyICs9ICh1NjQpd2luZG93ICogQU1E
R1BVX0dUVF9NQVhfVFJBTlNGRVJfU0laRSAqCisJCUFNREdQVV9HUFVfUEFHRV9TSVpFOworCSph
ZGRyICs9IG9mZnNldCAmIH5QQUdFX01BU0s7CisKKwludW1fZHcgPSBBTElHTihhZGV2LT5tbWFu
LmJ1ZmZlcl9mdW5jcy0+Y29weV9udW1fZHcsIDgpOworCW51bV9ieXRlcyA9IG51bV9wYWdlcyAq
IDg7CisKKwlyID0gYW1kZ3B1X2pvYl9hbGxvY193aXRoX2liKGFkZXYsIG51bV9kdyAqIDQgKyBu
dW1fYnl0ZXMsICZqb2IpOworCWlmIChyKQorCQlyZXR1cm4gcjsKKworCXNyY19hZGRyID0gbnVt
X2R3ICogNDsKKwlzcmNfYWRkciArPSBqb2ItPmlic1swXS5ncHVfYWRkcjsKKworCWRzdF9hZGRy
ID0gYW1kZ3B1X2JvX2dwdV9vZmZzZXQoYWRldi0+Z2FydC5ibyk7CisJZHN0X2FkZHIgKz0gd2lu
ZG93ICogQU1ER1BVX0dUVF9NQVhfVFJBTlNGRVJfU0laRSAqIDg7CisJYW1kZ3B1X2VtaXRfY29w
eV9idWZmZXIoYWRldiwgJmpvYi0+aWJzWzBdLCBzcmNfYWRkciwKKwkJCQlkc3RfYWRkciwgbnVt
X2J5dGVzLCBmYWxzZSk7CisKKwlhbWRncHVfcmluZ19wYWRfaWIocmluZywgJmpvYi0+aWJzWzBd
KTsKKwlXQVJOX09OKGpvYi0+aWJzWzBdLmxlbmd0aF9kdyA+IG51bV9kdyk7CisKKwlkbWFfYWRk
cmVzcyA9ICZkbWEtPmRtYV9hZGRyZXNzW29mZnNldCA+PiBQQUdFX1NISUZUXTsKKwlmbGFncyA9
IGFtZGdwdV90dG1fdHRfcHRlX2ZsYWdzKGFkZXYsIGJvLT50dG0sIG1lbSk7CisJaWYgKHRteikK
KwkJZmxhZ3MgfD0gQU1ER1BVX1BURV9UTVo7CisKKwlyID0gYW1kZ3B1X2dhcnRfbWFwKGFkZXYs
IDAsIG51bV9wYWdlcywgZG1hX2FkZHJlc3MsIGZsYWdzLAorCQkJICAgICZqb2ItPmlic1swXS5w
dHJbbnVtX2R3XSk7CisJaWYgKHIpCisJCWdvdG8gZXJyb3JfZnJlZTsKKworCXIgPSBhbWRncHVf
am9iX3N1Ym1pdChqb2IsICZhZGV2LT5tbWFuLmVudGl0eSwKKwkJCSAgICAgIEFNREdQVV9GRU5D
RV9PV05FUl9VTkRFRklORUQsICZmZW5jZSk7CisJaWYgKHIpCisJCWdvdG8gZXJyb3JfZnJlZTsK
KworCWRtYV9mZW5jZV9wdXQoZmVuY2UpOworCisJcmV0dXJuIHI7CisKK2Vycm9yX2ZyZWU6CisJ
YW1kZ3B1X2pvYl9mcmVlKGpvYik7CisJcmV0dXJuIHI7Cit9CisKIC8qKgogICogYW1kZ3B1X2Nv
cHlfdHRtX21lbV90b19tZW0gLSBIZWxwZXIgZnVuY3Rpb24gZm9yIGNvcHkKICAqIEBhZGV2OiBh
bWRncHUgZGV2aWNlCkBAIC0zMTUsMTQgKzM5NSwxNCBAQCBpbnQgYW1kZ3B1X3R0bV9jb3B5X21l
bV90b19tZW0oc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYsCiAJCQkgICAgICAgc3RydWN0IGRt
YV9yZXN2ICpyZXN2LAogCQkJICAgICAgIHN0cnVjdCBkbWFfZmVuY2UgKipmKQogeworCWNvbnN0
IHVpbnQzMl90IEdUVF9NQVhfQllURVMgPSAoQU1ER1BVX0dUVF9NQVhfVFJBTlNGRVJfU0laRSAq
CisJCQkJCUFNREdQVV9HUFVfUEFHRV9TSVpFKTsKKwogCXN0cnVjdCBhbWRncHVfcmluZyAqcmlu
ZyA9IGFkZXYtPm1tYW4uYnVmZmVyX2Z1bmNzX3Jpbmc7CisJdWludDY0X3Qgc3JjX25vZGVfc2l6
ZSwgZHN0X25vZGVfc2l6ZTsKIAlzdHJ1Y3QgZHJtX21tX25vZGUgKnNyY19tbSwgKmRzdF9tbTsK
LQl1aW50NjRfdCBzcmNfbm9kZV9zdGFydCwgZHN0X25vZGVfc3RhcnQsIHNyY19ub2RlX3NpemUs
Ci0JCSBkc3Rfbm9kZV9zaXplLCBzcmNfcGFnZV9vZmZzZXQsIGRzdF9wYWdlX29mZnNldDsKIAlz
dHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZSA9IE5VTEw7CiAJaW50IHIgPSAwOwotCWNvbnN0IHVpbnQ2
NF90IEdUVF9NQVhfQllURVMgPSAoQU1ER1BVX0dUVF9NQVhfVFJBTlNGRVJfU0laRSAqCi0JCQkJ
CUFNREdQVV9HUFVfUEFHRV9TSVpFKTsKIAogCWlmICghYWRldi0+bW1hbi5idWZmZXJfZnVuY3Nf
ZW5hYmxlZCkgewogCQlEUk1fRVJST1IoIlRyeWluZyB0byBtb3ZlIG1lbW9yeSB3aXRoIHJpbmcg
dHVybmVkIG9mZi5cbiIpOwpAQCAtMzMwLDU4ICs0MTAsMzkgQEAgaW50IGFtZGdwdV90dG1fY29w
eV9tZW1fdG9fbWVtKHN0cnVjdCBhbWRncHVfZGV2aWNlICphZGV2LAogCX0KIAogCXNyY19tbSA9
IGFtZGdwdV9maW5kX21tX25vZGUoc3JjLT5tZW0sICZzcmMtPm9mZnNldCk7Ci0Jc3JjX25vZGVf
c3RhcnQgPSBhbWRncHVfbW1fbm9kZV9hZGRyKHNyYy0+Ym8sIHNyY19tbSwgc3JjLT5tZW0pICsK
LQkJCQkJICAgICBzcmMtPm9mZnNldDsKIAlzcmNfbm9kZV9zaXplID0gKHNyY19tbS0+c2l6ZSA8
PCBQQUdFX1NISUZUKSAtIHNyYy0+b2Zmc2V0OwotCXNyY19wYWdlX29mZnNldCA9IHNyY19ub2Rl
X3N0YXJ0ICYgKFBBR0VfU0laRSAtIDEpOwogCiAJZHN0X21tID0gYW1kZ3B1X2ZpbmRfbW1fbm9k
ZShkc3QtPm1lbSwgJmRzdC0+b2Zmc2V0KTsKLQlkc3Rfbm9kZV9zdGFydCA9IGFtZGdwdV9tbV9u
b2RlX2FkZHIoZHN0LT5ibywgZHN0X21tLCBkc3QtPm1lbSkgKwotCQkJCQkgICAgIGRzdC0+b2Zm
c2V0OwogCWRzdF9ub2RlX3NpemUgPSAoZHN0X21tLT5zaXplIDw8IFBBR0VfU0hJRlQpIC0gZHN0
LT5vZmZzZXQ7Ci0JZHN0X3BhZ2Vfb2Zmc2V0ID0gZHN0X25vZGVfc3RhcnQgJiAoUEFHRV9TSVpF
IC0gMSk7CiAKIAltdXRleF9sb2NrKCZhZGV2LT5tbWFuLmd0dF93aW5kb3dfbG9jayk7CiAKIAl3
aGlsZSAoc2l6ZSkgewotCQl1bnNpZ25lZCBsb25nIGN1cl9zaXplOwotCQl1aW50NjRfdCBmcm9t
ID0gc3JjX25vZGVfc3RhcnQsIHRvID0gZHN0X25vZGVfc3RhcnQ7CisJCXVpbnQzMl90IHNyY19w
YWdlX29mZnNldCA9IHNyYy0+b2Zmc2V0ICYgflBBR0VfTUFTSzsKKwkJdWludDMyX3QgZHN0X3Bh
Z2Vfb2Zmc2V0ID0gZHN0LT5vZmZzZXQgJiB+UEFHRV9NQVNLOwogCQlzdHJ1Y3QgZG1hX2ZlbmNl
ICpuZXh0OworCQl1aW50MzJfdCBjdXJfc2l6ZTsKKwkJdWludDY0X3QgZnJvbSwgdG87CiAKIAkJ
LyogQ29weSBzaXplIGNhbm5vdCBleGNlZWQgR1RUX01BWF9CWVRFUy4gU28gaWYgc3JjIG9yIGRz
dAogCQkgKiBiZWdpbnMgYXQgYW4gb2Zmc2V0LCB0aGVuIGFkanVzdCB0aGUgc2l6ZSBhY2NvcmRp
bmdseQogCQkgKi8KLQkJY3VyX3NpemUgPSBtaW4zKG1pbihzcmNfbm9kZV9zaXplLCBkc3Rfbm9k
ZV9zaXplKSwgc2l6ZSwKLQkJCQlHVFRfTUFYX0JZVEVTKTsKLQkJaWYgKGN1cl9zaXplICsgc3Jj
X3BhZ2Vfb2Zmc2V0ID4gR1RUX01BWF9CWVRFUyB8fAotCQkgICAgY3VyX3NpemUgKyBkc3RfcGFn
ZV9vZmZzZXQgPiBHVFRfTUFYX0JZVEVTKQotCQkJY3VyX3NpemUgLT0gbWF4KHNyY19wYWdlX29m
ZnNldCwgZHN0X3BhZ2Vfb2Zmc2V0KTsKLQotCQkvKiBNYXAgb25seSB3aGF0IG5lZWRzIHRvIGJl
IGFjY2Vzc2VkLiBNYXAgc3JjIHRvIHdpbmRvdyAwIGFuZAotCQkgKiBkc3QgdG8gd2luZG93IDEK
LQkJICovCi0JCWlmIChzcmMtPm1lbS0+c3RhcnQgPT0gQU1ER1BVX0JPX0lOVkFMSURfT0ZGU0VU
KSB7Ci0JCQlyID0gYW1kZ3B1X21hcF9idWZmZXIoc3JjLT5ibywgc3JjLT5tZW0sCi0JCQkJCVBG
Tl9VUChjdXJfc2l6ZSArIHNyY19wYWdlX29mZnNldCksCi0JCQkJCXNyY19ub2RlX3N0YXJ0LCAw
LCByaW5nLCB0bXosCi0JCQkJCSZmcm9tKTsKLQkJCWlmIChyKQotCQkJCWdvdG8gZXJyb3I7Ci0J
CQkvKiBBZGp1c3QgdGhlIG9mZnNldCBiZWNhdXNlIGFtZGdwdV9tYXBfYnVmZmVyIHJldHVybnMK
LQkJCSAqIHN0YXJ0IG9mIG1hcHBlZCBwYWdlCi0JCQkgKi8KLQkJCWZyb20gKz0gc3JjX3BhZ2Vf
b2Zmc2V0OwotCQl9CisJCWN1cl9zaXplID0gbWluMyhzcmNfbm9kZV9zaXplLCBkc3Rfbm9kZV9z
aXplLCBzaXplKTsKKwkJY3VyX3NpemUgPSBtaW4oR1RUX01BWF9CWVRFUyAtIHNyY19wYWdlX29m
ZnNldCwgY3VyX3NpemUpOworCQljdXJfc2l6ZSA9IG1pbihHVFRfTUFYX0JZVEVTIC0gZHN0X3Bh
Z2Vfb2Zmc2V0LCBjdXJfc2l6ZSk7CisKKwkJLyogTWFwIHNyYyB0byB3aW5kb3cgMCBhbmQgZHN0
IHRvIHdpbmRvdyAxLiAqLworCQlyID0gYW1kZ3B1X3R0bV9tYXBfYnVmZmVyKHNyYy0+Ym8sIHNy
Yy0+bWVtLCBzcmNfbW0sCisJCQkJCSAgUEZOX1VQKGN1cl9zaXplICsgc3JjX3BhZ2Vfb2Zmc2V0
KSwKKwkJCQkJICBzcmMtPm9mZnNldCwgMCwgcmluZywgdG16LCAmZnJvbSk7CisJCWlmIChyKQor
CQkJZ290byBlcnJvcjsKIAotCQlpZiAoZHN0LT5tZW0tPnN0YXJ0ID09IEFNREdQVV9CT19JTlZB
TElEX09GRlNFVCkgewotCQkJciA9IGFtZGdwdV9tYXBfYnVmZmVyKGRzdC0+Ym8sIGRzdC0+bWVt
LAotCQkJCQlQRk5fVVAoY3VyX3NpemUgKyBkc3RfcGFnZV9vZmZzZXQpLAotCQkJCQlkc3Rfbm9k
ZV9zdGFydCwgMSwgcmluZywgdG16LAotCQkJCQkmdG8pOwotCQkJaWYgKHIpCi0JCQkJZ290byBl
cnJvcjsKLQkJCXRvICs9IGRzdF9wYWdlX29mZnNldDsKLQkJfQorCQlyID0gYW1kZ3B1X3R0bV9t
YXBfYnVmZmVyKGRzdC0+Ym8sIGRzdC0+bWVtLCBkc3RfbW0sCisJCQkJCSAgUEZOX1VQKGN1cl9z
aXplICsgZHN0X3BhZ2Vfb2Zmc2V0KSwKKwkJCQkJICBkc3QtPm9mZnNldCwgMSwgcmluZywgdG16
LCAmdG8pOworCQlpZiAocikKKwkJCWdvdG8gZXJyb3I7CiAKIAkJciA9IGFtZGdwdV9jb3B5X2J1
ZmZlcihyaW5nLCBmcm9tLCB0bywgY3VyX3NpemUsCiAJCQkJICAgICAgIHJlc3YsICZuZXh0LCBm
YWxzZSwgdHJ1ZSwgdG16KTsKQEAgLTM5NywyMyArNDU4LDIwIEBAIGludCBhbWRncHVfdHRtX2Nv
cHlfbWVtX3RvX21lbShzdHJ1Y3QgYW1kZ3B1X2RldmljZSAqYWRldiwKIAogCQlzcmNfbm9kZV9z
aXplIC09IGN1cl9zaXplOwogCQlpZiAoIXNyY19ub2RlX3NpemUpIHsKLQkJCXNyY19ub2RlX3N0
YXJ0ID0gYW1kZ3B1X21tX25vZGVfYWRkcihzcmMtPmJvLCArK3NyY19tbSwKLQkJCQkJCQkgICAg
IHNyYy0+bWVtKTsKLQkJCXNyY19ub2RlX3NpemUgPSAoc3JjX21tLT5zaXplIDw8IFBBR0VfU0hJ
RlQpOwotCQkJc3JjX3BhZ2Vfb2Zmc2V0ID0gMDsKKwkJCSsrc3JjX21tOworCQkJc3JjX25vZGVf
c2l6ZSA9IHNyY19tbS0+c2l6ZSA8PCBQQUdFX1NISUZUOworCQkJc3JjLT5vZmZzZXQgPSAwOwog
CQl9IGVsc2UgewotCQkJc3JjX25vZGVfc3RhcnQgKz0gY3VyX3NpemU7Ci0JCQlzcmNfcGFnZV9v
ZmZzZXQgPSBzcmNfbm9kZV9zdGFydCAmIChQQUdFX1NJWkUgLSAxKTsKKwkJCXNyYy0+b2Zmc2V0
ICs9IGN1cl9zaXplOwogCQl9CisKIAkJZHN0X25vZGVfc2l6ZSAtPSBjdXJfc2l6ZTsKIAkJaWYg
KCFkc3Rfbm9kZV9zaXplKSB7Ci0JCQlkc3Rfbm9kZV9zdGFydCA9IGFtZGdwdV9tbV9ub2RlX2Fk
ZHIoZHN0LT5ibywgKytkc3RfbW0sCi0JCQkJCQkJICAgICBkc3QtPm1lbSk7Ci0JCQlkc3Rfbm9k
ZV9zaXplID0gKGRzdF9tbS0+c2l6ZSA8PCBQQUdFX1NISUZUKTsKLQkJCWRzdF9wYWdlX29mZnNl
dCA9IDA7CisJCQkrK2RzdF9tbTsKKwkJCWRzdF9ub2RlX3NpemUgPSBkc3RfbW0tPnNpemUgPDwg
UEFHRV9TSElGVDsKKwkJCWRzdC0+b2Zmc2V0ID0gMDsKIAkJfSBlbHNlIHsKLQkJCWRzdF9ub2Rl
X3N0YXJ0ICs9IGN1cl9zaXplOwotCQkJZHN0X3BhZ2Vfb2Zmc2V0ID0gZHN0X25vZGVfc3RhcnQg
JiAoUEFHRV9TSVpFIC0gMSk7CisJCQlkc3QtPm9mZnNldCArPSBjdXJfc2l6ZTsKIAkJfQogCX0K
IGVycm9yOgpAQCAtMjAzMyw3MiArMjA5MSw2IEBAIGludCBhbWRncHVfbW1hcChzdHJ1Y3QgZmls
ZSAqZmlscCwgc3RydWN0IHZtX2FyZWFfc3RydWN0ICp2bWEpCiAJcmV0dXJuIHR0bV9ib19tbWFw
KGZpbHAsIHZtYSwgJmFkZXYtPm1tYW4uYmRldik7CiB9CiAKLXN0YXRpYyBpbnQgYW1kZ3B1X21h
cF9idWZmZXIoc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibywKLQkJCSAgICAgc3RydWN0IHR0
bV9tZW1fcmVnICptZW0sIHVuc2lnbmVkIG51bV9wYWdlcywKLQkJCSAgICAgdWludDY0X3Qgb2Zm
c2V0LCB1bnNpZ25lZCB3aW5kb3csCi0JCQkgICAgIHN0cnVjdCBhbWRncHVfcmluZyAqcmluZywg
Ym9vbCB0bXosCi0JCQkgICAgIHVpbnQ2NF90ICphZGRyKQotewotCXN0cnVjdCBhbWRncHVfdHRt
X3R0ICpndHQgPSAodm9pZCAqKWJvLT50dG07Ci0Jc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYg
PSByaW5nLT5hZGV2OwotCXN0cnVjdCB0dG1fdHQgKnR0bSA9IGJvLT50dG07Ci0Jc3RydWN0IGFt
ZGdwdV9qb2IgKmpvYjsKLQl1bnNpZ25lZCBudW1fZHcsIG51bV9ieXRlczsKLQlkbWFfYWRkcl90
ICpkbWFfYWRkcmVzczsKLQlzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZTsKLQl1aW50NjRfdCBzcmNf
YWRkciwgZHN0X2FkZHI7Ci0JdWludDY0X3QgZmxhZ3M7Ci0JaW50IHI7Ci0KLQlCVUdfT04oYWRl
di0+bW1hbi5idWZmZXJfZnVuY3MtPmNvcHlfbWF4X2J5dGVzIDwKLQkgICAgICAgQU1ER1BVX0dU
VF9NQVhfVFJBTlNGRVJfU0laRSAqIDgpOwotCi0JKmFkZHIgPSBhZGV2LT5nbWMuZ2FydF9zdGFy
dDsKLQkqYWRkciArPSAodTY0KXdpbmRvdyAqIEFNREdQVV9HVFRfTUFYX1RSQU5TRkVSX1NJWkUg
KgotCQlBTURHUFVfR1BVX1BBR0VfU0laRTsKLQotCW51bV9kdyA9IEFMSUdOKGFkZXYtPm1tYW4u
YnVmZmVyX2Z1bmNzLT5jb3B5X251bV9kdywgOCk7Ci0JbnVtX2J5dGVzID0gbnVtX3BhZ2VzICog
ODsKLQotCXIgPSBhbWRncHVfam9iX2FsbG9jX3dpdGhfaWIoYWRldiwgbnVtX2R3ICogNCArIG51
bV9ieXRlcywgJmpvYik7Ci0JaWYgKHIpCi0JCXJldHVybiByOwotCi0Jc3JjX2FkZHIgPSBudW1f
ZHcgKiA0OwotCXNyY19hZGRyICs9IGpvYi0+aWJzWzBdLmdwdV9hZGRyOwotCi0JZHN0X2FkZHIg
PSBhbWRncHVfYm9fZ3B1X29mZnNldChhZGV2LT5nYXJ0LmJvKTsKLQlkc3RfYWRkciArPSB3aW5k
b3cgKiBBTURHUFVfR1RUX01BWF9UUkFOU0ZFUl9TSVpFICogODsKLQlhbWRncHVfZW1pdF9jb3B5
X2J1ZmZlcihhZGV2LCAmam9iLT5pYnNbMF0sIHNyY19hZGRyLAotCQkJCWRzdF9hZGRyLCBudW1f
Ynl0ZXMsIGZhbHNlKTsKLQotCWFtZGdwdV9yaW5nX3BhZF9pYihyaW5nLCAmam9iLT5pYnNbMF0p
OwotCVdBUk5fT04oam9iLT5pYnNbMF0ubGVuZ3RoX2R3ID4gbnVtX2R3KTsKLQotCWRtYV9hZGRy
ZXNzID0gJmd0dC0+dHRtLmRtYV9hZGRyZXNzW29mZnNldCA+PiBQQUdFX1NISUZUXTsKLQlmbGFn
cyA9IGFtZGdwdV90dG1fdHRfcHRlX2ZsYWdzKGFkZXYsIHR0bSwgbWVtKTsKLQlpZiAodG16KQot
CQlmbGFncyB8PSBBTURHUFVfUFRFX1RNWjsKLQotCXIgPSBhbWRncHVfZ2FydF9tYXAoYWRldiwg
MCwgbnVtX3BhZ2VzLCBkbWFfYWRkcmVzcywgZmxhZ3MsCi0JCQkgICAgJmpvYi0+aWJzWzBdLnB0
cltudW1fZHddKTsKLQlpZiAocikKLQkJZ290byBlcnJvcl9mcmVlOwotCi0JciA9IGFtZGdwdV9q
b2Jfc3VibWl0KGpvYiwgJmFkZXYtPm1tYW4uZW50aXR5LAotCQkJICAgICAgQU1ER1BVX0ZFTkNF
X09XTkVSX1VOREVGSU5FRCwgJmZlbmNlKTsKLQlpZiAocikKLQkJZ290byBlcnJvcl9mcmVlOwot
Ci0JZG1hX2ZlbmNlX3B1dChmZW5jZSk7Ci0KLQlyZXR1cm4gcjsKLQotZXJyb3JfZnJlZToKLQlh
bWRncHVfam9iX2ZyZWUoam9iKTsKLQlyZXR1cm4gcjsKLX0KLQogaW50IGFtZGdwdV9jb3B5X2J1
ZmZlcihzdHJ1Y3QgYW1kZ3B1X3JpbmcgKnJpbmcsIHVpbnQ2NF90IHNyY19vZmZzZXQsCiAJCSAg
ICAgICB1aW50NjRfdCBkc3Rfb2Zmc2V0LCB1aW50MzJfdCBieXRlX2NvdW50LAogCQkgICAgICAg
c3RydWN0IGRtYV9yZXN2ICpyZXN2LAotLSAKMi4xNy4xCgpfX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fXwphbWQtZ2Z4IG1haWxpbmcgbGlzdAphbWQtZ2Z4QGxp
c3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFu
L2xpc3RpbmZvL2FtZC1nZngK
