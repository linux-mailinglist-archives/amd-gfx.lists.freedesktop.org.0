Return-Path: <amd-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+amd-gfx@lfdr.de
Delivered-To: lists+amd-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 85CEF131458
	for <lists+amd-gfx@lfdr.de>; Mon,  6 Jan 2020 16:03:51 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 689496E48B;
	Mon,  6 Jan 2020 15:03:49 +0000 (UTC)
X-Original-To: amd-gfx@lists.freedesktop.org
Delivered-To: amd-gfx@lists.freedesktop.org
Received: from mail-wr1-x443.google.com (mail-wr1-x443.google.com
 [IPv6:2a00:1450:4864:20::443])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 9554C6E487
 for <amd-gfx@lists.freedesktop.org>; Mon,  6 Jan 2020 15:03:47 +0000 (UTC)
Received: by mail-wr1-x443.google.com with SMTP id c14so49944083wrn.7
 for <amd-gfx@lists.freedesktop.org>; Mon, 06 Jan 2020 07:03:47 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20161025;
 h=from:to:subject:date:message-id:in-reply-to:references:mime-version
 :content-transfer-encoding;
 bh=tdVCzKKweNLUPGCSdyyMB+kJb3VYfVOo0y52tsKNsKI=;
 b=jRDJ2h/sc6j6GNG73rxQKOBiT91Vr6y9h+VyE+59NSI8FCo19++yTde95VOu65/0tJ
 IbYMqcMr8yfZED9f4woKtzgd92T484UfWs7x8o+N9aSNoqU/AbG4a+JvzdkpPc40bWG2
 I49abDXa8JnJSbCHBcsTGekWCY/Lo8Fgx20ywO7SwylA4hE1QVQcCr6bfAm1kfZ4cfeG
 zSOR6UJ3eE8z59I3/i7NyhLQ86wiZvHFskum1hjFDBMb0Wm9r5610+p2b+TXnXsU2VSJ
 cW3GSGVUTn+w4ZQ3H9wNaubw5iJDLpr3YtjBgFHEV98gAtGr8R+jtq1+JiBevCBqRGjT
 EwAg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=tdVCzKKweNLUPGCSdyyMB+kJb3VYfVOo0y52tsKNsKI=;
 b=XRM6a7bXeqDcYWE+SivmUwUIfbRdzbbYOKpIrNVTlML6TBLEahFlurEZiSHKNSqfsX
 mFfAXbRIp3on6Cor/uVC0IhPTaIqjMsP1FhqVS6HvqYIKFAcKlD12X+4KFn1utv+MgbM
 OdRY9ajnFe9m8Cin7EL04+0dcRaxARPKldXvQm1uKgPz3TQ3+5i7ks0ZUWQYKEL+B9GL
 nAY/GHoAs5ZaGETC/pg7y9pWNMPWp1WFhIYJeE/enmQomHNY3esraT4i/mfoT/LwG7Fn
 7k3US0H9yxf9CvaFuzS9egjXhCl9hnFvmgHzrridmIsDtEgn6QPq+zYlEqKlKy4VKu4A
 dH7g==
X-Gm-Message-State: APjAAAXJu/EPxFvJVW0KFHedd0EqTG6siha2/jAEQH8UbCYQi+SeHtsO
 drrCDpTkk39AfnxkvY19eFY=
X-Google-Smtp-Source: APXvYqxHgS+A5DFzj+nz01gXxLRRJAbJoOqWxitqnXQuUp0L0VHvuIandMKxmBMIsiVa/Sxo4G1Yow==
X-Received: by 2002:a05:6000:149:: with SMTP id
 r9mr95002853wrx.147.1578323026199; 
 Mon, 06 Jan 2020 07:03:46 -0800 (PST)
Received: from abel.fritz.box ([2a02:908:1252:fb60:ece2:ff95:11ee:3e72])
 by smtp.gmail.com with ESMTPSA id b17sm70307444wrp.49.2020.01.06.07.03.45
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Mon, 06 Jan 2020 07:03:45 -0800 (PST)
From: "=?UTF-8?q?Christian=20K=C3=B6nig?=" <ckoenig.leichtzumerken@gmail.com>
X-Google-Original-From: =?UTF-8?q?Christian=20K=C3=B6nig?=
 <christian.koenig@amd.com>
To: Alex.Sierra@amd.com, Philip.Yang@amd.com, Felix.Kuehling@amd.com,
 amd-gfx@lists.freedesktop.org
Subject: [PATCH 08/12] drm/amdgpu: rework synchronization of VM updates
Date: Mon,  6 Jan 2020 16:03:31 +0100
Message-Id: <20200106150335.1738-9-christian.koenig@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20200106150335.1738-1-christian.koenig@amd.com>
References: <20200106150335.1738-1-christian.koenig@amd.com>
MIME-Version: 1.0
X-BeenThere: amd-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Discussion list for AMD gfx <amd-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/amd-gfx>
List-Post: <mailto:amd-gfx@lists.freedesktop.org>
List-Help: <mailto:amd-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: amd-gfx-bounces@lists.freedesktop.org
Sender: "amd-gfx" <amd-gfx-bounces@lists.freedesktop.org>

SWYgcHJvdmlkZWQgd2Ugb25seSBzeW5jIHRvIHRoZSBCT3MgcmVzZXJ2YXRpb24Kb2JqZWN0IGFu
ZCBubyBsb25nZXIgdG8gdGhlIHJvb3QgUEQuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpc3RpYW4gS8O2
bmlnIDxjaHJpc3RpYW4ua29lbmlnQGFtZC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2FtZC9h
bWRncHUvYW1kZ3B1X3N5bmMuYyAgICB8ICA3IC0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vYW1kL2Ft
ZGdwdS9hbWRncHVfdm0uYyAgICAgIHwgMzQgKysrKysrKysrKysrLS0tLS0tLS0tCiBkcml2ZXJz
L2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdm0uaCAgICAgIHwgIDQgKy0tCiBkcml2ZXJzL2dw
dS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdm1fY3B1LmMgIHwgMjUgKysrKysrLS0tLS0tLS0tCiBk
cml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdm1fc2RtYS5jIHwgMTUgKysrLS0tLS0t
CiA1IGZpbGVzIGNoYW5nZWQsIDM1IGluc2VydGlvbnMoKyksIDUwIGRlbGV0aW9ucygtKQoKZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV9zeW5jLmMgYi9kcml2
ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfc3luYy5jCmluZGV4IGMxMjRmNjRlN2FhZS4u
NTgxNmRmOWY4NTMxIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRn
cHVfc3luYy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV9zeW5jLmMK
QEAgLTI0MCwxMyArMjQwLDYgQEAgaW50IGFtZGdwdV9zeW5jX3Jlc3Yoc3RydWN0IGFtZGdwdV9k
ZXZpY2UgKmFkZXYsIHN0cnVjdCBhbWRncHVfc3luYyAqc3luYywKIAkJICAgIG93bmVyICE9IEFN
REdQVV9GRU5DRV9PV05FUl9VTkRFRklORUQpCiAJCQljb250aW51ZTsKIAotCQkvKiBWTSB1cGRh
dGVzIG9ubHkgc3luYyB3aXRoIG1vdmVzIGJ1dCBub3Qgd2l0aCB1c2VyCi0JCSAqIGNvbW1hbmQg
c3VibWlzc2lvbnMgb3IgS0ZEIGV2aWN0aW9ucyBmZW5jZXMKLQkJICovCi0JCWlmIChmZW5jZV9v
d25lciAhPSBBTURHUFVfRkVOQ0VfT1dORVJfVU5ERUZJTkVEICYmCi0JCSAgICBvd25lciA9PSBB
TURHUFVfRkVOQ0VfT1dORVJfVk0pCi0JCQljb250aW51ZTsKLQogCQkvKiBJZ25vcmUgZmVuY2Vz
IGRlcGVuZGluZyBvbiB0aGUgc3luYyBtb2RlICovCiAJCXN3aXRjaCAobW9kZSkgewogCQljYXNl
IEFNREdQVV9TWU5DX0FMV0FZUzoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1k
Z3B1L2FtZGdwdV92bS5jIGIvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X3ZtLmMK
aW5kZXggNTQ0MzBjOWY3YTI3Li5hMDNjZmJlNjcwYzQgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1
L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV92bS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1k
Z3B1L2FtZGdwdV92bS5jCkBAIC03NzcsNyArNzc3LDcgQEAgc3RhdGljIGludCBhbWRncHVfdm1f
Y2xlYXJfYm8oc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYsCiAJcGFyYW1zLnZtID0gdm07CiAJ
cGFyYW1zLmRpcmVjdCA9IGRpcmVjdDsKIAotCXIgPSB2bS0+dXBkYXRlX2Z1bmNzLT5wcmVwYXJl
KCZwYXJhbXMsIEFNREdQVV9GRU5DRV9PV05FUl9LRkQsIE5VTEwpOworCXIgPSB2bS0+dXBkYXRl
X2Z1bmNzLT5wcmVwYXJlKCZwYXJhbXMsIE5VTEwsIEFNREdQVV9TWU5DX0VYUExJQ0lUKTsKIAlp
ZiAocikKIAkJcmV0dXJuIHI7CiAKQEAgLTEyNzMsNyArMTI3Myw3IEBAIGludCBhbWRncHVfdm1f
dXBkYXRlX3BkZXMoc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYsCiAJcGFyYW1zLnZtID0gdm07
CiAJcGFyYW1zLmRpcmVjdCA9IGRpcmVjdDsKIAotCXIgPSB2bS0+dXBkYXRlX2Z1bmNzLT5wcmVw
YXJlKCZwYXJhbXMsIEFNREdQVV9GRU5DRV9PV05FUl9WTSwgTlVMTCk7CisJciA9IHZtLT51cGRh
dGVfZnVuY3MtPnByZXBhcmUoJnBhcmFtcywgTlVMTCwgQU1ER1BVX1NZTkNfRVhQTElDSVQpOwog
CWlmIChyKQogCQlyZXR1cm4gcjsKIApAQCAtMTUyNCw3ICsxNTI0LDcgQEAgc3RhdGljIGludCBh
bWRncHVfdm1fdXBkYXRlX3B0ZXMoc3RydWN0IGFtZGdwdV92bV91cGRhdGVfcGFyYW1zICpwYXJh
bXMsCiAgKiBAYWRldjogYW1kZ3B1X2RldmljZSBwb2ludGVyCiAgKiBAdm06IHJlcXVlc3RlZCB2
bQogICogQGRpcmVjdDogZGlyZWN0IHN1Ym1pc3Npb24gaW4gYSBwYWdlIGZhdWx0Ci0gKiBAZXhj
bHVzaXZlOiBmZW5jZSB3ZSBuZWVkIHRvIHN5bmMgdG8KKyAqIEByZXN2OiBmZW5jZXMgd2UgbmVl
ZCB0byBzeW5jIHRvCiAgKiBAc3RhcnQ6IHN0YXJ0IG9mIG1hcHBlZCByYW5nZQogICogQGxhc3Q6
IGxhc3QgbWFwcGVkIGVudHJ5CiAgKiBAZmxhZ3M6IGZsYWdzIGZvciB0aGUgZW50cmllcwpAQCAt
MTUzOSwxNCArMTUzOSwxNCBAQCBzdGF0aWMgaW50IGFtZGdwdV92bV91cGRhdGVfcHRlcyhzdHJ1
Y3QgYW1kZ3B1X3ZtX3VwZGF0ZV9wYXJhbXMgKnBhcmFtcywKICAqLwogc3RhdGljIGludCBhbWRn
cHVfdm1fYm9fdXBkYXRlX21hcHBpbmcoc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYsCiAJCQkJ
ICAgICAgIHN0cnVjdCBhbWRncHVfdm0gKnZtLCBib29sIGRpcmVjdCwKLQkJCQkgICAgICAgc3Ry
dWN0IGRtYV9mZW5jZSAqZXhjbHVzaXZlLAorCQkJCSAgICAgICBzdHJ1Y3QgZG1hX3Jlc3YgKnJl
c3YsCiAJCQkJICAgICAgIHVpbnQ2NF90IHN0YXJ0LCB1aW50NjRfdCBsYXN0LAogCQkJCSAgICAg
ICB1aW50NjRfdCBmbGFncywgdWludDY0X3QgYWRkciwKIAkJCQkgICAgICAgZG1hX2FkZHJfdCAq
cGFnZXNfYWRkciwKIAkJCQkgICAgICAgc3RydWN0IGRtYV9mZW5jZSAqKmZlbmNlKQogewogCXN0
cnVjdCBhbWRncHVfdm1fdXBkYXRlX3BhcmFtcyBwYXJhbXM7Ci0Jdm9pZCAqb3duZXIgPSBBTURH
UFVfRkVOQ0VfT1dORVJfVk07CisJZW51bSBhbWRncHVfc3luY19tb2RlIHN5bmNfbW9kZTsKIAlp
bnQgcjsKIAogCW1lbXNldCgmcGFyYW1zLCAwLCBzaXplb2YocGFyYW1zKSk7CkBAIC0xNTU3LDcg
KzE1NTcsOSBAQCBzdGF0aWMgaW50IGFtZGdwdV92bV9ib191cGRhdGVfbWFwcGluZyhzdHJ1Y3Qg
YW1kZ3B1X2RldmljZSAqYWRldiwKIAogCS8qIHN5bmMgdG8gZXZlcnl0aGluZyBleGNlcHQgZXZp
Y3Rpb24gZmVuY2VzIG9uIHVubWFwcGluZyAqLwogCWlmICghKGZsYWdzICYgQU1ER1BVX1BURV9W
QUxJRCkpCi0JCW93bmVyID0gQU1ER1BVX0ZFTkNFX09XTkVSX0tGRDsKKwkJc3luY19tb2RlID0g
QU1ER1BVX1NZTkNfRVFfT1dORVI7CisJZWxzZQorCQlzeW5jX21vZGUgPSBBTURHUFVfU1lOQ19F
WFBMSUNJVDsKIAogCW11dGV4X2xvY2soJnZtLT5ldmljdGlvbl9sb2NrKTsKIAlpZiAodm0tPmV2
aWN0aW5nKSB7CkBAIC0xNTY1LDcgKzE1NjcsNyBAQCBzdGF0aWMgaW50IGFtZGdwdV92bV9ib191
cGRhdGVfbWFwcGluZyhzdHJ1Y3QgYW1kZ3B1X2RldmljZSAqYWRldiwKIAkJZ290byBlcnJvcl91
bmxvY2s7CiAJfQogCi0JciA9IHZtLT51cGRhdGVfZnVuY3MtPnByZXBhcmUoJnBhcmFtcywgb3du
ZXIsIGV4Y2x1c2l2ZSk7CisJciA9IHZtLT51cGRhdGVfZnVuY3MtPnByZXBhcmUoJnBhcmFtcywg
cmVzdiwgc3luY19tb2RlKTsKIAlpZiAocikKIAkJZ290byBlcnJvcl91bmxvY2s7CiAKQEAgLTE1
ODQsNyArMTU4Niw3IEBAIHN0YXRpYyBpbnQgYW1kZ3B1X3ZtX2JvX3VwZGF0ZV9tYXBwaW5nKHN0
cnVjdCBhbWRncHVfZGV2aWNlICphZGV2LAogICogYW1kZ3B1X3ZtX2JvX3NwbGl0X21hcHBpbmcg
LSBzcGxpdCBhIG1hcHBpbmcgaW50byBzbWFsbGVyIGNodW5rcwogICoKICAqIEBhZGV2OiBhbWRn
cHVfZGV2aWNlIHBvaW50ZXIKLSAqIEBleGNsdXNpdmU6IGZlbmNlIHdlIG5lZWQgdG8gc3luYyB0
bworICogQHJlc3Y6IGZlbmNlcyB3ZSBuZWVkIHRvIHN5bmMgdG8KICAqIEBwYWdlc19hZGRyOiBE
TUEgYWRkcmVzc2VzIHRvIHVzZSBmb3IgbWFwcGluZwogICogQHZtOiByZXF1ZXN0ZWQgdm0KICAq
IEBtYXBwaW5nOiBtYXBwZWQgcmFuZ2UgYW5kIGZsYWdzIHRvIHVzZSBmb3IgdGhlIHVwZGF0ZQpA
QCAtMTYwMCw3ICsxNjAyLDcgQEAgc3RhdGljIGludCBhbWRncHVfdm1fYm9fdXBkYXRlX21hcHBp
bmcoc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYsCiAgKiAwIGZvciBzdWNjZXNzLCAtRUlOVkFM
IGZvciBmYWlsdXJlLgogICovCiBzdGF0aWMgaW50IGFtZGdwdV92bV9ib19zcGxpdF9tYXBwaW5n
KHN0cnVjdCBhbWRncHVfZGV2aWNlICphZGV2LAotCQkJCSAgICAgIHN0cnVjdCBkbWFfZmVuY2Ug
KmV4Y2x1c2l2ZSwKKwkJCQkgICAgICBzdHJ1Y3QgZG1hX3Jlc3YgKnJlc3YsCiAJCQkJICAgICAg
ZG1hX2FkZHJfdCAqcGFnZXNfYWRkciwKIAkJCQkgICAgICBzdHJ1Y3QgYW1kZ3B1X3ZtICp2bSwK
IAkJCQkgICAgICBzdHJ1Y3QgYW1kZ3B1X2JvX3ZhX21hcHBpbmcgKm1hcHBpbmcsCkBAIC0xNjc2
LDcgKzE2NzgsNyBAQCBzdGF0aWMgaW50IGFtZGdwdV92bV9ib19zcGxpdF9tYXBwaW5nKHN0cnVj
dCBhbWRncHVfZGV2aWNlICphZGV2LAogCQl9CiAKIAkJbGFzdCA9IG1pbigodWludDY0X3QpbWFw
cGluZy0+bGFzdCwgc3RhcnQgKyBtYXhfZW50cmllcyAtIDEpOwotCQlyID0gYW1kZ3B1X3ZtX2Jv
X3VwZGF0ZV9tYXBwaW5nKGFkZXYsIHZtLCBmYWxzZSwgZXhjbHVzaXZlLAorCQlyID0gYW1kZ3B1
X3ZtX2JvX3VwZGF0ZV9tYXBwaW5nKGFkZXYsIHZtLCBmYWxzZSwgcmVzdiwKIAkJCQkJCXN0YXJ0
LCBsYXN0LCBmbGFncywgYWRkciwKIAkJCQkJCWRtYV9hZGRyLCBmZW5jZSk7CiAJCWlmIChyKQpA
QCAtMTcxNSw3ICsxNzE3LDggQEAgaW50IGFtZGdwdV92bV9ib191cGRhdGUoc3RydWN0IGFtZGdw
dV9kZXZpY2UgKmFkZXYsIHN0cnVjdCBhbWRncHVfYm9fdmEgKmJvX3ZhLAogCWRtYV9hZGRyX3Qg
KnBhZ2VzX2FkZHIgPSBOVUxMOwogCXN0cnVjdCB0dG1fbWVtX3JlZyAqbWVtOwogCXN0cnVjdCBk
cm1fbW1fbm9kZSAqbm9kZXM7Ci0Jc3RydWN0IGRtYV9mZW5jZSAqZXhjbHVzaXZlLCAqKmxhc3Rf
dXBkYXRlOworCXN0cnVjdCBkbWFfZmVuY2UgKipsYXN0X3VwZGF0ZTsKKwlzdHJ1Y3QgZG1hX3Jl
c3YgKnJlc3Y7CiAJdWludDY0X3QgZmxhZ3M7CiAJc3RydWN0IGFtZGdwdV9kZXZpY2UgKmJvX2Fk
ZXYgPSBhZGV2OwogCWludCByOwpAQCAtMTcyMyw3ICsxNzI2LDYgQEAgaW50IGFtZGdwdV92bV9i
b191cGRhdGUoc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYsIHN0cnVjdCBhbWRncHVfYm9fdmEg
KmJvX3ZhLAogCWlmIChjbGVhciB8fCAhYm8pIHsKIAkJbWVtID0gTlVMTDsKIAkJbm9kZXMgPSBO
VUxMOwotCQlleGNsdXNpdmUgPSBOVUxMOwogCX0gZWxzZSB7CiAJCXN0cnVjdCB0dG1fZG1hX3R0
ICp0dG07CiAKQEAgLTE3MzMsNyArMTczNSw2IEBAIGludCBhbWRncHVfdm1fYm9fdXBkYXRlKHN0
cnVjdCBhbWRncHVfZGV2aWNlICphZGV2LCBzdHJ1Y3QgYW1kZ3B1X2JvX3ZhICpib192YSwKIAkJ
CXR0bSA9IGNvbnRhaW5lcl9vZihiby0+dGJvLnR0bSwgc3RydWN0IHR0bV9kbWFfdHQsIHR0bSk7
CiAJCQlwYWdlc19hZGRyID0gdHRtLT5kbWFfYWRkcmVzczsKIAkJfQotCQlleGNsdXNpdmUgPSBi
by0+dGJvLm1vdmluZzsKIAl9CiAKIAlpZiAoYm8pIHsKQEAgLTE3NDMsMTEgKzE3NDQsMTQgQEAg
aW50IGFtZGdwdV92bV9ib191cGRhdGUoc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYsIHN0cnVj
dCBhbWRncHVfYm9fdmEgKmJvX3ZhLAogCQkJZmxhZ3MgfD0gQU1ER1BVX1BURV9UTVo7CiAKIAkJ
Ym9fYWRldiA9IGFtZGdwdV90dG1fYWRldihiby0+dGJvLmJkZXYpOworCQlyZXN2ID0gYm8tPnRi
by5iYXNlLnJlc3Y7CiAJfSBlbHNlIHsKIAkJZmxhZ3MgPSAweDA7CisJCXJlc3YgPSBOVUxMOwog
CX0KIAotCWlmIChjbGVhciB8fCAoYm8gJiYgYm8tPnRiby5iYXNlLnJlc3YgPT0gdm0tPnJvb3Qu
YmFzZS5iby0+dGJvLmJhc2UucmVzdikpCisJaWYgKGNsZWFyIHx8IChibyAmJiBiby0+dGJvLmJh
c2UucmVzdiA9PQorCQkgICAgICB2bS0+cm9vdC5iYXNlLmJvLT50Ym8uYmFzZS5yZXN2KSkKIAkJ
bGFzdF91cGRhdGUgPSAmdm0tPmxhc3RfdXBkYXRlOwogCWVsc2UKIAkJbGFzdF91cGRhdGUgPSAm
Ym9fdmEtPmxhc3RfcHRfdXBkYXRlOwpAQCAtMTc2MSw3ICsxNzY1LDcgQEAgaW50IGFtZGdwdV92
bV9ib191cGRhdGUoc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYsIHN0cnVjdCBhbWRncHVfYm9f
dmEgKmJvX3ZhLAogCX0KIAogCWxpc3RfZm9yX2VhY2hfZW50cnkobWFwcGluZywgJmJvX3ZhLT5p
bnZhbGlkcywgbGlzdCkgewotCQlyID0gYW1kZ3B1X3ZtX2JvX3NwbGl0X21hcHBpbmcoYWRldiwg
ZXhjbHVzaXZlLCBwYWdlc19hZGRyLCB2bSwKKwkJciA9IGFtZGdwdV92bV9ib19zcGxpdF9tYXBw
aW5nKGFkZXYsIHJlc3YsIHBhZ2VzX2FkZHIsIHZtLAogCQkJCQkgICAgICAgbWFwcGluZywgZmxh
Z3MsIGJvX2FkZXYsIG5vZGVzLAogCQkJCQkgICAgICAgbGFzdF91cGRhdGUpOwogCQlpZiAocikK
ZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV92bS5oIGIvZHJp
dmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X3ZtLmgKaW5kZXggZDU2MTNkMTg0ZTk5Li44
ZmIwOTY0OGJjOTcgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdw
dV92bS5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV92bS5oCkBAIC0y
MjksOCArMjI5LDggQEAgc3RydWN0IGFtZGdwdV92bV91cGRhdGVfcGFyYW1zIHsKIAogc3RydWN0
IGFtZGdwdV92bV91cGRhdGVfZnVuY3MgewogCWludCAoKm1hcF90YWJsZSkoc3RydWN0IGFtZGdw
dV9ibyAqYm8pOwotCWludCAoKnByZXBhcmUpKHN0cnVjdCBhbWRncHVfdm1fdXBkYXRlX3BhcmFt
cyAqcCwgdm9pZCAqIG93bmVyLAotCQkgICAgICAgc3RydWN0IGRtYV9mZW5jZSAqZXhjbHVzaXZl
KTsKKwlpbnQgKCpwcmVwYXJlKShzdHJ1Y3QgYW1kZ3B1X3ZtX3VwZGF0ZV9wYXJhbXMgKnAsIHN0
cnVjdCBkbWFfcmVzdiAqcmVzdiwKKwkJICAgICAgIGVudW0gYW1kZ3B1X3N5bmNfbW9kZSBzeW5j
X21vZGUpOwogCWludCAoKnVwZGF0ZSkoc3RydWN0IGFtZGdwdV92bV91cGRhdGVfcGFyYW1zICpw
LAogCQkgICAgICBzdHJ1Y3QgYW1kZ3B1X2JvICpibywgdWludDY0X3QgcGUsIHVpbnQ2NF90IGFk
ZHIsCiAJCSAgICAgIHVuc2lnbmVkIGNvdW50LCB1aW50MzJfdCBpbmNyLCB1aW50NjRfdCBmbGFn
cyk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdm1fY3B1
LmMgYi9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdm1fY3B1LmMKaW5kZXggNjhi
MDEzYmUzODM3Li4wYmU3MjY2MGRiNGMgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9hbWQv
YW1kZ3B1L2FtZGdwdV92bV9jcHUuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9h
bWRncHVfdm1fY3B1LmMKQEAgLTQ0LDI2ICs0NCwyMSBAQCBzdGF0aWMgaW50IGFtZGdwdV92bV9j
cHVfbWFwX3RhYmxlKHN0cnVjdCBhbWRncHVfYm8gKnRhYmxlKQogICogUmV0dXJuczoKICAqIE5l
Z2F0aXYgZXJybm8sIDAgZm9yIHN1Y2Nlc3MuCiAgKi8KLXN0YXRpYyBpbnQgYW1kZ3B1X3ZtX2Nw
dV9wcmVwYXJlKHN0cnVjdCBhbWRncHVfdm1fdXBkYXRlX3BhcmFtcyAqcCwgdm9pZCAqb3duZXIs
Ci0JCQkJIHN0cnVjdCBkbWFfZmVuY2UgKmV4Y2x1c2l2ZSkKK3N0YXRpYyBpbnQgYW1kZ3B1X3Zt
X2NwdV9wcmVwYXJlKHN0cnVjdCBhbWRncHVfdm1fdXBkYXRlX3BhcmFtcyAqcCwKKwkJCQkgc3Ry
dWN0IGRtYV9yZXN2ICpyZXN2LAorCQkJCSBlbnVtIGFtZGdwdV9zeW5jX21vZGUgc3luY19tb2Rl
KQogeworCXN0cnVjdCBhbWRncHVfc3luYyBzeW5jOwogCWludCByOwogCi0JLyogV2FpdCBmb3Ig
YW55IEJPIG1vdmUgdG8gYmUgY29tcGxldGVkICovCi0JaWYgKGV4Y2x1c2l2ZSkgewotCQlyID0g
ZG1hX2ZlbmNlX3dhaXQoZXhjbHVzaXZlLCB0cnVlKTsKLQkJaWYgKHVubGlrZWx5KHIpKQotCQkJ
cmV0dXJuIHI7Ci0JfQotCi0JLyogRG9uJ3Qgd2FpdCBmb3Igc3VibWlzc2lvbnMgZHVyaW5nIHBh
Z2UgZmF1bHQgKi8KLQlpZiAocC0+ZGlyZWN0KQorCWlmICghcmVzdikKIAkJcmV0dXJuIDA7CiAK
LQkvKiBXYWl0IGZvciBQVCBCT3MgdG8gYmUgaWRsZS4gUFRzIHNoYXJlIHRoZSBzYW1lIHJlc3Yu
IG9iamVjdAotCSAqIGFzIHRoZSByb290IFBEIEJPCi0JICovCi0JcmV0dXJuIGFtZGdwdV9ib19z
eW5jX3dhaXQocC0+dm0tPnJvb3QuYmFzZS5ibywgb3duZXIsIHRydWUpOworCWFtZGdwdV9zeW5j
X2NyZWF0ZSgmc3luYyk7CisJYW1kZ3B1X3N5bmNfcmVzdihwLT5hZGV2LCAmc3luYywgcmVzdiwg
c3luY19tb2RlLCBwLT52bSk7CisJciA9IGFtZGdwdV9zeW5jX3dhaXQoJnN5bmMsIHRydWUpOwor
CWFtZGdwdV9zeW5jX2ZyZWUoJnN5bmMpOworCXJldHVybiByOwogfQogCiAvKioKZGlmZiAtLWdp
dCBhL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV92bV9zZG1hLmMgYi9kcml2ZXJz
L2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdm1fc2RtYS5jCmluZGV4IDNiNjEzMTdjMGYwOC4u
ZTdhMzgzMTM0NTIxIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRn
cHVfdm1fc2RtYS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV92bV9z
ZG1hLmMKQEAgLTU4LDkgKzU4LDkgQEAgc3RhdGljIGludCBhbWRncHVfdm1fc2RtYV9tYXBfdGFi
bGUoc3RydWN0IGFtZGdwdV9ibyAqdGFibGUpCiAgKiBOZWdhdGl2IGVycm5vLCAwIGZvciBzdWNj
ZXNzLgogICovCiBzdGF0aWMgaW50IGFtZGdwdV92bV9zZG1hX3ByZXBhcmUoc3RydWN0IGFtZGdw
dV92bV91cGRhdGVfcGFyYW1zICpwLAotCQkJCSAgdm9pZCAqb3duZXIsIHN0cnVjdCBkbWFfZmVu
Y2UgKmV4Y2x1c2l2ZSkKKwkJCQkgIHN0cnVjdCBkbWFfcmVzdiAqcmVzdiwKKwkJCQkgIGVudW0g
YW1kZ3B1X3N5bmNfbW9kZSBzeW5jX21vZGUpCiB7Ci0Jc3RydWN0IGFtZGdwdV9ibyAqcm9vdCA9
IHAtPnZtLT5yb290LmJhc2UuYm87CiAJdW5zaWduZWQgaW50IG5kdyA9IEFNREdQVV9WTV9TRE1B
X01JTl9OVU1fRFc7CiAJaW50IHI7CiAKQEAgLTcwLDE3ICs3MCwxMCBAQCBzdGF0aWMgaW50IGFt
ZGdwdV92bV9zZG1hX3ByZXBhcmUoc3RydWN0IGFtZGdwdV92bV91cGRhdGVfcGFyYW1zICpwLAog
CiAJcC0+bnVtX2R3X2xlZnQgPSBuZHc7CiAKLQkvKiBXYWl0IGZvciBtb3ZlcyB0byBiZSBjb21w
bGV0ZWQgKi8KLQlyID0gYW1kZ3B1X3N5bmNfZmVuY2UoJnAtPmpvYi0+c3luYywgZXhjbHVzaXZl
LCBmYWxzZSk7Ci0JaWYgKHIpCi0JCXJldHVybiByOwotCi0JLyogRG9uJ3Qgd2FpdCBmb3IgYW55
IHN1Ym1pc3Npb25zIGR1cmluZyBwYWdlIGZhdWx0IGhhbmRsaW5nICovCi0JaWYgKHAtPmRpcmVj
dCkKKwlpZiAoIXJlc3YpCiAJCXJldHVybiAwOwogCi0JcmV0dXJuIGFtZGdwdV9zeW5jX3Jlc3Yo
cC0+YWRldiwgJnAtPmpvYi0+c3luYywgcm9vdC0+dGJvLmJhc2UucmVzdiwKLQkJCQlBTURHUFVf
U1lOQ19ORV9PV05FUiwgb3duZXIpOworCXJldHVybiBhbWRncHVfc3luY19yZXN2KHAtPmFkZXYs
ICZwLT5qb2ItPnN5bmMsIHJlc3YsIHN5bmNfbW9kZSwgcC0+dm0pOwogfQogCiAvKioKLS0gCjIu
MTcuMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KYW1k
LWdmeCBtYWlsaW5nIGxpc3QKYW1kLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9s
aXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9hbWQtZ2Z4Cg==
