Return-Path: <amd-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+amd-gfx@lfdr.de
Delivered-To: lists+amd-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id CF1DF49041
	for <lists+amd-gfx@lfdr.de>; Mon, 17 Jun 2019 21:49:30 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 329646E037;
	Mon, 17 Jun 2019 19:49:29 +0000 (UTC)
X-Original-To: amd-gfx@lists.freedesktop.org
Delivered-To: amd-gfx@lists.freedesktop.org
Received: from mail-qt1-x841.google.com (mail-qt1-x841.google.com
 [IPv6:2607:f8b0:4864:20::841])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 904556E037
 for <amd-gfx@lists.freedesktop.org>; Mon, 17 Jun 2019 19:49:27 +0000 (UTC)
Received: by mail-qt1-x841.google.com with SMTP id w17so5904004qto.10
 for <amd-gfx@lists.freedesktop.org>; Mon, 17 Jun 2019 12:49:27 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=D6HOnyF5mjyOF2F1wFSL8GYccMfNadCyfy1zwZzTwBY=;
 b=pD8HyuVidLvg+oj0PMbDIW5zQ8puh0PSXS4sGvpkDVREREKyP5Z8EtdWd47Mqwb5qB
 AgiqZaD+Dtqwk/YWeUpETNuniuwO9YHnHSx58msFb/So3n3nABZjWy20j29BPerTNkWK
 +cpvTO/eeRB/wRPnwbQcNPUos2Zo7mBP2dIoTyyy6fs9hLFfGFFiQyGSkK+aw53qXgE7
 tgOaRnb/GdtLhCF7M8RnUXEYloasxuV0Ir3EH+u4cJMejhbEy6Xfkr9cduakQn7KQvSJ
 /2C2p8xFPJWrzMeuL3r/PMA6nP1MGRvOVvQh807cBgnu2WeskBIhI2ZoQiUfOxGnzHbv
 U1Ow==
X-Gm-Message-State: APjAAAWvm6QQd3cxqIHs+cD9+YAs+3wCUxAqTekJCs0YFnMvg9XZ6G0P
 iT4V9s1CaWPaQoPe5upIyw5X9LlgO3hafA==
X-Google-Smtp-Source: APXvYqzUSyarA4ErHplNs7qk6RK/srfIgyiQhzLp/S68JvAmBsGmyos0NvN/le9qdYvalFbaUTbBKQ==
X-Received: by 2002:a0c:89a5:: with SMTP id 34mr3865478qvr.110.1560800966346; 
 Mon, 17 Jun 2019 12:49:26 -0700 (PDT)
Received: from localhost.localdomain ([71.219.5.136])
 by smtp.gmail.com with ESMTPSA id 34sm8125381qtq.59.2019.06.17.12.49.25
 (version=TLS1_3 cipher=AEAD-AES256-GCM-SHA384 bits=256/256);
 Mon, 17 Jun 2019 12:49:25 -0700 (PDT)
From: Alex Deucher <alexdeucher@gmail.com>
X-Google-Original-From: Alex Deucher <alexander.deucher@amd.com>
To: amd-gfx@lists.freedesktop.org
Subject: [PATCH 394/459] drm/amd/display: Acquire DSC HW resource only if
 required by stream
Date: Mon, 17 Jun 2019 14:49:10 -0500
Message-Id: <20190617194915.18618-2-alexander.deucher@amd.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190617194915.18618-1-alexander.deucher@amd.com>
References: <20190617194915.18618-1-alexander.deucher@amd.com>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=gmail.com; s=20161025;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=D6HOnyF5mjyOF2F1wFSL8GYccMfNadCyfy1zwZzTwBY=;
 b=S2zf0bmUzgA8ZQkToFO34n1xGdm0sKgnjlzxHOvycPRzsOYsI4BUW+eICoK+99qDzy
 Cd1dolFjUfQU2ziUomZwDy7dvw5X1bnJcvL2beta04AeRM6W7MbwI0Dn5DRBASzeoOY4
 kDRKTydqoX2ZfG4xd4iPo6xJObPAVbbkXjos9d4v0YtS7HwJftcxIeY9dAHJrF1ldDHZ
 fwVdIm6zmKI5/LV7cCkbXmwLW8XhxQcPA6cdjPxBwNc1mtXq2LYEPiKeBaF2qN4OrUOF
 dfoJ/tEa5HC/+gjJQyQJW7wOPcKFYPIwjZtKC+RIo9DecX5DxwXXp0vNWYv/nGkXV8zd
 DU5Q==
X-BeenThere: amd-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Discussion list for AMD gfx <amd-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/amd-gfx>
List-Post: <mailto:amd-gfx@lists.freedesktop.org>
List-Help: <mailto:amd-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Leo Li <sunpeng.li@amd.com>, Alex Deucher <alexander.deucher@amd.com>,
 Hawking Zhang <Hawking.Zhang@amd.com>, Wenjing Liu <Wenjing.Liu@amd.com>,
 Nikola Cornij <nikola.cornij@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: amd-gfx-bounces@lists.freedesktop.org
Sender: "amd-gfx" <amd-gfx-bounces@lists.freedesktop.org>

RnJvbTogTmlrb2xhIENvcm5paiA8bmlrb2xhLmNvcm5pakBhbWQuY29tPgoKW3doeV0KVGhlcmUg
YXJlIEFTSUNzIHRoYXQgaGF2ZSBmZXdlciBEU0MgZW5naW5lcyB0aGFuIHBpcGVzLCB3aGljaCBt
YWtlcwpEU0MgYSByZXNvdXJjZSB0aGF0IHNob3VsZCBiZSB1c2VkIG9ubHkgaWYgcmVxdWlyZWQu
CgpbaG93XQpBY3F1aXJlIERTQyBIVyByZXNvdXJjZSBpZiByZXF1aXJlZCBieSBzdHJlYW0gYW5k
IHJlbGVhc2Ugd2hlbiBub3QKcmVxdWlyZWQgYW55bW9yZS4KClNpZ25lZC1vZmYtYnk6IE5pa29s
YSBDb3JuaWogPG5pa29sYS5jb3JuaWpAYW1kLmNvbT4KUmV2aWV3ZWQtYnk6IFdlbmppbmcgTGl1
IDxXZW5qaW5nLkxpdUBhbWQuY29tPgpBY2tlZC1ieTogTGVvIExpIDxzdW5wZW5nLmxpQGFtZC5j
b20+CkFja2VkLWJ5OiBIYXdraW5nIFpoYW5nIDxIYXdraW5nLlpoYW5nQGFtZC5jb20+ClNpZ25l
ZC1vZmYtYnk6IEFsZXggRGV1Y2hlciA8YWxleGFuZGVyLmRldWNoZXJAYW1kLmNvbT4KLS0tCiBk
cml2ZXJzL2dwdS9kcm0vYW1kL2Rpc3BsYXkvZGMvY29yZS9kYy5jICAgICAgfCAgMTkgKy0tCiAu
Li4vZHJtL2FtZC9kaXNwbGF5L2RjL2RjbjIwL2RjbjIwX3Jlc291cmNlLmMgfCAxMzkgKysrKysr
KysrKy0tLS0tLS0tCiAuLi4vZHJtL2FtZC9kaXNwbGF5L2RjL2RjbjIwL2RjbjIwX3Jlc291cmNl
LmggfCAgIDIgKwogLi4uL2dwdS9kcm0vYW1kL2Rpc3BsYXkvZGMvaW5jL2NvcmVfdHlwZXMuaCAg
IHwgIDEwICsrCiA0IGZpbGVzIGNoYW5nZWQsIDk3IGluc2VydGlvbnMoKyksIDczIGRlbGV0aW9u
cygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9hbWQvZGlzcGxheS9kYy9jb3JlL2Rj
LmMgYi9kcml2ZXJzL2dwdS9kcm0vYW1kL2Rpc3BsYXkvZGMvY29yZS9kYy5jCmluZGV4IDY4ZWRk
Y2MwZmJjYy4uNmFiZjIyYWFmNTcxIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vYW1kL2Rp
c3BsYXkvZGMvY29yZS9kYy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9hbWQvZGlzcGxheS9kYy9j
b3JlL2RjLmMKQEAgLTE3MzYsMTkgKzE3MzYsMTQgQEAgc3RhdGljIHZvaWQgY29tbWl0X3BsYW5l
c19kb19zdHJlYW1fdXBkYXRlKHN0cnVjdCBkYyAqZGMsCiAKICNpZiBkZWZpbmVkKENPTkZJR19E
Uk1fQU1EX0RDX0RTQ19TVVBQT1JUKQogCQkJaWYgKHN0cmVhbV91cGRhdGUtPmRzY19jb25maWcg
JiYgZGMtPmh3c3MucGlwZV9jb250cm9sX2xvY2tfZ2xvYmFsKSB7Ci0JCQkJaWYgKHN0cmVhbV91
cGRhdGUtPmRzY19jb25maWctPm51bV9zbGljZXNfaCAmJgotCQkJCQkJc3RyZWFtX3VwZGF0ZS0+
ZHNjX2NvbmZpZy0+bnVtX3NsaWNlc192KSB7Ci0JCQkJCS8qIGRzYyBlbmFibGUgKi8KLQkJCQkJ
ZGMtPmh3c3MucGlwZV9jb250cm9sX2xvY2tfZ2xvYmFsKGRjLCBwaXBlX2N0eCwgdHJ1ZSk7Ci0J
CQkJCWRwX3NldF9kc2NfZW5hYmxlKHBpcGVfY3R4LCB0cnVlKTsKLQkJCQkJZGMtPmh3c3MucGlw
ZV9jb250cm9sX2xvY2tfZ2xvYmFsKGRjLCBwaXBlX2N0eCwgZmFsc2UpOwotCQkJCX0gZWxzZSB7
Ci0JCQkJCS8qIGRzYyBkaXNhYmxlICovCi0JCQkJCWRjLT5od3NzLnBpcGVfY29udHJvbF9sb2Nr
X2dsb2JhbChkYywgcGlwZV9jdHgsIHRydWUpOwotCQkJCQlkcF9zZXRfZHNjX2VuYWJsZShwaXBl
X2N0eCwgZmFsc2UpOwotCQkJCQlkYy0+aHdzcy5waXBlX2NvbnRyb2xfbG9ja19nbG9iYWwoZGMs
IHBpcGVfY3R4LCBmYWxzZSk7Ci0JCQkJfQorCQkJCWJvb2wgZW5hYmxlX2RzYyA9IChzdHJlYW1f
dXBkYXRlLT5kc2NfY29uZmlnLT5udW1fc2xpY2VzX2ggJiYgc3RyZWFtX3VwZGF0ZS0+ZHNjX2Nv
bmZpZy0+bnVtX3NsaWNlc192KTsKKworCQkJCWRjLT5od3NzLnBpcGVfY29udHJvbF9sb2NrX2ds
b2JhbChkYywgcGlwZV9jdHgsIHRydWUpOworCQkJCWRwX3NldF9kc2NfZW5hYmxlKHBpcGVfY3R4
LCBlbmFibGVfZHNjKTsKKwkJCQlkYy0+aHdzcy5waXBlX2NvbnRyb2xfbG9ja19nbG9iYWwoZGMs
IHBpcGVfY3R4LCBmYWxzZSk7CiAKKwkJCQlpZiAoIXN0cmVhbS0+aXNfZHNjX2VuYWJsZWQpCisJ
CQkJCWRjLT5yZXNfcG9vbC0+ZnVuY3MtPnJlbW92ZV9kc2NfZnJvbV9zdHJlYW1fcmVzb3VyY2Uo
ZGMsIGNvbnRleHQsIHN0cmVhbSk7CiAJCQl9CiAjZW5kaWYKIAkJCS8qIEZ1bGwgZmUgdXBkYXRl
Ki8KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9hbWQvZGlzcGxheS9kYy9kY24yMC9kY24y
MF9yZXNvdXJjZS5jIGIvZHJpdmVycy9ncHUvZHJtL2FtZC9kaXNwbGF5L2RjL2RjbjIwL2RjbjIw
X3Jlc291cmNlLmMKaW5kZXggZDI2NDJjYzUyYzg1Li4yZDZmOWM0ZGU4OTMgMTAwNjQ0Ci0tLSBh
L2RyaXZlcnMvZ3B1L2RybS9hbWQvZGlzcGxheS9kYy9kY24yMC9kY24yMF9yZXNvdXJjZS5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS9hbWQvZGlzcGxheS9kYy9kY24yMC9kY24yMF9yZXNvdXJjZS5j
CkBAIC0xMjMwLDk0ICsxMjMwLDc5IEBAIGVudW0gZGNfc3RhdHVzIGRjbjIwX2J1aWxkX21hcHBl
ZF9yZXNvdXJjZShjb25zdCBzdHJ1Y3QgZGMgKmRjLCBzdHJ1Y3QgZGNfc3RhdGUKIAogI2lmZGVm
IENPTkZJR19EUk1fQU1EX0RDX0RTQ19TVVBQT1JUCiAKLXN0YXRpYyBzdHJ1Y3QgZGlzcGxheV9z
dHJlYW1fY29tcHJlc3NvciAqYWNxdWlyZV9kc2Moc3RydWN0IHJlc291cmNlX2NvbnRleHQgKnJl
c19jdHgsCi0JCQkJCQljb25zdCBzdHJ1Y3QgcmVzb3VyY2VfcG9vbCAqcG9vbCkKK3N0YXRpYyB2
b2lkIGFjcXVpcmVfZHNjKHN0cnVjdCByZXNvdXJjZV9jb250ZXh0ICpyZXNfY3R4LAorCQkJY29u
c3Qgc3RydWN0IHJlc291cmNlX3Bvb2wgKnBvb2wsCisJCQlzdHJ1Y3QgZGlzcGxheV9zdHJlYW1f
Y29tcHJlc3NvciAqKmRzYykKIHsKIAlpbnQgaTsKLQlzdHJ1Y3QgZGlzcGxheV9zdHJlYW1fY29t
cHJlc3NvciAqZHNjID0gTlVMTDsKKworCUFTU0VSVCgqZHNjID09IE5VTEwpOworCSpkc2MgPSBO
VUxMOwogCiAJLyogRmluZCBmaXJzdCBmcmVlIERTQyAqLwogCWZvciAoaSA9IDA7IGkgPCBwb29s
LT5yZXNfY2FwLT5udW1fZHNjOyBpKyspCiAJCWlmICghcmVzX2N0eC0+aXNfZHNjX2FjcXVpcmVk
W2ldKSB7Ci0JCQlkc2MgPSBwb29sLT5kc2NzW2ldOworCQkJKmRzYyA9IHBvb2wtPmRzY3NbaV07
CiAJCQlyZXNfY3R4LT5pc19kc2NfYWNxdWlyZWRbaV0gPSB0cnVlOwogCQkJYnJlYWs7CiAJCX0K
LQotCXJldHVybiBkc2M7CiB9CiAKIHN0YXRpYyB2b2lkIHJlbGVhc2VfZHNjKHN0cnVjdCByZXNv
dXJjZV9jb250ZXh0ICpyZXNfY3R4LAogCQkJY29uc3Qgc3RydWN0IHJlc291cmNlX3Bvb2wgKnBv
b2wsCi0JCQljb25zdCBzdHJ1Y3QgZGlzcGxheV9zdHJlYW1fY29tcHJlc3NvciAqZHNjKQorCQkJ
c3RydWN0IGRpc3BsYXlfc3RyZWFtX2NvbXByZXNzb3IgKipkc2MpCiB7CiAJaW50IGk7CiAKIAlm
b3IgKGkgPSAwOyBpIDwgcG9vbC0+cmVzX2NhcC0+bnVtX2RzYzsgaSsrKQotCQlpZiAocG9vbC0+
ZHNjc1tpXSA9PSBkc2MpIHsKKwkJaWYgKHBvb2wtPmRzY3NbaV0gPT0gKmRzYykgewogCQkJcmVz
X2N0eC0+aXNfZHNjX2FjcXVpcmVkW2ldID0gZmFsc2U7CisJCQkqZHNjID0gTlVMTDsKIAkJCWJy
ZWFrOwogCQl9CiB9CiAKICNlbmRpZgogCi1lbnVtIGRjX3N0YXR1cyBkY24yMF9hZGRfc3RyZWFt
X3RvX2N0eChzdHJ1Y3QgZGMgKmRjLCBzdHJ1Y3QgZGNfc3RhdGUgKm5ld19jdHgsIHN0cnVjdCBk
Y19zdHJlYW1fc3RhdGUgKmRjX3N0cmVhbSkKLXsKLQllbnVtIGRjX3N0YXR1cyByZXN1bHQgPSBE
Q19FUlJPUl9VTkVYUEVDVEVEOwotCi0JcmVzdWx0ID0gcmVzb3VyY2VfbWFwX3Bvb2xfcmVzb3Vy
Y2VzKGRjLCBuZXdfY3R4LCBkY19zdHJlYW0pOwotCi0JaWYgKHJlc3VsdCA9PSBEQ19PSykKLQkJ
cmVzdWx0ID0gcmVzb3VyY2VfbWFwX3BoeV9jbG9ja19yZXNvdXJjZXMoZGMsIG5ld19jdHgsIGRj
X3N0cmVhbSk7CiAKICNpZmRlZiBDT05GSUdfRFJNX0FNRF9EQ19EU0NfU1VQUE9SVAotCS8qIEdl
dCBhIERTQyBpZiByZXF1aXJlZCBhbmQgYXZhaWxhYmxlICovCi0JaWYgKHJlc3VsdCA9PSBEQ19P
SykgewotCQlpbnQgaTsKLQkJY29uc3Qgc3RydWN0IHJlc291cmNlX3Bvb2wgKnBvb2wgPSBkYy0+
cmVzX3Bvb2w7Ci0JCWJvb2wgaXNfYWRkX2RzYyA9IHRydWU7CitlbnVtIGRjX3N0YXR1cyBkY24y
MF9hZGRfZHNjX3RvX3N0cmVhbV9yZXNvdXJjZShzdHJ1Y3QgZGMgKmRjLAorCQlzdHJ1Y3QgZGNf
c3RhdGUgKmRjX2N0eCwKKwkJc3RydWN0IGRjX3N0cmVhbV9zdGF0ZSAqZGNfc3RyZWFtKQorewor
CWVudW0gZGNfc3RhdHVzIHJlc3VsdCA9IERDX09LOworCWludCBpOworCWNvbnN0IHN0cnVjdCBy
ZXNvdXJjZV9wb29sICpwb29sID0gZGMtPnJlc19wb29sOwogCi0JCWZvciAoaSA9IDA7IGkgPCBk
Yy0+cmVzX3Bvb2wtPnBpcGVfY291bnQ7IGkrKykgewotCQkJc3RydWN0IHBpcGVfY3R4ICpwaXBl
X2N0eCA9ICZuZXdfY3R4LT5yZXNfY3R4LnBpcGVfY3R4W2ldOworCS8qIEdldCBhIERTQyBpZiBy
ZXF1aXJlZCBhbmQgYXZhaWxhYmxlICovCisJZm9yIChpID0gMDsgaSA8IGRjLT5yZXNfcG9vbC0+
cGlwZV9jb3VudDsgaSsrKSB7CisJCXN0cnVjdCBwaXBlX2N0eCAqcGlwZV9jdHggPSAmZGNfY3R4
LT5yZXNfY3R4LnBpcGVfY3R4W2ldOwogCi0JCQlpZiAocGlwZV9jdHgtPnN0cmVhbSAhPSBkY19z
dHJlYW0pCi0JCQkJY29udGludWU7CisJCWlmIChwaXBlX2N0eC0+c3RyZWFtICE9IGRjX3N0cmVh
bSkKKwkJCWNvbnRpbnVlOwogCi0JCQlpZiAoSVNfRElBR19EQyhkYy0+Y3R4LT5kY2VfZW52aXJv
bm1lbnQpIHx8Ci0JCQkJZGMtPnJlc19wb29sLT5yZXNfY2FwLT5udW1fZHNjID09IDEpIHsKLQkJ
CQkvLyBEaWFncyBidWlsZCBjYW4gYWxzbyBydW4gb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBmZXdl
ciBEU0NzIHRoYW4gcGlwZXMuCi0JCQkJLy8gSW4gdGhhdCBjYXNlLCBhZGQgRFNDIG9ubHkgaWYg
bmVlZGVkIGJ5IHRpbWluZy4KLQkJCQlpc19hZGRfZHNjID0gKGRjX3N0cmVhbS0+dGltaW5nLmZs
YWdzLkRTQyA9PSAxKTsKLQkJCX0KLQkJCWlmIChpc19hZGRfZHNjKSB7Ci0JCQkJcGlwZV9jdHgt
PnN0cmVhbV9yZXMuZHNjID0gYWNxdWlyZV9kc2MoJm5ld19jdHgtPnJlc19jdHgsIHBvb2wpOwot
Ci0JCQkJLyogVGhlIG51bWJlciBvZiBEU0NzIGNhbiBiZSBsZXNzIHRoYW4gdGhlIG51bWJlciBv
ZiBwaXBlcyAqLwotCQkJCWlmICghcGlwZV9jdHgtPnN0cmVhbV9yZXMuZHNjKSB7Ci0JCQkJCWRt
X291dHB1dF90b19jb25zb2xlKCJObyBEU0NzIGF2YWlsYWJsZVxuIik7Ci0JCQkJCXJlc3VsdCA9
IERDX05PX0RTQ19SRVNPVVJDRTsKLQkJCQl9Ci0JCQl9CisJCWFjcXVpcmVfZHNjKCZkY19jdHgt
PnJlc19jdHgsIHBvb2wsICZwaXBlX2N0eC0+c3RyZWFtX3Jlcy5kc2MpOwogCi0JCQlicmVhazsK
KwkJLyogVGhlIG51bWJlciBvZiBEU0NzIGNhbiBiZSBsZXNzIHRoYW4gdGhlIG51bWJlciBvZiBw
aXBlcyAqLworCQlpZiAoIXBpcGVfY3R4LT5zdHJlYW1fcmVzLmRzYykgeworCQkJZG1fb3V0cHV0
X3RvX2NvbnNvbGUoIk5vIERTQ3MgYXZhaWxhYmxlXG4iKTsKKwkJCXJlc3VsdCA9IERDX05PX0RT
Q19SRVNPVVJDRTsKIAkJfQotCX0KLSNlbmRpZgogCi0JaWYgKHJlc3VsdCA9PSBEQ19PSykKLQkJ
cmVzdWx0ID0gZGNuMjBfYnVpbGRfbWFwcGVkX3Jlc291cmNlKGRjLCBuZXdfY3R4LCBkY19zdHJl
YW0pOworCQlicmVhazsKKwl9CiAKIAlyZXR1cm4gcmVzdWx0OwogfQogCiAKLWVudW0gZGNfc3Rh
dHVzIGRjbjIwX3JlbW92ZV9zdHJlYW1fZnJvbV9jdHgoc3RydWN0IGRjICpkYywgc3RydWN0IGRj
X3N0YXRlICpuZXdfY3R4LCBzdHJ1Y3QgZGNfc3RyZWFtX3N0YXRlICpkY19zdHJlYW0pCitlbnVt
IGRjX3N0YXR1cyBkY24yMF9yZW1vdmVfZHNjX2Zyb21fc3RyZWFtX3Jlc291cmNlKHN0cnVjdCBk
YyAqZGMsCisJCXN0cnVjdCBkY19zdGF0ZSAqbmV3X2N0eCwKKwkJc3RydWN0IGRjX3N0cmVhbV9z
dGF0ZSAqZGNfc3RyZWFtKQogewogCXN0cnVjdCBwaXBlX2N0eCAqcGlwZV9jdHggPSBOVUxMOwog
CWludCBpOwogCi0JLyogUmVtb3ZlIERTQyAqLwogCWZvciAoaSA9IDA7IGkgPCBNQVhfUElQRVM7
IGkrKykgewogCQlpZiAobmV3X2N0eC0+cmVzX2N0eC5waXBlX2N0eFtpXS5zdHJlYW0gPT0gZGNf
c3RyZWFtICYmICFuZXdfY3R4LT5yZXNfY3R4LnBpcGVfY3R4W2ldLnRvcF9waXBlKSB7CiAJCQlw
aXBlX2N0eCA9ICZuZXdfY3R4LT5yZXNfY3R4LnBpcGVfY3R4W2ldOwpAQCAtMTMyOCwyMSArMTMx
Myw1MSBAQCBlbnVtIGRjX3N0YXR1cyBkY24yMF9yZW1vdmVfc3RyZWFtX2Zyb21fY3R4KHN0cnVj
dCBkYyAqZGMsIHN0cnVjdCBkY19zdGF0ZSAqbmV3XwogCWlmICghcGlwZV9jdHgpCiAJCXJldHVy
biBEQ19FUlJPUl9VTkVYUEVDVEVEOwogCi0jaWZkZWYgQ09ORklHX0RSTV9BTURfRENfRFNDX1NV
UFBPUlQKIAlpZiAocGlwZV9jdHgtPnN0cmVhbV9yZXMuZHNjKSB7CiAJCXN0cnVjdCBwaXBlX2N0
eCAqb2RtX3BpcGUgPSBkY19yZXNfZ2V0X29kbV9ib3R0b21fcGlwZShwaXBlX2N0eCk7CiAKLQkJ
cmVsZWFzZV9kc2MoJm5ld19jdHgtPnJlc19jdHgsIGRjLT5yZXNfcG9vbCwgcGlwZV9jdHgtPnN0
cmVhbV9yZXMuZHNjKTsKLQkJcGlwZV9jdHgtPnN0cmVhbV9yZXMuZHNjID0gTlVMTDsKLQkJaWYg
KG9kbV9waXBlKSB7Ci0JCQlyZWxlYXNlX2RzYygmbmV3X2N0eC0+cmVzX2N0eCwgZGMtPnJlc19w
b29sLCBvZG1fcGlwZS0+c3RyZWFtX3Jlcy5kc2MpOwotCQkJb2RtX3BpcGUtPnN0cmVhbV9yZXMu
ZHNjID0gTlVMTDsKLQkJfQorCQlyZWxlYXNlX2RzYygmbmV3X2N0eC0+cmVzX2N0eCwgZGMtPnJl
c19wb29sLCAmcGlwZV9jdHgtPnN0cmVhbV9yZXMuZHNjKTsKKwkJaWYgKG9kbV9waXBlKQorCQkJ
cmVsZWFzZV9kc2MoJm5ld19jdHgtPnJlc19jdHgsIGRjLT5yZXNfcG9vbCwgJm9kbV9waXBlLT5z
dHJlYW1fcmVzLmRzYyk7CiAJfQotI2VuZGlmCiAKIAlyZXR1cm4gRENfT0s7CiB9CisjZW5kaWYK
KworCitlbnVtIGRjX3N0YXR1cyBkY24yMF9hZGRfc3RyZWFtX3RvX2N0eChzdHJ1Y3QgZGMgKmRj
LCBzdHJ1Y3QgZGNfc3RhdGUgKm5ld19jdHgsIHN0cnVjdCBkY19zdHJlYW1fc3RhdGUgKmRjX3N0
cmVhbSkKK3sKKwllbnVtIGRjX3N0YXR1cyByZXN1bHQgPSBEQ19FUlJPUl9VTkVYUEVDVEVEOwor
CisJcmVzdWx0ID0gcmVzb3VyY2VfbWFwX3Bvb2xfcmVzb3VyY2VzKGRjLCBuZXdfY3R4LCBkY19z
dHJlYW0pOworCisJaWYgKHJlc3VsdCA9PSBEQ19PSykKKwkJcmVzdWx0ID0gcmVzb3VyY2VfbWFw
X3BoeV9jbG9ja19yZXNvdXJjZXMoZGMsIG5ld19jdHgsIGRjX3N0cmVhbSk7CisKKyNpZmRlZiBD
T05GSUdfRFJNX0FNRF9EQ19EU0NfU1VQUE9SVAorCS8qIEdldCBhIERTQyBpZiByZXF1aXJlZCBh
bmQgYXZhaWxhYmxlICovCisJaWYgKHJlc3VsdCA9PSBEQ19PSyAmJiBkY19zdHJlYW0tPnRpbWlu
Zy5mbGFncy5EU0MpCisJCXJlc3VsdCA9IGRjbjIwX2FkZF9kc2NfdG9fc3RyZWFtX3Jlc291cmNl
KGRjLCBuZXdfY3R4LCBkY19zdHJlYW0pOworI2VuZGlmCisKKwlpZiAocmVzdWx0ID09IERDX09L
KQorCQlyZXN1bHQgPSBkY24yMF9idWlsZF9tYXBwZWRfcmVzb3VyY2UoZGMsIG5ld19jdHgsIGRj
X3N0cmVhbSk7CisKKwlyZXR1cm4gcmVzdWx0OworfQorCisKK2VudW0gZGNfc3RhdHVzIGRjbjIw
X3JlbW92ZV9zdHJlYW1fZnJvbV9jdHgoc3RydWN0IGRjICpkYywgc3RydWN0IGRjX3N0YXRlICpu
ZXdfY3R4LCBzdHJ1Y3QgZGNfc3RyZWFtX3N0YXRlICpkY19zdHJlYW0pCit7CisJZW51bSBkY19z
dGF0dXMgcmVzdWx0ID0gRENfT0s7CisKKyNpZmRlZiBDT05GSUdfRFJNX0FNRF9EQ19EU0NfU1VQ
UE9SVAorCXJlc3VsdCA9IGRjbjIwX3JlbW92ZV9kc2NfZnJvbV9zdHJlYW1fcmVzb3VyY2UoZGMs
IG5ld19jdHgsIGRjX3N0cmVhbSk7CisjZW5kaWYKKworCXJldHVybiByZXN1bHQ7Cit9CiAKIAog
c3RhdGljIHZvaWQgc3dpenpsZV90b19kbWxfcGFyYW1zKApAQCAtMTQzOSw4ICsxNDU0LDYgQEAg
c3RhdGljIGJvb2wgZGNuMjBfc3BsaXRfc3RyZWFtX2Zvcl9jb21iaW5lKAogCXNlY29uZGFyeV9w
aXBlLT50b3BfcGlwZSA9IHByaW1hcnlfcGlwZTsKIAogCWlmIChpc19vZG1fY29tYmluZSkgewot
CQlib29sIGlzX2FkZF9kc2MgPSB0cnVlOwotCiAJCWlmIChwcmltYXJ5X3BpcGUtPnBsYW5lX3N0
YXRlKSB7CiAJCQkvKiBIQUNUSVZFIGhhbHZlZCBmb3Igb2RtIGNvbWJpbmUgKi8KIAkJCXNkLT5o
X2FjdGl2ZSAvPSAyOwpAQCAtMTQ3Nyw4ICsxNDkwLDggQEAgc3RhdGljIGJvb2wgZGNuMjBfc3Bs
aXRfc3RyZWFtX2Zvcl9jb21iaW5lKAogCQl9CiAJCXNlY29uZGFyeV9waXBlLT5zdHJlYW1fcmVz
Lm9wcCA9IHBvb2wtPm9wcHNbc2Vjb25kYXJ5X3BpcGUtPnBpcGVfaWR4XTsKICNpZmRlZiBDT05G
SUdfRFJNX0FNRF9EQ19EU0NfU1VQUE9SVAotCQlpZiAoaXNfYWRkX2RzYykgewotCQkJc2Vjb25k
YXJ5X3BpcGUtPnN0cmVhbV9yZXMuZHNjID0gYWNxdWlyZV9kc2MocmVzX2N0eCwgcG9vbCk7CisJ
CWlmIChzZWNvbmRhcnlfcGlwZS0+c3RyZWFtLT50aW1pbmcuZmxhZ3MuRFNDID09IDEpIHsKKwkJ
CWFjcXVpcmVfZHNjKHJlc19jdHgsIHBvb2wsICZzZWNvbmRhcnlfcGlwZS0+c3RyZWFtX3Jlcy5k
c2MpOwogCQkJQVNTRVJUKHNlY29uZGFyeV9waXBlLT5zdHJlYW1fcmVzLmRzYyk7CiAJCQlpZiAo
c2Vjb25kYXJ5X3BpcGUtPnN0cmVhbV9yZXMuZHNjID09IE5VTEwpCiAJCQkJcmV0dXJuIGZhbHNl
OwpAQCAtMTk1Miw3ICsxOTY1LDcgQEAgYm9vbCBkY24yMF92YWxpZGF0ZV9iYW5kd2lkdGgoc3Ry
dWN0IGRjICpkYywgc3RydWN0IGRjX3N0YXRlICpjb250ZXh0LAogCQloc3BsaXRfcGlwZS0+Ym90
dG9tX3BpcGUgPSBOVUxMOwogI2lmZGVmIENPTkZJR19EUk1fQU1EX0RDX0RTQ19TVVBQT1JUCiAJ
CWlmIChoc3BsaXRfcGlwZS0+c3RyZWFtX3Jlcy5kc2MgJiYgaHNwbGl0X3BpcGUtPnN0cmVhbV9y
ZXMuZHNjICE9IHBpcGUtPnN0cmVhbV9yZXMuZHNjKQotCQkJcmVsZWFzZV9kc2MoJmNvbnRleHQt
PnJlc19jdHgsIGRjLT5yZXNfcG9vbCwgaHNwbGl0X3BpcGUtPnN0cmVhbV9yZXMuZHNjKTsKKwkJ
CXJlbGVhc2VfZHNjKCZjb250ZXh0LT5yZXNfY3R4LCBkYy0+cmVzX3Bvb2wsICZoc3BsaXRfcGlw
ZS0+c3RyZWFtX3Jlcy5kc2MpOwogI2VuZGlmCiAJCS8qIENsZWFyIHBsYW5lX3JlcyBhbmQgc3Ry
ZWFtX3JlcyAqLwogCQltZW1zZXQoJmhzcGxpdF9waXBlLT5wbGFuZV9yZXMsIDAsIHNpemVvZiho
c3BsaXRfcGlwZS0+cGxhbmVfcmVzKSk7CkBAIC0yMzY0LDcgKzIzNzcsMTEgQEAgc3RhdGljIHN0
cnVjdCByZXNvdXJjZV9mdW5jcyBkY24yMF9yZXNfcG9vbF9mdW5jcyA9IHsKIAkucmVtb3ZlX3N0
cmVhbV9mcm9tX2N0eCA9IGRjbjIwX3JlbW92ZV9zdHJlYW1fZnJvbV9jdHgsCiAJLnBvcHVsYXRl
X2RtbF93cml0ZWJhY2tfZnJvbV9jb250ZXh0ID0gZGNuMjBfcG9wdWxhdGVfZG1sX3dyaXRlYmFj
a19mcm9tX2NvbnRleHQsCiAJLmdldF9kZWZhdWx0X3N3aXp6bGVfbW9kZSA9IGRjbjIwX2dldF9k
ZWZhdWx0X3N3aXp6bGVfbW9kZSwKLQkuc2V0X21jaWZfYXJiX3BhcmFtcyA9IGRjbjIwX3NldF9t
Y2lmX2FyYl9wYXJhbXMKKwkuc2V0X21jaWZfYXJiX3BhcmFtcyA9IGRjbjIwX3NldF9tY2lmX2Fy
Yl9wYXJhbXMsCisjaWZkZWYgQ09ORklHX0RSTV9BTURfRENfRFNDX1NVUFBPUlQKKwkuYWRkX2Rz
Y190b19zdHJlYW1fcmVzb3VyY2UgPSBkY24yMF9hZGRfZHNjX3RvX3N0cmVhbV9yZXNvdXJjZSwK
KwkucmVtb3ZlX2RzY19mcm9tX3N0cmVhbV9yZXNvdXJjZSA9IGRjbjIwX3JlbW92ZV9kc2NfZnJv
bV9zdHJlYW1fcmVzb3VyY2UKKyNlbmRpZgogfTsKIAogc3RydWN0IHBwX3NtdV9mdW5jcyAqZGNu
MjBfcHBfc211X2NyZWF0ZShzdHJ1Y3QgZGNfY29udGV4dCAqY3R4KQpkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL2FtZC9kaXNwbGF5L2RjL2RjbjIwL2RjbjIwX3Jlc291cmNlLmggYi9kcml2
ZXJzL2dwdS9kcm0vYW1kL2Rpc3BsYXkvZGMvZGNuMjAvZGNuMjBfcmVzb3VyY2UuaAppbmRleCBi
NWE3NTI4OWY0NDQuLjAxODIyNDUxODAxMSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2Ft
ZC9kaXNwbGF5L2RjL2RjbjIwL2RjbjIwX3Jlc291cmNlLmgKKysrIGIvZHJpdmVycy9ncHUvZHJt
L2FtZC9kaXNwbGF5L2RjL2RjbjIwL2RjbjIwX3Jlc291cmNlLmgKQEAgLTEyMSw2ICsxMjEsOCBA
QCBlbnVtIGRjX3N0YXR1cyBkY24yMF9idWlsZF9tYXBwZWRfcmVzb3VyY2UoY29uc3Qgc3RydWN0
IGRjICpkYywgc3RydWN0IGRjX3N0YXRlCiBlbnVtIGRjX3N0YXR1cyBkY24yMF9hZGRfc3RyZWFt
X3RvX2N0eChzdHJ1Y3QgZGMgKmRjLCBzdHJ1Y3QgZGNfc3RhdGUgKm5ld19jdHgsIHN0cnVjdCBk
Y19zdHJlYW1fc3RhdGUgKmRjX3N0cmVhbSk7CiBlbnVtIGRjX3N0YXR1cyBkY24yMF9yZW1vdmVf
c3RyZWFtX2Zyb21fY3R4KHN0cnVjdCBkYyAqZGMsIHN0cnVjdCBkY19zdGF0ZSAqbmV3X2N0eCwg
c3RydWN0IGRjX3N0cmVhbV9zdGF0ZSAqZGNfc3RyZWFtKTsKIGVudW0gZGNfc3RhdHVzIGRjbjIw
X2dldF9kZWZhdWx0X3N3aXp6bGVfbW9kZShzdHJ1Y3QgZGNfcGxhbmVfc3RhdGUgKnBsYW5lX3N0
YXRlKTsKK2VudW0gZGNfc3RhdHVzIGRjbjIwX2FkZF9kc2NfdG9fc3RyZWFtX3Jlc291cmNlKHN0
cnVjdCBkYyAqZGMsIHN0cnVjdCBkY19zdGF0ZSAqZGNfY3R4LCBzdHJ1Y3QgZGNfc3RyZWFtX3N0
YXRlICpkY19zdHJlYW0pOworZW51bSBkY19zdGF0dXMgZGNuMjBfcmVtb3ZlX2RzY19mcm9tX3N0
cmVhbV9yZXNvdXJjZShzdHJ1Y3QgZGMgKmRjLCBzdHJ1Y3QgZGNfc3RhdGUgKm5ld19jdHgsIHN0
cnVjdCBkY19zdHJlYW1fc3RhdGUgKmRjX3N0cmVhbSk7CiAKIHZvaWQgZGNuMjBfcGF0Y2hfYm91
bmRpbmdfYm94KAogCQlzdHJ1Y3QgZGMgKmRjLApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJt
L2FtZC9kaXNwbGF5L2RjL2luYy9jb3JlX3R5cGVzLmggYi9kcml2ZXJzL2dwdS9kcm0vYW1kL2Rp
c3BsYXkvZGMvaW5jL2NvcmVfdHlwZXMuaAppbmRleCBlOTRmM2MxODAxNDQuLjYxYzA0YmQzOWFj
NiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2FtZC9kaXNwbGF5L2RjL2luYy9jb3JlX3R5
cGVzLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2FtZC9kaXNwbGF5L2RjL2luYy9jb3JlX3R5cGVz
LmgKQEAgLTE0Miw2ICsxNDIsMTYgQEAgc3RydWN0IHJlc291cmNlX2Z1bmNzIHsKIAkJCWRpc3Bs
YXlfZTJlX3BpcGVfcGFyYW1zX3N0ICpwaXBlcywKIAkJCWludCBwaXBlX2NudCk7CiAjZW5kaWYK
KworI2lmZGVmIENPTkZJR19EUk1fQU1EX0RDX0RTQ19TVVBQT1JUCitlbnVtIGRjX3N0YXR1cyAo
KmFkZF9kc2NfdG9fc3RyZWFtX3Jlc291cmNlKShzdHJ1Y3QgZGMgKmRjLAorCQkJc3RydWN0IGRj
X3N0YXRlICpkY19jdHgsCisJCQlzdHJ1Y3QgZGNfc3RyZWFtX3N0YXRlICpkY19zdHJlYW0pOwor
CitlbnVtIGRjX3N0YXR1cyAoKnJlbW92ZV9kc2NfZnJvbV9zdHJlYW1fcmVzb3VyY2UpKHN0cnVj
dCBkYyAqZGMsCisJCQlzdHJ1Y3QgZGNfc3RhdGUgKm5ld19jdHgsCisJCQlzdHJ1Y3QgZGNfc3Ry
ZWFtX3N0YXRlICpkY19zdHJlYW0pOworI2VuZGlmCiB9OwogCiBzdHJ1Y3QgYXVkaW9fc3VwcG9y
dHsKLS0gCjIuMjAuMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX18KYW1kLWdmeCBtYWlsaW5nIGxpc3QKYW1kLWdmeEBsaXN0cy5mcmVlZGVza3RvcC5vcmcK
aHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9hbWQtZ2Z4
