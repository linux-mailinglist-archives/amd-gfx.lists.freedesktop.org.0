Return-Path: <amd-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+amd-gfx@lfdr.de
Delivered-To: lists+amd-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id DB9D81393DE
	for <lists+amd-gfx@lfdr.de>; Mon, 13 Jan 2020 15:41:07 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 70A566E0E3;
	Mon, 13 Jan 2020 14:41:04 +0000 (UTC)
X-Original-To: amd-gfx@lists.freedesktop.org
Delivered-To: amd-gfx@lists.freedesktop.org
Received: from mail-wm1-x342.google.com (mail-wm1-x342.google.com
 [IPv6:2a00:1450:4864:20::342])
 by gabe.freedesktop.org (Postfix) with ESMTPS id B70906E0D8
 for <amd-gfx@lists.freedesktop.org>; Mon, 13 Jan 2020 14:41:01 +0000 (UTC)
Received: by mail-wm1-x342.google.com with SMTP id f129so9932403wmf.2
 for <amd-gfx@lists.freedesktop.org>; Mon, 13 Jan 2020 06:41:01 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20161025;
 h=from:to:subject:date:message-id:in-reply-to:references:mime-version
 :content-transfer-encoding;
 bh=2sDfJc3MIDyTvPi1/WSOYUIFKgAtZ6IvEjHorsZFYwk=;
 b=fEsNXu+joblcSiPa/KDakqJ1kTrGUU4UQIroyNyCLxiVF45NSoDusGtEpos9zJJs10
 ckfoN3fEvHGh8ZmYBLavEtzZxi6MGeH5O9Q+8qVbOR0grf1b8MO6HH0fxlQNxFcFov/P
 k3j018Aa318a2K95TciugjM5cEcvVX6D4QW4AnjDwx53FTMjS0FY2t7htYY04L55r9YH
 p4TiQLWoPLjxfxuSBrtJ1fVpxw+0QUbUM7zimSOv9XdYNhkN7qQ7sa0lz14Lf6jR4d3m
 qYgDiBiRHcHc8wS6cxTnXURdjn36rzV/KhdvBaM+Iex/FcPiBrfqn5IOxRHk86A+iBDD
 8DjA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=2sDfJc3MIDyTvPi1/WSOYUIFKgAtZ6IvEjHorsZFYwk=;
 b=eXK6Omw1kUNxjM3ejpKTWlZ+iL1+Fc91Qka9e11MUKWQFrVURKzBuScIH7Tdq1SomT
 LBQTyn0xgFuzKTLdA2UhNzvGXsLrKJ+WmXAH1mPjkGksNZY4NRfsu+XoAqp7ngTAOIpL
 lTWVXyXssOD49p7Uvfz+hGblh6FZ6wjASPsKxat5DYM5rDUs4uweyqH38vVzR/Ms6u0M
 HGcF/m9lQgmeeS2URkHAg+/3tsJXTVc/1ULWhPKsnrhuAw97Q2+ySvaGwavDXvzz0ibr
 UNWSXk9HQLQR4bbAAEJbqOSyrkA0c/Fc2QSfAdVbVk6K2kAVRYIlQd0MKBwzlZudqT0i
 rQeg==
X-Gm-Message-State: APjAAAXNKHqSERcLmQSn4wxwlpOfE1np22T+5NPU0skuB8RGgQ4lY5Ay
 RC9nWO4BRdQD+t4LNVM3YIQPTa4h
X-Google-Smtp-Source: APXvYqw45rn3SXMJRBKpoooPyW+RyQTeKD6n3zuNZ6luYT2GiF9+E9pKtvFaqDb+eImtREhw3RxA2A==
X-Received: by 2002:a7b:c151:: with SMTP id z17mr20631859wmi.137.1578926459991; 
 Mon, 13 Jan 2020 06:40:59 -0800 (PST)
Received: from abel.fritz.box ([2a02:908:1252:fb60:bd29:349f:9f33:2a26])
 by smtp.gmail.com with ESMTPSA id m10sm15347802wrx.19.2020.01.13.06.40.59
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Mon, 13 Jan 2020 06:40:59 -0800 (PST)
From: "=?UTF-8?q?Christian=20K=C3=B6nig?=" <ckoenig.leichtzumerken@gmail.com>
X-Google-Original-From: =?UTF-8?q?Christian=20K=C3=B6nig?=
 <christian.koenig@amd.com>
To: amd-gfx@lists.freedesktop.org, Alex.Sierra@amd.com, Philip.Yang@amd.com,
 felix.kuehling@amd.com
Subject: [PATCH 5/8] drm/amdgpu: rework synchronization of VM updates v2
Date: Mon, 13 Jan 2020 15:40:52 +0100
Message-Id: <20200113144055.3416-5-christian.koenig@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20200113144055.3416-1-christian.koenig@amd.com>
References: <20200113144055.3416-1-christian.koenig@amd.com>
MIME-Version: 1.0
X-BeenThere: amd-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Discussion list for AMD gfx <amd-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/amd-gfx>
List-Post: <mailto:amd-gfx@lists.freedesktop.org>
List-Help: <mailto:amd-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: amd-gfx-bounces@lists.freedesktop.org
Sender: "amd-gfx" <amd-gfx-bounces@lists.freedesktop.org>

SWYgcHJvdmlkZWQgd2Ugb25seSBzeW5jIHRvIHRoZSBCT3MgcmVzZXJ2YXRpb24Kb2JqZWN0IGFu
ZCBubyBsb25nZXIgdG8gdGhlIHJvb3QgUEQuCgp2MjogdXBkYXRlIGNvbW1lbnQsIGNsZWFudXAg
YW1kZ3B1X2JvX3N5bmNfd2FpdF9yZXN2CgpTaWduZWQtb2ZmLWJ5OiBDaHJpc3RpYW4gS8O2bmln
IDxjaHJpc3RpYW4ua29lbmlnQGFtZC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRn
cHUvYW1kZ3B1X29iamVjdC5jICB8IDM3ICsrKysrKysrKysrKysrKy0tLS0tCiBkcml2ZXJzL2dw
dS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfb2JqZWN0LmggIHwgIDMgKysKIGRyaXZlcnMvZ3B1L2Ry
bS9hbWQvYW1kZ3B1L2FtZGdwdV9zeW5jLmMgICAgfCAgNyAtLS0tCiBkcml2ZXJzL2dwdS9kcm0v
YW1kL2FtZGdwdS9hbWRncHVfdm0uYyAgICAgIHwgMzggKysrKysrKysrKysrLS0tLS0tLS0tCiBk
cml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdm0uaCAgICAgIHwgIDQgKy0tCiBkcml2
ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdm1fY3B1LmMgIHwgMjIgKysrLS0tLS0tLS0t
CiBkcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdm1fc2RtYS5jIHwgMTUgKysrLS0t
LS0KIDcgZmlsZXMgY2hhbmdlZCwgNjUgaW5zZXJ0aW9ucygrKSwgNjEgZGVsZXRpb25zKC0pCgpk
aWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X29iamVjdC5jIGIv
ZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X29iamVjdC5jCmluZGV4IDQ2Yzc2ZTJl
MTI4MS4uYzcwYmJkZGEwNzhjIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdw
dS9hbWRncHVfb2JqZWN0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1
X29iamVjdC5jCkBAIC0xNDAzLDMwICsxNDAzLDUxIEBAIHZvaWQgYW1kZ3B1X2JvX2ZlbmNlKHN0
cnVjdCBhbWRncHVfYm8gKmJvLCBzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZSwKIH0KIAogLyoqCi0g
KiBhbWRncHVfc3luY193YWl0X3Jlc3YgLSBXYWl0IGZvciBCTyByZXNlcnZhdGlvbiBmZW5jZXMK
KyAqIGFtZGdwdV9ib19zeW5jX3dhaXRfcmVzdiAtIFdhaXQgZm9yIEJPIHJlc2VydmF0aW9uIGZl
bmNlcwogICoKLSAqIEBibzogYnVmZmVyIG9iamVjdAorICogQGFkZXY6IGFtZGdwdSBkZXZpY2Ug
cG9pbnRlcgorICogQHJlc3Y6IHJlc2VydmF0aW9uIG9iamVjdCB0byBzeW5jIHRvCisgKiBAc3lu
Y19tb2RlOiBzeW5jaHJvbml6YXRpb24gbW9kZQogICogQG93bmVyOiBmZW5jZSBvd25lcgogICog
QGludHI6IFdoZXRoZXIgdGhlIHdhaXQgaXMgaW50ZXJydXB0aWJsZQogICoKKyAqIEV4dHJhY3Qg
dGhlIGZlbmNlcyBmcm9tIHRoZSByZXNlcnZhdGlvbiBvYmplY3QgYW5kIHdhaXRzIGZvciB0aGVt
IHRvIGZpbmlzaC4KKyAqCiAgKiBSZXR1cm5zOgogICogMCBvbiBzdWNjZXNzLCBlcnJubyBvdGhl
cndpc2UuCiAgKi8KLWludCBhbWRncHVfYm9fc3luY193YWl0KHN0cnVjdCBhbWRncHVfYm8gKmJv
LCB2b2lkICpvd25lciwgYm9vbCBpbnRyKQoraW50IGFtZGdwdV9ib19zeW5jX3dhaXRfcmVzdihz
dHJ1Y3QgYW1kZ3B1X2RldmljZSAqYWRldiwgc3RydWN0IGRtYV9yZXN2ICpyZXN2LAorCQkJICAg
ICBlbnVtIGFtZGdwdV9zeW5jX21vZGUgc3luY19tb2RlLCB2b2lkICpvd25lciwKKwkJCSAgICAg
Ym9vbCBpbnRyKQogewotCXN0cnVjdCBhbWRncHVfZGV2aWNlICphZGV2ID0gYW1kZ3B1X3R0bV9h
ZGV2KGJvLT50Ym8uYmRldik7CiAJc3RydWN0IGFtZGdwdV9zeW5jIHN5bmM7CiAJaW50IHI7CiAK
IAlhbWRncHVfc3luY19jcmVhdGUoJnN5bmMpOwotCWFtZGdwdV9zeW5jX3Jlc3YoYWRldiwgJnN5
bmMsIGJvLT50Ym8uYmFzZS5yZXN2LAotCQkJIEFNREdQVV9TWU5DX05FX09XTkVSLCBvd25lcik7
Ci0JciA9IGFtZGdwdV9zeW5jX3dhaXQoJnN5bmMsIGludHIpOworCWFtZGdwdV9zeW5jX3Jlc3Yo
YWRldiwgJnN5bmMsIHJlc3YsIHN5bmNfbW9kZSwgb3duZXIpOworCXIgPSBhbWRncHVfc3luY193
YWl0KCZzeW5jLCB0cnVlKTsKIAlhbWRncHVfc3luY19mcmVlKCZzeW5jKTsKLQogCXJldHVybiBy
OwogfQogCisvKioKKyAqIGFtZGdwdV9ib19zeW5jX3dhaXQgLSBXcmFwcGVyIGZvciBhbWRncHVf
Ym9fc3luY193YWl0X3Jlc3YKKyAqIEBibzogYnVmZmVyIG9iamVjdCB0byB3YWl0IGZvcgorICog
QG93bmVyOiBmZW5jZSBvd25lcgorICogQGludHI6IFdoZXRoZXIgdGhlIHdhaXQgaXMgaW50ZXJy
dXB0aWJsZQorICoKKyAqIFdyYXBwZXIgdG8gd2FpdCBmb3IgZmVuY2VzIGluIGEgQk8uCisgKiBS
ZXR1cm5zOgorICogMCBvbiBzdWNjZXNzLCBlcnJubyBvdGhlcndpc2UuCisgKi8KK2ludCBhbWRn
cHVfYm9fc3luY193YWl0KHN0cnVjdCBhbWRncHVfYm8gKmJvLCB2b2lkICpvd25lciwgYm9vbCBp
bnRyKQoreworCXN0cnVjdCBhbWRncHVfZGV2aWNlICphZGV2ID0gYW1kZ3B1X3R0bV9hZGV2KGJv
LT50Ym8uYmRldik7CisKKwlyZXR1cm4gYW1kZ3B1X2JvX3N5bmNfd2FpdF9yZXN2KGFkZXYsIGJv
LT50Ym8uYmFzZS5yZXN2LAorCQkJCQlBTURHUFVfU1lOQ19ORV9PV05FUiwgb3duZXIsIGludHIp
OworfQorCiAvKioKICAqIGFtZGdwdV9ib19ncHVfb2Zmc2V0IC0gcmV0dXJuIEdQVSBvZmZzZXQg
b2YgYm8KICAqIEBibzoJYW1kZ3B1IG9iamVjdCBmb3Igd2hpY2ggd2UgcXVlcnkgdGhlIG9mZnNl
dApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X29iamVjdC5o
IGIvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X29iamVjdC5oCmluZGV4IDJlZWFm
Yzc3YzljMS4uOTZkODA1ODg5ZThkIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vYW1kL2Ft
ZGdwdS9hbWRncHVfb2JqZWN0LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1k
Z3B1X29iamVjdC5oCkBAIC0yODMsNiArMjgzLDkgQEAgdm9pZCBhbWRncHVfYm9fcmVsZWFzZV9u
b3RpZnkoc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibyk7CiBpbnQgYW1kZ3B1X2JvX2ZhdWx0
X3Jlc2VydmVfbm90aWZ5KHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8pOwogdm9pZCBhbWRn
cHVfYm9fZmVuY2Uoc3RydWN0IGFtZGdwdV9ibyAqYm8sIHN0cnVjdCBkbWFfZmVuY2UgKmZlbmNl
LAogCQkgICAgIGJvb2wgc2hhcmVkKTsKK2ludCBhbWRncHVfYm9fc3luY193YWl0X3Jlc3Yoc3Ry
dWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYsIHN0cnVjdCBkbWFfcmVzdiAqcmVzdiwKKwkJCSAgICAg
ZW51bSBhbWRncHVfc3luY19tb2RlIHN5bmNfbW9kZSwgdm9pZCAqb3duZXIsCisJCQkgICAgIGJv
b2wgaW50cik7CiBpbnQgYW1kZ3B1X2JvX3N5bmNfd2FpdChzdHJ1Y3QgYW1kZ3B1X2JvICpibywg
dm9pZCAqb3duZXIsIGJvb2wgaW50cik7CiB1NjQgYW1kZ3B1X2JvX2dwdV9vZmZzZXQoc3RydWN0
IGFtZGdwdV9ibyAqYm8pOwogaW50IGFtZGdwdV9ib192YWxpZGF0ZShzdHJ1Y3QgYW1kZ3B1X2Jv
ICpibyk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfc3lu
Yy5jIGIvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X3N5bmMuYwppbmRleCBjMTI0
ZjY0ZTdhYWUuLjU4MTZkZjlmODUzMSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2FtZC9h
bWRncHUvYW1kZ3B1X3N5bmMuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRn
cHVfc3luYy5jCkBAIC0yNDAsMTMgKzI0MCw2IEBAIGludCBhbWRncHVfc3luY19yZXN2KHN0cnVj
dCBhbWRncHVfZGV2aWNlICphZGV2LCBzdHJ1Y3QgYW1kZ3B1X3N5bmMgKnN5bmMsCiAJCSAgICBv
d25lciAhPSBBTURHUFVfRkVOQ0VfT1dORVJfVU5ERUZJTkVEKQogCQkJY29udGludWU7CiAKLQkJ
LyogVk0gdXBkYXRlcyBvbmx5IHN5bmMgd2l0aCBtb3ZlcyBidXQgbm90IHdpdGggdXNlcgotCQkg
KiBjb21tYW5kIHN1Ym1pc3Npb25zIG9yIEtGRCBldmljdGlvbnMgZmVuY2VzCi0JCSAqLwotCQlp
ZiAoZmVuY2Vfb3duZXIgIT0gQU1ER1BVX0ZFTkNFX09XTkVSX1VOREVGSU5FRCAmJgotCQkgICAg
b3duZXIgPT0gQU1ER1BVX0ZFTkNFX09XTkVSX1ZNKQotCQkJY29udGludWU7Ci0KIAkJLyogSWdu
b3JlIGZlbmNlcyBkZXBlbmRpbmcgb24gdGhlIHN5bmMgbW9kZSAqLwogCQlzd2l0Y2ggKG1vZGUp
IHsKIAkJY2FzZSBBTURHUFVfU1lOQ19BTFdBWVM6CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9k
cm0vYW1kL2FtZGdwdS9hbWRncHVfdm0uYyBiL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2Ft
ZGdwdV92bS5jCmluZGV4IGI5OTliNjdmZjU3YS4uNTUxNjVhNDRlNGJiIDEwMDY0NAotLS0gYS9k
cml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdm0uYworKysgYi9kcml2ZXJzL2dwdS9k
cm0vYW1kL2FtZGdwdS9hbWRncHVfdm0uYwpAQCAtNzc3LDcgKzc3Nyw3IEBAIHN0YXRpYyBpbnQg
YW1kZ3B1X3ZtX2NsZWFyX2JvKHN0cnVjdCBhbWRncHVfZGV2aWNlICphZGV2LAogCXBhcmFtcy52
bSA9IHZtOwogCXBhcmFtcy5kaXJlY3QgPSBkaXJlY3Q7CiAKLQlyID0gdm0tPnVwZGF0ZV9mdW5j
cy0+cHJlcGFyZSgmcGFyYW1zLCBBTURHUFVfRkVOQ0VfT1dORVJfS0ZELCBOVUxMKTsKKwlyID0g
dm0tPnVwZGF0ZV9mdW5jcy0+cHJlcGFyZSgmcGFyYW1zLCBOVUxMLCBBTURHUFVfU1lOQ19FWFBM
SUNJVCk7CiAJaWYgKHIpCiAJCXJldHVybiByOwogCkBAIC0xMjczLDcgKzEyNzMsNyBAQCBpbnQg
YW1kZ3B1X3ZtX3VwZGF0ZV9wZGVzKHN0cnVjdCBhbWRncHVfZGV2aWNlICphZGV2LAogCXBhcmFt
cy52bSA9IHZtOwogCXBhcmFtcy5kaXJlY3QgPSBkaXJlY3Q7CiAKLQlyID0gdm0tPnVwZGF0ZV9m
dW5jcy0+cHJlcGFyZSgmcGFyYW1zLCBBTURHUFVfRkVOQ0VfT1dORVJfVk0sIE5VTEwpOworCXIg
PSB2bS0+dXBkYXRlX2Z1bmNzLT5wcmVwYXJlKCZwYXJhbXMsIE5VTEwsIEFNREdQVV9TWU5DX0VY
UExJQ0lUKTsKIAlpZiAocikKIAkJcmV0dXJuIHI7CiAKQEAgLTE1MjQsNyArMTUyNCw3IEBAIHN0
YXRpYyBpbnQgYW1kZ3B1X3ZtX3VwZGF0ZV9wdGVzKHN0cnVjdCBhbWRncHVfdm1fdXBkYXRlX3Bh
cmFtcyAqcGFyYW1zLAogICogQGFkZXY6IGFtZGdwdV9kZXZpY2UgcG9pbnRlcgogICogQHZtOiBy
ZXF1ZXN0ZWQgdm0KICAqIEBkaXJlY3Q6IGRpcmVjdCBzdWJtaXNzaW9uIGluIGEgcGFnZSBmYXVs
dAotICogQGV4Y2x1c2l2ZTogZmVuY2Ugd2UgbmVlZCB0byBzeW5jIHRvCisgKiBAcmVzdjogZmVu
Y2VzIHdlIG5lZWQgdG8gc3luYyB0bwogICogQHN0YXJ0OiBzdGFydCBvZiBtYXBwZWQgcmFuZ2UK
ICAqIEBsYXN0OiBsYXN0IG1hcHBlZCBlbnRyeQogICogQGZsYWdzOiBmbGFncyBmb3IgdGhlIGVu
dHJpZXMKQEAgLTE1MzksMTQgKzE1MzksMTQgQEAgc3RhdGljIGludCBhbWRncHVfdm1fdXBkYXRl
X3B0ZXMoc3RydWN0IGFtZGdwdV92bV91cGRhdGVfcGFyYW1zICpwYXJhbXMsCiAgKi8KIHN0YXRp
YyBpbnQgYW1kZ3B1X3ZtX2JvX3VwZGF0ZV9tYXBwaW5nKHN0cnVjdCBhbWRncHVfZGV2aWNlICph
ZGV2LAogCQkJCSAgICAgICBzdHJ1Y3QgYW1kZ3B1X3ZtICp2bSwgYm9vbCBkaXJlY3QsCi0JCQkJ
ICAgICAgIHN0cnVjdCBkbWFfZmVuY2UgKmV4Y2x1c2l2ZSwKKwkJCQkgICAgICAgc3RydWN0IGRt
YV9yZXN2ICpyZXN2LAogCQkJCSAgICAgICB1aW50NjRfdCBzdGFydCwgdWludDY0X3QgbGFzdCwK
IAkJCQkgICAgICAgdWludDY0X3QgZmxhZ3MsIHVpbnQ2NF90IGFkZHIsCiAJCQkJICAgICAgIGRt
YV9hZGRyX3QgKnBhZ2VzX2FkZHIsCiAJCQkJICAgICAgIHN0cnVjdCBkbWFfZmVuY2UgKipmZW5j
ZSkKIHsKIAlzdHJ1Y3QgYW1kZ3B1X3ZtX3VwZGF0ZV9wYXJhbXMgcGFyYW1zOwotCXZvaWQgKm93
bmVyID0gQU1ER1BVX0ZFTkNFX09XTkVSX1ZNOworCWVudW0gYW1kZ3B1X3N5bmNfbW9kZSBzeW5j
X21vZGU7CiAJaW50IHI7CiAKIAltZW1zZXQoJnBhcmFtcywgMCwgc2l6ZW9mKHBhcmFtcykpOwpA
QCAtMTU1NSw5ICsxNTU1LDEzIEBAIHN0YXRpYyBpbnQgYW1kZ3B1X3ZtX2JvX3VwZGF0ZV9tYXBw
aW5nKHN0cnVjdCBhbWRncHVfZGV2aWNlICphZGV2LAogCXBhcmFtcy5kaXJlY3QgPSBkaXJlY3Q7
CiAJcGFyYW1zLnBhZ2VzX2FkZHIgPSBwYWdlc19hZGRyOwogCi0JLyogc3luYyB0byBldmVyeXRo
aW5nIGV4Y2VwdCBldmljdGlvbiBmZW5jZXMgb24gdW5tYXBwaW5nICovCisJLyogSW1wbGljaXRs
eSBzeW5jIHRvIGNvbW1hbmQgc3VibWlzc2lvbnMgaW4gdGhlIHNhbWUgVk0gYmVmb3JlCisJICog
dW5tYXBwaW5nLiBTeW5jIHRvIG1vdmluZyBmZW5jZXMgYmVmb3JlIG1hcHBpbmcuCisJICovCiAJ
aWYgKCEoZmxhZ3MgJiBBTURHUFVfUFRFX1ZBTElEKSkKLQkJb3duZXIgPSBBTURHUFVfRkVOQ0Vf
T1dORVJfS0ZEOworCQlzeW5jX21vZGUgPSBBTURHUFVfU1lOQ19FUV9PV05FUjsKKwllbHNlCisJ
CXN5bmNfbW9kZSA9IEFNREdQVV9TWU5DX0VYUExJQ0lUOwogCiAJbXV0ZXhfbG9jaygmdm0tPmV2
aWN0aW9uX2xvY2spOwogCWlmICh2bS0+ZXZpY3RpbmcpIHsKQEAgLTE1NjUsNyArMTU2OSw3IEBA
IHN0YXRpYyBpbnQgYW1kZ3B1X3ZtX2JvX3VwZGF0ZV9tYXBwaW5nKHN0cnVjdCBhbWRncHVfZGV2
aWNlICphZGV2LAogCQlnb3RvIGVycm9yX3VubG9jazsKIAl9CiAKLQlyID0gdm0tPnVwZGF0ZV9m
dW5jcy0+cHJlcGFyZSgmcGFyYW1zLCBvd25lciwgZXhjbHVzaXZlKTsKKwlyID0gdm0tPnVwZGF0
ZV9mdW5jcy0+cHJlcGFyZSgmcGFyYW1zLCByZXN2LCBzeW5jX21vZGUpOwogCWlmIChyKQogCQln
b3RvIGVycm9yX3VubG9jazsKIApAQCAtMTU4NCw3ICsxNTg4LDcgQEAgc3RhdGljIGludCBhbWRn
cHVfdm1fYm9fdXBkYXRlX21hcHBpbmcoc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYsCiAgKiBh
bWRncHVfdm1fYm9fc3BsaXRfbWFwcGluZyAtIHNwbGl0IGEgbWFwcGluZyBpbnRvIHNtYWxsZXIg
Y2h1bmtzCiAgKgogICogQGFkZXY6IGFtZGdwdV9kZXZpY2UgcG9pbnRlcgotICogQGV4Y2x1c2l2
ZTogZmVuY2Ugd2UgbmVlZCB0byBzeW5jIHRvCisgKiBAcmVzdjogZmVuY2VzIHdlIG5lZWQgdG8g
c3luYyB0bwogICogQHBhZ2VzX2FkZHI6IERNQSBhZGRyZXNzZXMgdG8gdXNlIGZvciBtYXBwaW5n
CiAgKiBAdm06IHJlcXVlc3RlZCB2bQogICogQG1hcHBpbmc6IG1hcHBlZCByYW5nZSBhbmQgZmxh
Z3MgdG8gdXNlIGZvciB0aGUgdXBkYXRlCkBAIC0xNjAwLDcgKzE2MDQsNyBAQCBzdGF0aWMgaW50
IGFtZGdwdV92bV9ib191cGRhdGVfbWFwcGluZyhzdHJ1Y3QgYW1kZ3B1X2RldmljZSAqYWRldiwK
ICAqIDAgZm9yIHN1Y2Nlc3MsIC1FSU5WQUwgZm9yIGZhaWx1cmUuCiAgKi8KIHN0YXRpYyBpbnQg
YW1kZ3B1X3ZtX2JvX3NwbGl0X21hcHBpbmcoc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYsCi0J
CQkJICAgICAgc3RydWN0IGRtYV9mZW5jZSAqZXhjbHVzaXZlLAorCQkJCSAgICAgIHN0cnVjdCBk
bWFfcmVzdiAqcmVzdiwKIAkJCQkgICAgICBkbWFfYWRkcl90ICpwYWdlc19hZGRyLAogCQkJCSAg
ICAgIHN0cnVjdCBhbWRncHVfdm0gKnZtLAogCQkJCSAgICAgIHN0cnVjdCBhbWRncHVfYm9fdmFf
bWFwcGluZyAqbWFwcGluZywKQEAgLTE2NzYsNyArMTY4MCw3IEBAIHN0YXRpYyBpbnQgYW1kZ3B1
X3ZtX2JvX3NwbGl0X21hcHBpbmcoc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYsCiAJCX0KIAog
CQlsYXN0ID0gbWluKCh1aW50NjRfdCltYXBwaW5nLT5sYXN0LCBzdGFydCArIG1heF9lbnRyaWVz
IC0gMSk7Ci0JCXIgPSBhbWRncHVfdm1fYm9fdXBkYXRlX21hcHBpbmcoYWRldiwgdm0sIGZhbHNl
LCBleGNsdXNpdmUsCisJCXIgPSBhbWRncHVfdm1fYm9fdXBkYXRlX21hcHBpbmcoYWRldiwgdm0s
IGZhbHNlLCByZXN2LAogCQkJCQkJc3RhcnQsIGxhc3QsIGZsYWdzLCBhZGRyLAogCQkJCQkJZG1h
X2FkZHIsIGZlbmNlKTsKIAkJaWYgKHIpCkBAIC0xNzE1LDcgKzE3MTksOCBAQCBpbnQgYW1kZ3B1
X3ZtX2JvX3VwZGF0ZShzdHJ1Y3QgYW1kZ3B1X2RldmljZSAqYWRldiwgc3RydWN0IGFtZGdwdV9i
b192YSAqYm9fdmEsCiAJZG1hX2FkZHJfdCAqcGFnZXNfYWRkciA9IE5VTEw7CiAJc3RydWN0IHR0
bV9tZW1fcmVnICptZW07CiAJc3RydWN0IGRybV9tbV9ub2RlICpub2RlczsKLQlzdHJ1Y3QgZG1h
X2ZlbmNlICpleGNsdXNpdmUsICoqbGFzdF91cGRhdGU7CisJc3RydWN0IGRtYV9mZW5jZSAqKmxh
c3RfdXBkYXRlOworCXN0cnVjdCBkbWFfcmVzdiAqcmVzdjsKIAl1aW50NjRfdCBmbGFnczsKIAlz
dHJ1Y3QgYW1kZ3B1X2RldmljZSAqYm9fYWRldiA9IGFkZXY7CiAJaW50IHI7CkBAIC0xNzIzLDcg
KzE3MjgsNiBAQCBpbnQgYW1kZ3B1X3ZtX2JvX3VwZGF0ZShzdHJ1Y3QgYW1kZ3B1X2RldmljZSAq
YWRldiwgc3RydWN0IGFtZGdwdV9ib192YSAqYm9fdmEsCiAJaWYgKGNsZWFyIHx8ICFibykgewog
CQltZW0gPSBOVUxMOwogCQlub2RlcyA9IE5VTEw7Ci0JCWV4Y2x1c2l2ZSA9IE5VTEw7CiAJfSBl
bHNlIHsKIAkJc3RydWN0IHR0bV9kbWFfdHQgKnR0bTsKIApAQCAtMTczMyw3ICsxNzM3LDYgQEAg
aW50IGFtZGdwdV92bV9ib191cGRhdGUoc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYsIHN0cnVj
dCBhbWRncHVfYm9fdmEgKmJvX3ZhLAogCQkJdHRtID0gY29udGFpbmVyX29mKGJvLT50Ym8udHRt
LCBzdHJ1Y3QgdHRtX2RtYV90dCwgdHRtKTsKIAkJCXBhZ2VzX2FkZHIgPSB0dG0tPmRtYV9hZGRy
ZXNzOwogCQl9Ci0JCWV4Y2x1c2l2ZSA9IGJvLT50Ym8ubW92aW5nOwogCX0KIAogCWlmIChibykg
ewpAQCAtMTc0MywxMSArMTc0NiwxNCBAQCBpbnQgYW1kZ3B1X3ZtX2JvX3VwZGF0ZShzdHJ1Y3Qg
YW1kZ3B1X2RldmljZSAqYWRldiwgc3RydWN0IGFtZGdwdV9ib192YSAqYm9fdmEsCiAJCQlmbGFn
cyB8PSBBTURHUFVfUFRFX1RNWjsKIAogCQlib19hZGV2ID0gYW1kZ3B1X3R0bV9hZGV2KGJvLT50
Ym8uYmRldik7CisJCXJlc3YgPSBiby0+dGJvLmJhc2UucmVzdjsKIAl9IGVsc2UgewogCQlmbGFn
cyA9IDB4MDsKKwkJcmVzdiA9IE5VTEw7CiAJfQogCi0JaWYgKGNsZWFyIHx8IChibyAmJiBiby0+
dGJvLmJhc2UucmVzdiA9PSB2bS0+cm9vdC5iYXNlLmJvLT50Ym8uYmFzZS5yZXN2KSkKKwlpZiAo
Y2xlYXIgfHwgKGJvICYmIGJvLT50Ym8uYmFzZS5yZXN2ID09CisJCSAgICAgIHZtLT5yb290LmJh
c2UuYm8tPnRiby5iYXNlLnJlc3YpKQogCQlsYXN0X3VwZGF0ZSA9ICZ2bS0+bGFzdF91cGRhdGU7
CiAJZWxzZQogCQlsYXN0X3VwZGF0ZSA9ICZib192YS0+bGFzdF9wdF91cGRhdGU7CkBAIC0xNzYx
LDcgKzE3NjcsNyBAQCBpbnQgYW1kZ3B1X3ZtX2JvX3VwZGF0ZShzdHJ1Y3QgYW1kZ3B1X2Rldmlj
ZSAqYWRldiwgc3RydWN0IGFtZGdwdV9ib192YSAqYm9fdmEsCiAJfQogCiAJbGlzdF9mb3JfZWFj
aF9lbnRyeShtYXBwaW5nLCAmYm9fdmEtPmludmFsaWRzLCBsaXN0KSB7Ci0JCXIgPSBhbWRncHVf
dm1fYm9fc3BsaXRfbWFwcGluZyhhZGV2LCBleGNsdXNpdmUsIHBhZ2VzX2FkZHIsIHZtLAorCQly
ID0gYW1kZ3B1X3ZtX2JvX3NwbGl0X21hcHBpbmcoYWRldiwgcmVzdiwgcGFnZXNfYWRkciwgdm0s
CiAJCQkJCSAgICAgICBtYXBwaW5nLCBmbGFncywgYm9fYWRldiwgbm9kZXMsCiAJCQkJCSAgICAg
ICBsYXN0X3VwZGF0ZSk7CiAJCWlmIChyKQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2Ft
ZC9hbWRncHUvYW1kZ3B1X3ZtLmggYi9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVf
dm0uaAppbmRleCAxMDA1NDdmMDk0ZmYuLmYyNTU3YWVlMmM4MSAxMDA2NDQKLS0tIGEvZHJpdmVy
cy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X3ZtLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2Ft
ZC9hbWRncHUvYW1kZ3B1X3ZtLmgKQEAgLTIyOSw4ICsyMjksOCBAQCBzdHJ1Y3QgYW1kZ3B1X3Zt
X3VwZGF0ZV9wYXJhbXMgewogCiBzdHJ1Y3QgYW1kZ3B1X3ZtX3VwZGF0ZV9mdW5jcyB7CiAJaW50
ICgqbWFwX3RhYmxlKShzdHJ1Y3QgYW1kZ3B1X2JvICpibyk7Ci0JaW50ICgqcHJlcGFyZSkoc3Ry
dWN0IGFtZGdwdV92bV91cGRhdGVfcGFyYW1zICpwLCB2b2lkICogb3duZXIsCi0JCSAgICAgICBz
dHJ1Y3QgZG1hX2ZlbmNlICpleGNsdXNpdmUpOworCWludCAoKnByZXBhcmUpKHN0cnVjdCBhbWRn
cHVfdm1fdXBkYXRlX3BhcmFtcyAqcCwgc3RydWN0IGRtYV9yZXN2ICpyZXN2LAorCQkgICAgICAg
ZW51bSBhbWRncHVfc3luY19tb2RlIHN5bmNfbW9kZSk7CiAJaW50ICgqdXBkYXRlKShzdHJ1Y3Qg
YW1kZ3B1X3ZtX3VwZGF0ZV9wYXJhbXMgKnAsCiAJCSAgICAgIHN0cnVjdCBhbWRncHVfYm8gKmJv
LCB1aW50NjRfdCBwZSwgdWludDY0X3QgYWRkciwKIAkJICAgICAgdW5zaWduZWQgY291bnQsIHVp
bnQzMl90IGluY3IsIHVpbnQ2NF90IGZsYWdzKTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2Ry
bS9hbWQvYW1kZ3B1L2FtZGdwdV92bV9jcHUuYyBiL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1
L2FtZGdwdV92bV9jcHUuYwppbmRleCA2OGIwMTNiZTM4MzcuLmUzODUxNjMwNDA3MCAxMDA2NDQK
LS0tIGEvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X3ZtX2NwdS5jCisrKyBiL2Ry
aXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV92bV9jcHUuYwpAQCAtNDQsMjYgKzQ0LDE0
IEBAIHN0YXRpYyBpbnQgYW1kZ3B1X3ZtX2NwdV9tYXBfdGFibGUoc3RydWN0IGFtZGdwdV9ibyAq
dGFibGUpCiAgKiBSZXR1cm5zOgogICogTmVnYXRpdiBlcnJubywgMCBmb3Igc3VjY2Vzcy4KICAq
Lwotc3RhdGljIGludCBhbWRncHVfdm1fY3B1X3ByZXBhcmUoc3RydWN0IGFtZGdwdV92bV91cGRh
dGVfcGFyYW1zICpwLCB2b2lkICpvd25lciwKLQkJCQkgc3RydWN0IGRtYV9mZW5jZSAqZXhjbHVz
aXZlKQorc3RhdGljIGludCBhbWRncHVfdm1fY3B1X3ByZXBhcmUoc3RydWN0IGFtZGdwdV92bV91
cGRhdGVfcGFyYW1zICpwLAorCQkJCSBzdHJ1Y3QgZG1hX3Jlc3YgKnJlc3YsCisJCQkJIGVudW0g
YW1kZ3B1X3N5bmNfbW9kZSBzeW5jX21vZGUpCiB7Ci0JaW50IHI7Ci0KLQkvKiBXYWl0IGZvciBh
bnkgQk8gbW92ZSB0byBiZSBjb21wbGV0ZWQgKi8KLQlpZiAoZXhjbHVzaXZlKSB7Ci0JCXIgPSBk
bWFfZmVuY2Vfd2FpdChleGNsdXNpdmUsIHRydWUpOwotCQlpZiAodW5saWtlbHkocikpCi0JCQly
ZXR1cm4gcjsKLQl9Ci0KLQkvKiBEb24ndCB3YWl0IGZvciBzdWJtaXNzaW9ucyBkdXJpbmcgcGFn
ZSBmYXVsdCAqLwotCWlmIChwLT5kaXJlY3QpCisJaWYgKCFyZXN2KQogCQlyZXR1cm4gMDsKIAot
CS8qIFdhaXQgZm9yIFBUIEJPcyB0byBiZSBpZGxlLiBQVHMgc2hhcmUgdGhlIHNhbWUgcmVzdi4g
b2JqZWN0Ci0JICogYXMgdGhlIHJvb3QgUEQgQk8KLQkgKi8KLQlyZXR1cm4gYW1kZ3B1X2JvX3N5
bmNfd2FpdChwLT52bS0+cm9vdC5iYXNlLmJvLCBvd25lciwgdHJ1ZSk7CisJcmV0dXJuIGFtZGdw
dV9ib19zeW5jX3dhaXRfcmVzdihwLT5hZGV2LCByZXN2LCBzeW5jX21vZGUsIHAtPnZtLCB0cnVl
KTsKIH0KIAogLyoqCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRn
cHVfdm1fc2RtYS5jIGIvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X3ZtX3NkbWEu
YwppbmRleCAzYjYxMzE3YzBmMDguLmU3YTM4MzEzNDUyMSAxMDA2NDQKLS0tIGEvZHJpdmVycy9n
cHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X3ZtX3NkbWEuYworKysgYi9kcml2ZXJzL2dwdS9kcm0v
YW1kL2FtZGdwdS9hbWRncHVfdm1fc2RtYS5jCkBAIC01OCw5ICs1OCw5IEBAIHN0YXRpYyBpbnQg
YW1kZ3B1X3ZtX3NkbWFfbWFwX3RhYmxlKHN0cnVjdCBhbWRncHVfYm8gKnRhYmxlKQogICogTmVn
YXRpdiBlcnJubywgMCBmb3Igc3VjY2Vzcy4KICAqLwogc3RhdGljIGludCBhbWRncHVfdm1fc2Rt
YV9wcmVwYXJlKHN0cnVjdCBhbWRncHVfdm1fdXBkYXRlX3BhcmFtcyAqcCwKLQkJCQkgIHZvaWQg
Km93bmVyLCBzdHJ1Y3QgZG1hX2ZlbmNlICpleGNsdXNpdmUpCisJCQkJICBzdHJ1Y3QgZG1hX3Jl
c3YgKnJlc3YsCisJCQkJICBlbnVtIGFtZGdwdV9zeW5jX21vZGUgc3luY19tb2RlKQogewotCXN0
cnVjdCBhbWRncHVfYm8gKnJvb3QgPSBwLT52bS0+cm9vdC5iYXNlLmJvOwogCXVuc2lnbmVkIGlu
dCBuZHcgPSBBTURHUFVfVk1fU0RNQV9NSU5fTlVNX0RXOwogCWludCByOwogCkBAIC03MCwxNyAr
NzAsMTAgQEAgc3RhdGljIGludCBhbWRncHVfdm1fc2RtYV9wcmVwYXJlKHN0cnVjdCBhbWRncHVf
dm1fdXBkYXRlX3BhcmFtcyAqcCwKIAogCXAtPm51bV9kd19sZWZ0ID0gbmR3OwogCi0JLyogV2Fp
dCBmb3IgbW92ZXMgdG8gYmUgY29tcGxldGVkICovCi0JciA9IGFtZGdwdV9zeW5jX2ZlbmNlKCZw
LT5qb2ItPnN5bmMsIGV4Y2x1c2l2ZSwgZmFsc2UpOwotCWlmIChyKQotCQlyZXR1cm4gcjsKLQot
CS8qIERvbid0IHdhaXQgZm9yIGFueSBzdWJtaXNzaW9ucyBkdXJpbmcgcGFnZSBmYXVsdCBoYW5k
bGluZyAqLwotCWlmIChwLT5kaXJlY3QpCisJaWYgKCFyZXN2KQogCQlyZXR1cm4gMDsKIAotCXJl
dHVybiBhbWRncHVfc3luY19yZXN2KHAtPmFkZXYsICZwLT5qb2ItPnN5bmMsIHJvb3QtPnRiby5i
YXNlLnJlc3YsCi0JCQkJQU1ER1BVX1NZTkNfTkVfT1dORVIsIG93bmVyKTsKKwlyZXR1cm4gYW1k
Z3B1X3N5bmNfcmVzdihwLT5hZGV2LCAmcC0+am9iLT5zeW5jLCByZXN2LCBzeW5jX21vZGUsIHAt
PnZtKTsKIH0KIAogLyoqCi0tIAoyLjE3LjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fCmFtZC1nZnggbWFpbGluZyBsaXN0CmFtZC1nZnhAbGlzdHMuZnJl
ZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGlu
Zm8vYW1kLWdmeAo=
