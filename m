Return-Path: <amd-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+amd-gfx@lfdr.de
Delivered-To: lists+amd-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 38E754901A
	for <lists+amd-gfx@lfdr.de>; Mon, 17 Jun 2019 21:47:07 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 4514889F5B;
	Mon, 17 Jun 2019 19:47:03 +0000 (UTC)
X-Original-To: amd-gfx@lists.freedesktop.org
Delivered-To: amd-gfx@lists.freedesktop.org
Received: from mail-qt1-x844.google.com (mail-qt1-x844.google.com
 [IPv6:2607:f8b0:4864:20::844])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2552A89F27
 for <amd-gfx@lists.freedesktop.org>; Mon, 17 Jun 2019 19:47:00 +0000 (UTC)
Received: by mail-qt1-x844.google.com with SMTP id d17so7339309qtj.8
 for <amd-gfx@lists.freedesktop.org>; Mon, 17 Jun 2019 12:47:00 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=QuzD39a6fCUPE1RlAatU45reE508fWhZ7uvbXGERsHE=;
 b=B9yHHsudEfR1odrycj5fWcKXdNZMH9h/dFKmmeYJgpH3ZOPEdPORpyV+Kq9IB3qwTE
 iv4cVJ1veAWU651L6/nPGvKpMOTLzPBmC/sdnfYVYQBGhK6xobO3/oRxdffeMMXWM9GA
 MFgm5AbglAtbbK9AkeTdVNud8I4DGcQja6z989VIj3slX88EPfMYs8hIIm1Z1LWKl6Fh
 FXgaSeXQdgo5JUeu9xe/gs7zs35EF2hAgcd5m94luaft/jAbnLsRZX7QkT2VK1tTN7x+
 nPskQxHv9D/Mi9JyAfF536EcZjTtHh7JjErMk1j4c5RyXRYR1ojujjyqjrQdp+2cYVQK
 AgUw==
X-Gm-Message-State: APjAAAXb+9ycVWHkysGuI22Oo5aF4xOPYOTKoEO/77SVBPJKMY4LLKno
 rx6Uoif5UY0I481Cf4J7LjZojd5d7Z27xA==
X-Google-Smtp-Source: APXvYqxFJ34/oSdH/S5i+93ArtMiOMMVXAqVGOAhn7MUUD4MybopsyxmFCFjXn73+dxLMJ+cB0h+dg==
X-Received: by 2002:ac8:2a63:: with SMTP id l32mr76578088qtl.117.1560800818992; 
 Mon, 17 Jun 2019 12:46:58 -0700 (PDT)
Received: from localhost.localdomain ([71.219.5.136])
 by smtp.gmail.com with ESMTPSA id u4sm6559420qkb.16.2019.06.17.12.46.58
 (version=TLS1_3 cipher=AEAD-AES256-GCM-SHA384 bits=256/256);
 Mon, 17 Jun 2019 12:46:58 -0700 (PDT)
From: Alex Deucher <alexdeucher@gmail.com>
X-Google-Original-From: Alex Deucher <alexander.deucher@amd.com>
To: amd-gfx@lists.freedesktop.org
Subject: [PATCH 362/459] drm/amd/display: Clean up locking in
 dcn*_apply_ctx_for_surface()
Date: Mon, 17 Jun 2019 14:45:03 -0500
Message-Id: <20190617194540.18497-63-alexander.deucher@amd.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190617194540.18497-1-alexander.deucher@amd.com>
References: <20190617194540.18497-1-alexander.deucher@amd.com>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=gmail.com; s=20161025;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=QuzD39a6fCUPE1RlAatU45reE508fWhZ7uvbXGERsHE=;
 b=Rpu4JEkmpTiv5eZZg7gZVmFxEhqk+wGa5sIXQNiNio56MqUvPkHgPV1/mfsVIGMSyX
 jA+hef1etsZD2i3Y6JgckCP9NoRB7FpLqyJKtT4LxAFQkOrwFqJVSU/rIuRjzm47dHcO
 hS/rOw2xJWFftRQ6vlpq1wV6G6r6iqWy9i595VIknbtznu2A3RSam9F4aACuErxZmB1Z
 k0iL6L+kyk7zmk/V/CC5S1ACEzEp3/LRqrOStBYRQqXTOqgnNyCA3vK4RW970K8KqTiH
 EAXvnAgAIwHBWGVBbwFuliuOPg40q9RoZprFpAJ/t/hktjEy4k3GzezNOECPsbksLJSL
 ACHw==
X-BeenThere: amd-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Discussion list for AMD gfx <amd-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/amd-gfx>
List-Post: <mailto:amd-gfx@lists.freedesktop.org>
List-Help: <mailto:amd-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Leo Li <sunpeng.li@amd.com>, Alex Deucher <alexander.deucher@amd.com>,
 Hawking Zhang <Hawking.Zhang@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: amd-gfx-bounces@lists.freedesktop.org
Sender: "amd-gfx" <amd-gfx-bounces@lists.freedesktop.org>

RnJvbTogTGVvIExpIDxzdW5wZW5nLmxpQGFtZC5jb20+CgpbV2h5XQoKZGNuKl9kaXNhYmxlX3Bs
YW5lKCkgZG9lc24ndCB1bmxvY2sgdGhlIHBpcGUgYW55bW9yZSwgbWFraW5nIHRoZSBleHRyYQps
b2NrIHVubmVjZXNzYXJ5LgoKSW4gYWRkaXRpb24gLSBkdXJpbmcgZnVsbCBwbGFuZSB1cGRhdGVz
IC0gYWxsIG5lY2Vzc2FyeSBwaXBlcyBzaG91bGQgYmUKbG9ja2VkL3VubG9ja2VkIHRvZ2V0aGVy
IHdoZW4gbW9kaWZ5aW5nIGh1YnAgdG8gYXZvaWQgdGVhcmluZyBpbgpwaXBlc3BsaXQgc2V0dXBz
LgoKW0hvd10KClJlbW92ZSByZWR1bmRhbnQgbG9ja3MsIGFuZCBhZGQgZnVuY3Rpb24gdG8gbG9j
ayBhbGwgcGlwZXMuIElmIGFuCmludGVyZGVwZW5kZW50IHBpcGUgdXBkYXRlIGlzIHJlcXVpcmVk
LCBsb2NrIGRvd24gYWxsIHBpcGVzLiBPdGhlcndpc2UsCmxvY2sgb25seSB0aGUgdG9wIHBpcGUg
Zm9yIHRoZSB1cGRhdGVkIHBpcGUgdHJlZS4KClNpZ25lZC1vZmYtYnk6IExlbyBMaSA8c3VucGVu
Zy5saUBhbWQuY29tPgpBY2tlZC1ieTogSGF3a2luZyBaaGFuZyA8SGF3a2luZy5aaGFuZ0BhbWQu
Y29tPgpTaWduZWQtb2ZmLWJ5OiBBbGV4IERldWNoZXIgPGFsZXhhbmRlci5kZXVjaGVyQGFtZC5j
b20+Ci0tLQogLi4uL2FtZC9kaXNwbGF5L2RjL2RjbjEwL2RjbjEwX2h3X3NlcXVlbmNlci5jIHwg
MTEgKystLS0KIC4uLi9kcm0vYW1kL2Rpc3BsYXkvZGMvZGNuMjAvZGNuMjBfaHdzZXEuYyAgICB8
IDQ2ICsrKysrKystLS0tLS0tLS0tLS0KIDIgZmlsZXMgY2hhbmdlZCwgMjIgaW5zZXJ0aW9ucygr
KSwgMzUgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2FtZC9kaXNw
bGF5L2RjL2RjbjEwL2RjbjEwX2h3X3NlcXVlbmNlci5jIGIvZHJpdmVycy9ncHUvZHJtL2FtZC9k
aXNwbGF5L2RjL2RjbjEwL2RjbjEwX2h3X3NlcXVlbmNlci5jCmluZGV4IDcwNGRlNzM2OWU4Ni4u
YTJkM2M0ZmRjODA1IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vYW1kL2Rpc3BsYXkvZGMv
ZGNuMTAvZGNuMTBfaHdfc2VxdWVuY2VyLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2FtZC9kaXNw
bGF5L2RjL2RjbjEwL2RjbjEwX2h3X3NlcXVlbmNlci5jCkBAIC0yNDU2LDYgKzI0NTYsMTEgQEAg
c3RhdGljIHZvaWQgZGNuMTBfYXBwbHlfY3R4X2Zvcl9zdXJmYWNlKAogCWlmIChudW1fcGxhbmVz
ID4gMCkKIAkJcHJvZ3JhbV9hbGxfcGlwZV9pbl90cmVlKGRjLCB0b3BfcGlwZV90b19wcm9ncmFt
LCBjb250ZXh0KTsKIAorI2lmIGRlZmluZWQoQ09ORklHX0RSTV9BTURfRENfRENOMl8wKQorCS8q
IFByb2dyYW0gc2Vjb25kYXJ5IGJsZW5kaW5nIHRyZWUgYW5kIHdyaXRlYmFjayBwaXBlcyAqLwor
CWlmICgoc3RyZWFtLT5udW1fd2JfaW5mbyA+IDApICYmIChkYy0+aHdzcy5wcm9ncmFtX2FsbF93
cml0ZWJhY2tfcGlwZXNfaW5fdHJlZSkpCisJCWRjLT5od3NzLnByb2dyYW1fYWxsX3dyaXRlYmFj
a19waXBlc19pbl90cmVlKGRjLCBzdHJlYW0sIGNvbnRleHQpOworI2VuZGlmCiAJaWYgKGludGVy
ZGVwZW5kZW50X3VwZGF0ZSkKIAkJZm9yIChpID0gMDsgaSA8IGRjLT5yZXNfcG9vbC0+cGlwZV9j
b3VudDsgaSsrKSB7CiAJCQlzdHJ1Y3QgcGlwZV9jdHggKnBpcGVfY3R4ID0gJmNvbnRleHQtPnJl
c19jdHgucGlwZV9jdHhbaV07CkBAIC0yNDcwLDEyICsyNDc1LDYgQEAgc3RhdGljIHZvaWQgZGNu
MTBfYXBwbHlfY3R4X2Zvcl9zdXJmYWNlKAogCQkJCSZwaXBlX2N0eC0+dHR1X3JlZ3MpOwogCQl9
CiAKLSNpZiBkZWZpbmVkKENPTkZJR19EUk1fQU1EX0RDX0RDTjJfMCkKLQkvKiBQcm9ncmFtIHNl
Y29uZGFyeSBibGVuZGluZyB0cmVlIGFuZCB3cml0ZWJhY2sgcGlwZXMgKi8KLQlpZiAoKHN0cmVh
bS0+bnVtX3diX2luZm8gPiAwKSAmJiAoZGMtPmh3c3MucHJvZ3JhbV9hbGxfd3JpdGViYWNrX3Bp
cGVzX2luX3RyZWUpKQotCQlkYy0+aHdzcy5wcm9ncmFtX2FsbF93cml0ZWJhY2tfcGlwZXNfaW5f
dHJlZShkYywgc3RyZWFtLCBjb250ZXh0KTsKLSNlbmRpZgotCiAJaWYgKGludGVyZGVwZW5kZW50
X3VwZGF0ZSkKIAkJbG9ja19hbGxfcGlwZXMoZGMsIGNvbnRleHQsIGZhbHNlKTsKIAllbHNlCmRp
ZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vYW1kL2Rpc3BsYXkvZGMvZGNuMjAvZGNuMjBfaHdz
ZXEuYyBiL2RyaXZlcnMvZ3B1L2RybS9hbWQvZGlzcGxheS9kYy9kY24yMC9kY24yMF9od3NlcS5j
CmluZGV4IGYyZTVlNDkyODExOS4uY2NiOWYyNzc5MTFhIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dw
dS9kcm0vYW1kL2Rpc3BsYXkvZGMvZGNuMjAvZGNuMjBfaHdzZXEuYworKysgYi9kcml2ZXJzL2dw
dS9kcm0vYW1kL2Rpc3BsYXkvZGMvZGNuMjAvZGNuMjBfaHdzZXEuYwpAQCAtMTI3MCw4ICsxMjcw
LDYgQEAgc3RhdGljIHZvaWQgZGNuMjBfcGlwZV9jb250cm9sX2xvY2soCiAJfQogfQogCi0KLQog
c3RhdGljIHZvaWQgZGNuMjBfYXBwbHlfY3R4X2Zvcl9zdXJmYWNlKAogCQlzdHJ1Y3QgZGMgKmRj
LAogCQljb25zdCBzdHJ1Y3QgZGNfc3RyZWFtX3N0YXRlICpzdHJlYW0sCkBAIC0xMjgyLDYgKzEy
ODAsNyBAQCBzdGF0aWMgdm9pZCBkY24yMF9hcHBseV9jdHhfZm9yX3N1cmZhY2UoCiAJaW50IGk7
CiAJc3RydWN0IHRpbWluZ19nZW5lcmF0b3IgKnRnOwogCWJvb2wgcmVtb3ZlZF9waXBlWzZdID0g
eyBmYWxzZSB9OworCWJvb2wgaW50ZXJkZXBlbmRlbnRfdXBkYXRlID0gZmFsc2U7CiAJc3RydWN0
IHBpcGVfY3R4ICp0b3BfcGlwZV90b19wcm9ncmFtID0KIAkJCWZpbmRfdG9wX3BpcGVfZm9yX3N0
cmVhbShkYywgY29udGV4dCwgc3RyZWFtKTsKIAlEQ19MT0dHRVJfSU5JVChkYy0+Y3R4LT5sb2dn
ZXIpOwpAQCAtMTI5MSw3ICsxMjkwLDEzIEBAIHN0YXRpYyB2b2lkIGRjbjIwX2FwcGx5X2N0eF9m
b3Jfc3VyZmFjZSgKIAogCXRnID0gdG9wX3BpcGVfdG9fcHJvZ3JhbS0+c3RyZWFtX3Jlcy50ZzsK
IAotCWRjbjIwX3BpcGVfY29udHJvbF9sb2NrKGRjLCB0b3BfcGlwZV90b19wcm9ncmFtLCB0cnVl
KTsKKwlpbnRlcmRlcGVuZGVudF91cGRhdGUgPSB0b3BfcGlwZV90b19wcm9ncmFtLT5wbGFuZV9z
dGF0ZSAmJgorCQl0b3BfcGlwZV90b19wcm9ncmFtLT5wbGFuZV9zdGF0ZS0+dXBkYXRlX2ZsYWdz
LmJpdHMuZnVsbF91cGRhdGU7CisKKwlpZiAoaW50ZXJkZXBlbmRlbnRfdXBkYXRlKQorCQlsb2Nr
X2FsbF9waXBlcyhkYywgY29udGV4dCwgdHJ1ZSk7CisJZWxzZQorCQlkY24yMF9waXBlX2NvbnRy
b2xfbG9jayhkYywgdG9wX3BpcGVfdG9fcHJvZ3JhbSwgdHJ1ZSk7CiAKIAlpZiAobnVtX3BsYW5l
cyA9PSAwKSB7CiAJCS8qIE9URyBibGFuayBiZWZvcmUgcmVtb3ZlIGFsbCBmcm9udCBlbmQgKi8K
QEAgLTEzMTEsMTYgKzEzMTYsOSBAQCBzdGF0aWMgdm9pZCBkY24yMF9hcHBseV9jdHhfZm9yX3N1
cmZhY2UoCiAJCSAqLwogCQlpZiAocGlwZV9jdHgtPnBsYW5lX3N0YXRlICYmICFvbGRfcGlwZV9j
dHgtPnBsYW5lX3N0YXRlKSB7CiAJCQlpZiAob2xkX3BpcGVfY3R4LT5zdHJlYW1fcmVzLnRnID09
IHRnICYmCi0JCQkJb2xkX3BpcGVfY3R4LT5wbGFuZV9yZXMuaHVicCAmJgotCQkJCW9sZF9waXBl
X2N0eC0+cGxhbmVfcmVzLmh1YnAtPm9wcF9pZCAhPSAweGYpIHsKKwkJCSAgICBvbGRfcGlwZV9j
dHgtPnBsYW5lX3Jlcy5odWJwICYmCisJCQkgICAgb2xkX3BpcGVfY3R4LT5wbGFuZV9yZXMuaHVi
cC0+b3BwX2lkICE9IDB4ZikKIAkJCQlkY24yMF9kaXNhYmxlX3BsYW5lKGRjLCBvbGRfcGlwZV9j
dHgpOwotCi0JCQkJLyoKLQkJCQkgKiBwb3dlciBkb3duIGZlIHdpbGwgdW5sb2NrIHdoZW4gY2Fs
bGluZyByZXNldCwgbmVlZAotCQkJCSAqIHRvIGxvY2sgaXQgYmFjayBoZXJlLiBNZXNzeSwgbmVl
ZCByZXdvcmsuCi0JCQkJICovCi0JCQkJcGlwZV9jdHgtPnN0cmVhbV9yZXMudGctPmZ1bmNzLT5s
b2NrKHBpcGVfY3R4LT5zdHJlYW1fcmVzLnRnKTsKLQkJCX0KIAkJfQogCiAJCWlmICgoIXBpcGVf
Y3R4LT5wbGFuZV9zdGF0ZSB8fApAQCAtMTM0MywzNSArMTM0MSwyNSBAQCBzdGF0aWMgdm9pZCBk
Y24yMF9hcHBseV9jdHhfZm9yX3N1cmZhY2UoCiAJaWYgKChzdHJlYW0tPm51bV93Yl9pbmZvID4g
MCkgJiYgKGRjLT5od3NzLnByb2dyYW1fYWxsX3dyaXRlYmFja19waXBlc19pbl90cmVlKSkKIAkJ
ZGMtPmh3c3MucHJvZ3JhbV9hbGxfd3JpdGViYWNrX3BpcGVzX2luX3RyZWUoZGMsIHN0cmVhbSwg
Y29udGV4dCk7CiAKLQlkY24yMF9waXBlX2NvbnRyb2xfbG9jayhkYywgdG9wX3BpcGVfdG9fcHJv
Z3JhbSwgZmFsc2UpOwotCi0JaWYgKHRvcF9waXBlX3RvX3Byb2dyYW0tPnBsYW5lX3N0YXRlICYm
Ci0JCQl0b3BfcGlwZV90b19wcm9ncmFtLT5wbGFuZV9zdGF0ZS0+dXBkYXRlX2ZsYWdzLmJpdHMu
ZnVsbF91cGRhdGUpCisJaWYgKGludGVyZGVwZW5kZW50X3VwZGF0ZSkKIAkJZm9yIChpID0gMDsg
aSA8IGRjLT5yZXNfcG9vbC0+cGlwZV9jb3VudDsgaSsrKSB7CiAJCQlzdHJ1Y3QgcGlwZV9jdHgg
KnBpcGVfY3R4ID0gJmNvbnRleHQtPnJlc19jdHgucGlwZV9jdHhbaV07CiAKIAkJCS8qIFNraXAg
aW5hY3RpdmUgcGlwZXMgYW5kIG9uZXMgYWxyZWFkeSB1cGRhdGVkICovCi0JCQlpZiAoIXBpcGVf
Y3R4LT5zdHJlYW0gfHwgcGlwZV9jdHgtPnN0cmVhbSA9PSBzdHJlYW0KLQkJCQkJfHwgIXBpcGVf
Y3R4LT5wbGFuZV9zdGF0ZSkKKwkJCWlmICghcGlwZV9jdHgtPnN0cmVhbSB8fCBwaXBlX2N0eC0+
c3RyZWFtID09IHN0cmVhbSB8fAorCQkJICAgICFwaXBlX2N0eC0+cGxhbmVfc3RhdGUgfHwgIXRn
LT5mdW5jcy0+aXNfdGdfZW5hYmxlZCh0ZykpCiAJCQkJY29udGludWU7CiAKLQkJCXBpcGVfY3R4
LT5zdHJlYW1fcmVzLnRnLT5mdW5jcy0+bG9jayhwaXBlX2N0eC0+c3RyZWFtX3Jlcy50Zyk7Ci0K
IAkJCXBpcGVfY3R4LT5wbGFuZV9yZXMuaHVicC0+ZnVuY3MtPmh1YnBfc2V0dXBfaW50ZXJkZXBl
bmRlbnQoCiAJCQkJcGlwZV9jdHgtPnBsYW5lX3Jlcy5odWJwLAogCQkJCSZwaXBlX2N0eC0+ZGxn
X3JlZ3MsCiAJCQkJJnBpcGVfY3R4LT50dHVfcmVncyk7CiAJCX0KIAotCWZvciAoaSA9IDA7IGkg
PCBkYy0+cmVzX3Bvb2wtPnBpcGVfY291bnQ7IGkrKykgewotCQlzdHJ1Y3QgcGlwZV9jdHggKnBp
cGVfY3R4ID0gJmNvbnRleHQtPnJlc19jdHgucGlwZV9jdHhbaV07Ci0KLQkJaWYgKCFwaXBlX2N0
eC0+c3RyZWFtIHx8IHBpcGVfY3R4LT5zdHJlYW0gPT0gc3RyZWFtCi0JCQkJfHwgIXBpcGVfY3R4
LT5wbGFuZV9zdGF0ZSkKLQkJCWNvbnRpbnVlOwotCi0JCWRjbjIwX3BpcGVfY29udHJvbF9sb2Nr
KGRjLCBwaXBlX2N0eCwgZmFsc2UpOwotCX0KKwlpZiAoaW50ZXJkZXBlbmRlbnRfdXBkYXRlKQor
CQlsb2NrX2FsbF9waXBlcyhkYywgY29udGV4dCwgZmFsc2UpOworCWVsc2UKKwkJZGNuMjBfcGlw
ZV9jb250cm9sX2xvY2soZGMsIHRvcF9waXBlX3RvX3Byb2dyYW0sIGZhbHNlKTsKIAogCWZvciAo
aSA9IDA7IGkgPCBkYy0+cmVzX3Bvb2wtPnBpcGVfY291bnQ7IGkrKykKIAkJaWYgKHJlbW92ZWRf
cGlwZVtpXSkKLS0gCjIuMjAuMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX18KYW1kLWdmeCBtYWlsaW5nIGxpc3QKYW1kLWdmeEBsaXN0cy5mcmVlZGVza3Rv
cC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9hbWQt
Z2Z4
