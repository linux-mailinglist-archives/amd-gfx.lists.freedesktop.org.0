Return-Path: <amd-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+amd-gfx@lfdr.de
Delivered-To: lists+amd-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 7C40E59A6D
	for <lists+amd-gfx@lfdr.de>; Fri, 28 Jun 2019 14:18:23 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 085626E90D;
	Fri, 28 Jun 2019 12:18:22 +0000 (UTC)
X-Original-To: amd-gfx@lists.freedesktop.org
Delivered-To: amd-gfx@lists.freedesktop.org
Received: from mail-wm1-x341.google.com (mail-wm1-x341.google.com
 [IPv6:2a00:1450:4864:20::341])
 by gabe.freedesktop.org (Postfix) with ESMTPS id C3C2C6E90C
 for <amd-gfx@lists.freedesktop.org>; Fri, 28 Jun 2019 12:18:19 +0000 (UTC)
Received: by mail-wm1-x341.google.com with SMTP id 207so8903869wma.1
 for <amd-gfx@lists.freedesktop.org>; Fri, 28 Jun 2019 05:18:19 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=ybAQCbRCvqoP89C6asdDvXZl5HhIIm07fpreK4fhtjo=;
 b=np17olrSZKaDAV/q3MGxErCOBnBaPMkDdGDCxRQTUkcCOFf7y/8Mhynl6VTbfl482H
 NSlYe0lU1fscNYhclWn5OYKifCW90b2zP3wL2TcrZy2ZHJJT7/bv4elR2IKmigG6oTrz
 LmmLmFqEIcxrbFIyV2hMY0bbyJZoAOhhpKLqBy8XR8FkWcntTQ7+QwyFqv09BZqk7qij
 T/ml1cgJR/MV3NcZ0rkk5xFSb+KTx4LK3dMrr0aMg3fGarAmAnD0+608z3B6HsWJkZaV
 DgqhNCZCyMcGMLoqIZ44J8KaxqrAFWWnMlG/qkmXRZ3yF0u25HLVsCPj1pN0Suox+sW9
 spJw==
X-Gm-Message-State: APjAAAWlWw1S66N1mxJtBmMkeA++CipVYwkS4fzTTynwFeNGTxMD1Kub
 AJtNQbX2qAD4E/hYJf5FMyb3Sp7y
X-Google-Smtp-Source: APXvYqziiXCmOYuC1I01unecKfY6unR93xr1I6WbQSEBO3EGOa4oenMxLgO2+qFlHytzpwY/VIix/w==
X-Received: by 2002:a1c:5f87:: with SMTP id t129mr7585257wmb.150.1561724298326; 
 Fri, 28 Jun 2019 05:18:18 -0700 (PDT)
Received: from abel.fritz.box ([2a02:908:1252:fb60:6946:7a72:691a:cf7d])
 by smtp.gmail.com with ESMTPSA id a64sm7236740wmf.1.2019.06.28.05.18.17
 (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
 Fri, 28 Jun 2019 05:18:17 -0700 (PDT)
From: "=?UTF-8?q?Christian=20K=C3=B6nig?=" <ckoenig.leichtzumerken@gmail.com>
X-Google-Original-From: =?UTF-8?q?Christian=20K=C3=B6nig?=
 <christian.koenig@amd.com>
To: amd-gfx@lists.freedesktop.org
Subject: [PATCH 5/5] drm/amdgpu: add graceful VM fault handling
Date: Fri, 28 Jun 2019 14:18:12 +0200
Message-Id: <20190628121812.1400-5-christian.koenig@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190628121812.1400-1-christian.koenig@amd.com>
References: <20190628121812.1400-1-christian.koenig@amd.com>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=gmail.com; s=20161025;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=ybAQCbRCvqoP89C6asdDvXZl5HhIIm07fpreK4fhtjo=;
 b=JqlBN7bJH5Xg5efOO6Jq6jDUHUrnBiGil3xnVAfbAZESx3ed7pju+Y+g06q4QovmPF
 9luYdUR5ClIXmCmwWElnAqFrIDeH86zfOdMwAiHaLEPOakgDLNSCV/V5/lLDLhIuu5mV
 XmeukqPer0ByI0sP0HJWBEswL68pbgLGkfvCbBX4UlTGW4HS4RgZieMd1swM+DzYo9QW
 Mvtvi02/LqeS3cUbZEj+YeYNqoPIEf2XLX+rqdSTpV3LA6wHp/M/QqLxfm8wGE+mD/bD
 crUD1EJcMcHom4z+5SsyVg3VDZc4bZn5GIJhu52vSkgX8GvBkTLAMOcpgNNwAeQpixS6
 vcYQ==
X-BeenThere: amd-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Discussion list for AMD gfx <amd-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/amd-gfx>
List-Post: <mailto:amd-gfx@lists.freedesktop.org>
List-Help: <mailto:amd-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=subscribe>
Cc: Felix.Kuehling@amd.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: amd-gfx-bounces@lists.freedesktop.org
Sender: "amd-gfx" <amd-gfx-bounces@lists.freedesktop.org>

TmV4dCBzdGVwIHRvd2FyZHMgSE1NIHN1cHBvcnQuIEZvciBub3cganVzdCBzaWxlbmNlIHRoZSBy
ZXRyeSBmYXVsdCBhbmQKb3B0aW9uYWxseSByZWRpcmVjdCB0aGUgcmVxdWVzdCB0byB0aGUgZHVt
bXkgcGFnZS4KClNpZ25lZC1vZmYtYnk6IENocmlzdGlhbiBLw7ZuaWcgPGNocmlzdGlhbi5rb2Vu
aWdAYW1kLmNvbT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdm0uYyB8
IDU5ICsrKysrKysrKysrKysrKysrKysrKysrKysrCiBkcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdw
dS9hbWRncHVfdm0uaCB8ICAyICsKIGRyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2dtY192OV8w
LmMgIHwgIDQgKysKIDMgZmlsZXMgY2hhbmdlZCwgNjUgaW5zZXJ0aW9ucygrKQoKZGlmZiAtLWdp
dCBhL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV92bS5jIGIvZHJpdmVycy9ncHUv
ZHJtL2FtZC9hbWRncHUvYW1kZ3B1X3ZtLmMKaW5kZXggYTJkMThmZTQ2NjkxLi42ZjhjN2NjMDdl
OGIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV92bS5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV92bS5jCkBAIC0zMTIyLDMgKzMx
MjIsNjIgQEAgdm9pZCBhbWRncHVfdm1fc2V0X3Rhc2tfaW5mbyhzdHJ1Y3QgYW1kZ3B1X3ZtICp2
bSkKIAkJfQogCX0KIH0KKworLyoqCisgKiBhbWRncHVfdm1faGFuZGxlX2ZhdWx0IC0gZ3JhY2Vm
dWwgaGFuZGxpbmcgb2YgVk0gZmF1bHRzLgorICogQGFkZXY6IGFtZGdwdSBkZXZpY2UgcG9pbnRl
cgorICogQHBhc2lkOiBQQVNJRCBvZiB0aGUgVk0KKyAqIEBhZGRyOiBBZGRyZXNzIG9mIHRoZSBm
YXVsdAorICoKKyAqIFRyeSB0byBncmFjZWZ1bGx5IGhhbmRsZSBhIFZNIGZhdWx0LiBSZXR1cm4g
dHJ1ZSBpZiB0aGUgZmF1bHQgd2FzIGhhbmRsZWQgYW5kCisgKiBzaG91bGRuJ3QgYmUgcmVwb3J0
ZWQgYW55IG1vcmUuCisgKi8KK2Jvb2wgYW1kZ3B1X3ZtX2hhbmRsZV9mYXVsdChzdHJ1Y3QgYW1k
Z3B1X2RldmljZSAqYWRldiwgdW5zaWduZWQgaW50IHBhc2lkLAorCQkJICAgIHVpbnQ2NF90IGFk
ZHIpCit7CisJc3RydWN0IGFtZGdwdV9yaW5nICpyaW5nID0gJmFkZXYtPnNkbWEuaW5zdGFuY2Vb
MF0ucGFnZTsKKwl1aW50NjRfdCB2YWx1ZSwgZmxhZ3M7CisJc3RydWN0IGFtZGdwdV92bSAqdm07
CisJbG9uZyByOworCisJaWYgKCFyaW5nLT5zY2hlZC5yZWFkeSkKKwkJcmV0dXJuIGZhbHNlOwor
CisJc3Bpbl9sb2NrKCZhZGV2LT52bV9tYW5hZ2VyLnBhc2lkX2xvY2spOworCXZtID0gaWRyX2Zp
bmQoJmFkZXYtPnZtX21hbmFnZXIucGFzaWRfaWRyLCBwYXNpZCk7CisJc3Bpbl91bmxvY2soJmFk
ZXYtPnZtX21hbmFnZXIucGFzaWRfbG9jayk7CisKKwlpZiAoIXZtKQorCQlyZXR1cm4gZmFsc2U7
CisKKwlyID0gYW1kZ3B1X2JvX3Jlc2VydmUodm0tPnJvb3QuYmFzZS5ibywgdHJ1ZSk7CisJaWYg
KHIpCisJCXJldHVybiBmYWxzZTsKKworCWFkZHIgLz0gQU1ER1BVX0dQVV9QQUdFX1NJWkU7CisJ
ZmxhZ3MgPSBBTURHUFVfUFRFX1ZBTElEIHwgQU1ER1BVX1BURV9TTk9PUEVEIHwKKwkJQU1ER1BV
X1BURV9TWVNURU07CisKKwlpZiAoYW1kZ3B1X3ZtX2ZhdWx0X3N0b3AgPT0gQU1ER1BVX1ZNX0ZB
VUxUX1NUT1BfTkVWRVIpIHsKKwkJLyogUmVkaXJlY3QgdGhlIGFjY2VzcyB0byB0aGUgZHVtbXkg
cGFnZSAqLworCQl2YWx1ZSA9IGFkZXYtPmR1bW15X3BhZ2VfYWRkcjsKKwkJZmxhZ3MgfD0gQU1E
R1BVX1BURV9FWEVDVVRBQkxFIHwgQU1ER1BVX1BURV9SRUFEQUJMRSB8CisJCQlBTURHUFVfUFRF
X1dSSVRFQUJMRTsKKwl9IGVsc2UgeworCQl2YWx1ZSA9IDA7CisJfQorCisJciA9IGFtZGdwdV92
bV9ib191cGRhdGVfbWFwcGluZyhhZGV2LCB2bSwgdHJ1ZSwgTlVMTCwgYWRkciwgYWRkciArIDEs
CisJCQkJCWZsYWdzLCB2YWx1ZSwgTlVMTCwgTlVMTCk7CisJaWYgKHIpCisJCWdvdG8gZXJyb3I7
CisKKwlyID0gYW1kZ3B1X3ZtX3VwZGF0ZV9wZGVzKGFkZXYsIHZtLCB0cnVlKTsKKworZXJyb3I6
CisJYW1kZ3B1X2JvX3VucmVzZXJ2ZSh2bS0+cm9vdC5iYXNlLmJvKTsKKwlpZiAociA8IDApCisJ
CURSTV9FUlJPUigiQ2FuJ3QgaGFuZGxlIHBhZ2UgZmF1bHQgKCVsZClcbiIsIHIpOworCisJcmV0
dXJuIGZhbHNlOworfQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1k
Z3B1X3ZtLmggYi9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfdm0uaAppbmRleCA3
MjI3YzhkYTFhMmEuLmQwYTMwNjE0ZjcwYSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2Ft
ZC9hbWRncHUvYW1kZ3B1X3ZtLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1k
Z3B1X3ZtLmgKQEAgLTQwOCw2ICs0MDgsOCBAQCB2b2lkIGFtZGdwdV92bV9jaGVja19jb21wdXRl
X2J1ZyhzdHJ1Y3QgYW1kZ3B1X2RldmljZSAqYWRldik7CiAKIHZvaWQgYW1kZ3B1X3ZtX2dldF90
YXNrX2luZm8oc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYsIHVuc2lnbmVkIGludCBwYXNpZCwK
IAkJCSAgICAgc3RydWN0IGFtZGdwdV90YXNrX2luZm8gKnRhc2tfaW5mbyk7Citib29sIGFtZGdw
dV92bV9oYW5kbGVfZmF1bHQoc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYsIHVuc2lnbmVkIGlu
dCBwYXNpZCwKKwkJCSAgICB1aW50NjRfdCBhZGRyKTsKIAogdm9pZCBhbWRncHVfdm1fc2V0X3Rh
c2tfaW5mbyhzdHJ1Y3QgYW1kZ3B1X3ZtICp2bSk7CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1
L2RybS9hbWQvYW1kZ3B1L2dtY192OV8wLmMgYi9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9n
bWNfdjlfMC5jCmluZGV4IGJkNWQzNjk0NDQ4MS4uZmFmNmQ2NGNkNGQ1IDEwMDY0NAotLS0gYS9k
cml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9nbWNfdjlfMC5jCisrKyBiL2RyaXZlcnMvZ3B1L2Ry
bS9hbWQvYW1kZ3B1L2dtY192OV8wLmMKQEAgLTMyNCw2ICszMjQsMTAgQEAgc3RhdGljIGludCBn
bWNfdjlfMF9wcm9jZXNzX2ludGVycnVwdChzdHJ1Y3QgYW1kZ3B1X2RldmljZSAqYWRldiwKIAkJ
cmV0dXJuIDE7IC8qIFRoaXMgYWxzbyBwcmV2ZW50cyBzZW5kaW5nIGl0IHRvIEtGRCAqLwogCiAJ
LyogSWYgaXQncyB0aGUgZmlyc3QgZmF1bHQgZm9yIHRoaXMgYWRkcmVzcywgcHJvY2VzcyBpdCBu
b3JtYWxseSAqLworCWlmIChyZXRyeV9mYXVsdCAmJiAhaW5faW50ZXJydXB0KCkgJiYKKwkgICAg
YW1kZ3B1X3ZtX2hhbmRsZV9mYXVsdChhZGV2LCBlbnRyeS0+cGFzaWQsIGFkZHIpKQorCQlyZXR1
cm4gMTsgLyogVGhpcyBhbHNvIHByZXZlbnRzIHNlbmRpbmcgaXQgdG8gS0ZEICovCisKIAlpZiAo
IWFtZGdwdV9zcmlvdl92ZihhZGV2KSkgewogCQlzdGF0dXMgPSBSUkVHMzIoaHViLT52bV9sMl9w
cm9fZmF1bHRfc3RhdHVzKTsKIAkJV1JFRzMyX1AoaHViLT52bV9sMl9wcm9fZmF1bHRfY250bCwg
MSwgfjEpOwotLSAKMi4xNy4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fXwphbWQtZ2Z4IG1haWxpbmcgbGlzdAphbWQtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9w
Lm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2FtZC1n
Zng=
