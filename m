Return-Path: <amd-gfx-bounces@lists.freedesktop.org>
X-Original-To: lists+amd-gfx@lfdr.de
Delivered-To: lists+amd-gfx@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id BE5BC3A41A0
	for <lists+amd-gfx@lfdr.de>; Fri, 11 Jun 2021 14:03:16 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id A48736EE83;
	Fri, 11 Jun 2021 12:03:08 +0000 (UTC)
X-Original-To: amd-gfx@lists.freedesktop.org
Delivered-To: amd-gfx@lists.freedesktop.org
Received: from mail-wr1-x433.google.com (mail-wr1-x433.google.com
 [IPv6:2a00:1450:4864:20::433])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 600FB6EE7C;
 Fri, 11 Jun 2021 12:03:06 +0000 (UTC)
Received: by mail-wr1-x433.google.com with SMTP id c5so5785668wrq.9;
 Fri, 11 Jun 2021 05:03:06 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20161025;
 h=from:to:subject:date:message-id:in-reply-to:references:mime-version
 :content-transfer-encoding;
 bh=lkb4x0bvKS7imUzZ0hpkBXdVk5542llOEX4h/3gxyV0=;
 b=N2BQw+aVpgUUDmkkmXCZ4/Sh2S4yJYjQ7yrL6k1Glickl6xN6Y4FKewoMKyN4yy5gE
 GTuM062oH/HTruaO6t20s736wCBMLSoHDFQk8w/UwsMQgFVR5e21/9DhIXEZ+KrdbJb3
 fkx+n31cGXq0+dgNZsgIJAQsgQG9WUaLa17zw7QhyTrNtHz5OHSI+Iuhq9R3iqUcJnS9
 UlpYv/dqevqxrEH1s3KXZOATrAFyhOp2aLQBDzPDHQ1KWd+8ds+OG8dinRtWBTKUTxob
 hz+c/CiHaVsFaLrlPfyVGStf2Qs3rMutpevT9EgR1gjAaVccAitdj4O37vCYMC9LcUDz
 YL6g==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=lkb4x0bvKS7imUzZ0hpkBXdVk5542llOEX4h/3gxyV0=;
 b=dpUE8arV6/mHt/lg4zaPXe2fRTpec4lLH5Xkvf8St7kLu+myn6Upy9NxRxQEdDFVkp
 IMvD2WSPA3kRDzm33IT5gKhPs7to7qYUfq1IiWzgfddlMgKfUWuKeNJS06clQ/aUU/8G
 WPpiPwXBIu1ffsVc7UhlssI7B/dXVwN+fv/qwaHsZwlQzZ99zkoML6BE41yZiu4SSvuZ
 fvsolAsxbANblHTecfXVzr3IalN7tG0oP4BzDtWZUpl0IVlDH4Qr5QBMXkSEJ8faiYnS
 1YRi1Vf0VMSIX1wPaFhLD/2Y+wWU1SKgwRE2sQDooz5G+MS+sJX60lV99Sk3JGY26GuH
 AXRA==
X-Gm-Message-State: AOAM530G3IFB3ygy/OFv1YeacehiV0XkDlUSMBszhkcgR9tlr4K1qQ0W
 stq1uYnRX4MPdq9BTfSzEiA=
X-Google-Smtp-Source: ABdhPJzEnDRUUB7YL8RCziRtRgTH0F4qkiHbbEnV+sy+w6DGYV4PAtYArWXcL8e0aBxKmha00roQrw==
X-Received: by 2002:adf:b650:: with SMTP id i16mr3668606wre.205.1623412985010; 
 Fri, 11 Jun 2021 05:03:05 -0700 (PDT)
Received: from abel.fritz.box ([2a02:908:1252:fb60:657d:4ae8:def3:d96a])
 by smtp.gmail.com with ESMTPSA id f13sm6898361wrt.86.2021.06.11.05.03.04
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Fri, 11 Jun 2021 05:03:04 -0700 (PDT)
From: "=?UTF-8?q?Christian=20K=C3=B6nig?=" <ckoenig.leichtzumerken@gmail.com>
X-Google-Original-From: =?UTF-8?q?Christian=20K=C3=B6nig?=
 <christian.koenig@amd.com>
To: daniel@ffwll.ch, dri-devel@lists.freedesktop.org,
 amd-gfx@lists.freedesktop.org
Subject: [PATCH 5/5] drm/amdgpu: rework dma_resv handling v2
Date: Fri, 11 Jun 2021 14:03:01 +0200
Message-Id: <20210611120301.10595-5-christian.koenig@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210611120301.10595-1-christian.koenig@amd.com>
References: <20210611120301.10595-1-christian.koenig@amd.com>
MIME-Version: 1.0
X-BeenThere: amd-gfx@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Discussion list for AMD gfx <amd-gfx.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/amd-gfx>
List-Post: <mailto:amd-gfx@lists.freedesktop.org>
List-Help: <mailto:amd-gfx-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/amd-gfx>,
 <mailto:amd-gfx-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: amd-gfx-bounces@lists.freedesktop.org
Sender: "amd-gfx" <amd-gfx-bounces@lists.freedesktop.org>

RHJvcCB0aGUgd29ya2Fyb3VuZCBhbmQgaW5zdGVhZCBpbXBsZW1lbnQgYSBiZXR0ZXIgc29sdXRp
b24uCgpCYXNpY2FsbHkgd2UgYXJlIG5vdyBjaGFpbmluZyBhbGwgc3VibWlzc2lvbnMgdXNpbmcg
YSBkbWFfZmVuY2VfY2hhaW4KY29udGFpbmVyIGFuZCBhZGRpbmcgdGhlbSBhcyBleGNsdXNpdmUg
ZmVuY2UgdG8gdGhlIGRtYV9yZXN2IG9iamVjdC4KClRoaXMgd2F5IG90aGVyIGRyaXZlcnMgY2Fu
IHN0aWxsIHN5bmMgdG8gdGhlIHNpbmdsZSBleGNsdXNpdmUgZmVuY2UKd2hpbGUgYW1kZ3B1IG9u
bHkgc3luYyB0byBmZW5jZXMgZnJvbSBkaWZmZXJlbnQgcHJvY2Vzc2VzLgoKdjI6IHBvbGlzaCBr
ZXJuZWxkb2MgYSBiaXQKClNpZ25lZC1vZmYtYnk6IENocmlzdGlhbiBLw7ZuaWcgPGNocmlzdGlh
bi5rb2VuaWdAYW1kLmNvbT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVf
Ym9fbGlzdC5oIHwgIDEgKwogZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X2NzLmMg
ICAgICB8IDU0ICsrKysrKysrKysrKystLS0tCiBkcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9h
bWRncHVfZG1hX2J1Zi5jIHwgNjUgLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiBkcml2ZXJzL2dwdS9k
cm0vYW1kL2FtZGdwdS9hbWRncHVfZ2VtLmMgICAgIHwgIDMgKy0KIGRyaXZlcnMvZ3B1L2RybS9h
bWQvYW1kZ3B1L2FtZGdwdV9vYmplY3QuYyAgfCAgMiArLQogZHJpdmVycy9ncHUvZHJtL2FtZC9h
bWRncHUvYW1kZ3B1X29iamVjdC5oICB8ICAxIC0KIDYgZmlsZXMgY2hhbmdlZCwgNDcgaW5zZXJ0
aW9ucygrKSwgNzkgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2Ft
ZC9hbWRncHUvYW1kZ3B1X2JvX2xpc3QuaCBiL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2Ft
ZGdwdV9ib19saXN0LmgKaW5kZXggYTEzMGU3NjZjYmRiLi5jOTA1YTRjZmMxNzMgMTAwNjQ0Ci0t
LSBhL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV9ib19saXN0LmgKKysrIGIvZHJp
dmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X2JvX2xpc3QuaApAQCAtMzQsNiArMzQsNyBA
QCBzdHJ1Y3QgYW1kZ3B1X2Zwcml2Owogc3RydWN0IGFtZGdwdV9ib19saXN0X2VudHJ5IHsKIAlz
dHJ1Y3QgdHRtX3ZhbGlkYXRlX2J1ZmZlcgl0djsKIAlzdHJ1Y3QgYW1kZ3B1X2JvX3ZhCQkqYm9f
dmE7CisJc3RydWN0IGRtYV9mZW5jZV9jaGFpbgkJKmNoYWluOwogCXVpbnQzMl90CQkJcHJpb3Jp
dHk7CiAJc3RydWN0IHBhZ2UJCQkqKnVzZXJfcGFnZXM7CiAJYm9vbAkJCQl1c2VyX2ludmFsaWRh
dGVkOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X2NzLmMg
Yi9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfY3MuYwppbmRleCAzMjVlODI2MjE0
NjcuLmY2ZjMwMjlmOTU4ZCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUv
YW1kZ3B1X2NzLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X2NzLmMK
QEAgLTU4Nyw2ICs1ODcsMjAgQEAgc3RhdGljIGludCBhbWRncHVfY3NfcGFyc2VyX2JvcyhzdHJ1
Y3QgYW1kZ3B1X2NzX3BhcnNlciAqcCwKIAkJZ290byBvdXQ7CiAJfQogCisJYW1kZ3B1X2JvX2xp
c3RfZm9yX2VhY2hfZW50cnkoZSwgcC0+Ym9fbGlzdCkgeworCQlzdHJ1Y3QgYW1kZ3B1X2JvICpi
byA9IHR0bV90b19hbWRncHVfYm8oZS0+dHYuYm8pOworCisJCWUtPmJvX3ZhID0gYW1kZ3B1X3Zt
X2JvX2ZpbmQodm0sIGJvKTsKKworCQlpZiAoYm8tPnRiby5iYXNlLmRtYV9idWYgJiYgIWFtZGdw
dV9ib19leHBsaWNpdF9zeW5jKGJvKSkgeworCQkJZS0+Y2hhaW4gPSBkbWFfZmVuY2VfY2hhaW5f
YWxsb2MoKTsKKwkJCWlmICghZS0+Y2hhaW4pIHsKKwkJCQlyID0gLUVOT01FTTsKKwkJCQlnb3Rv
IGVycm9yX3ZhbGlkYXRlOworCQkJfQorCQl9CisJfQorCiAJYW1kZ3B1X2NzX2dldF90aHJlc2hv
bGRfZm9yX21vdmVzKHAtPmFkZXYsICZwLT5ieXRlc19tb3ZlZF90aHJlc2hvbGQsCiAJCQkJCSAg
JnAtPmJ5dGVzX21vdmVkX3Zpc190aHJlc2hvbGQpOwogCXAtPmJ5dGVzX21vdmVkID0gMDsKQEAg
LTYxNCwxNSArNjI4LDYgQEAgc3RhdGljIGludCBhbWRncHVfY3NfcGFyc2VyX2JvcyhzdHJ1Y3Qg
YW1kZ3B1X2NzX3BhcnNlciAqcCwKIAlnd3MgPSBwLT5ib19saXN0LT5nd3Nfb2JqOwogCW9hID0g
cC0+Ym9fbGlzdC0+b2Ffb2JqOwogCi0JYW1kZ3B1X2JvX2xpc3RfZm9yX2VhY2hfZW50cnkoZSwg
cC0+Ym9fbGlzdCkgewotCQlzdHJ1Y3QgYW1kZ3B1X2JvICpibyA9IHR0bV90b19hbWRncHVfYm8o
ZS0+dHYuYm8pOwotCi0JCS8qIE1ha2Ugc3VyZSB3ZSB1c2UgdGhlIGV4Y2x1c2l2ZSBzbG90IGZv
ciBzaGFyZWQgQk9zICovCi0JCWlmIChiby0+cHJpbWVfc2hhcmVkX2NvdW50KQotCQkJZS0+dHYu
bnVtX3NoYXJlZCA9IDA7Ci0JCWUtPmJvX3ZhID0gYW1kZ3B1X3ZtX2JvX2ZpbmQodm0sIGJvKTsK
LQl9Ci0KIAlpZiAoZ2RzKSB7CiAJCXAtPmpvYi0+Z2RzX2Jhc2UgPSBhbWRncHVfYm9fZ3B1X29m
ZnNldChnZHMpID4+IFBBR0VfU0hJRlQ7CiAJCXAtPmpvYi0+Z2RzX3NpemUgPSBhbWRncHVfYm9f
c2l6ZShnZHMpID4+IFBBR0VfU0hJRlQ7CkBAIC02NDQsOCArNjQ5LDEzIEBAIHN0YXRpYyBpbnQg
YW1kZ3B1X2NzX3BhcnNlcl9ib3Moc3RydWN0IGFtZGdwdV9jc19wYXJzZXIgKnAsCiAJfQogCiBl
cnJvcl92YWxpZGF0ZToKLQlpZiAocikKKwlpZiAocikgeworCQlhbWRncHVfYm9fbGlzdF9mb3Jf
ZWFjaF9lbnRyeShlLCBwLT5ib19saXN0KSB7CisJCQlkbWFfZmVuY2VfY2hhaW5fZnJlZShlLT5j
aGFpbik7CisJCQllLT5jaGFpbiA9IE5VTEw7CisJCX0KIAkJdHRtX2V1X2JhY2tvZmZfcmVzZXJ2
YXRpb24oJnAtPnRpY2tldCwgJnAtPnZhbGlkYXRlZCk7CisJfQogb3V0OgogCXJldHVybiByOwog
fQpAQCAtNjg1LDkgKzY5NSwxNyBAQCBzdGF0aWMgdm9pZCBhbWRncHVfY3NfcGFyc2VyX2Zpbmko
c3RydWN0IGFtZGdwdV9jc19wYXJzZXIgKnBhcnNlciwgaW50IGVycm9yLAogewogCXVuc2lnbmVk
IGk7CiAKLQlpZiAoZXJyb3IgJiYgYmFja29mZikKKwlpZiAoZXJyb3IgJiYgYmFja29mZikgewor
CQlzdHJ1Y3QgYW1kZ3B1X2JvX2xpc3RfZW50cnkgKmU7CisKKwkJYW1kZ3B1X2JvX2xpc3RfZm9y
X2VhY2hfZW50cnkoZSwgcGFyc2VyLT5ib19saXN0KSB7CisJCQlkbWFfZmVuY2VfY2hhaW5fZnJl
ZShlLT5jaGFpbik7CisJCQllLT5jaGFpbiA9IE5VTEw7CisJCX0KKwogCQl0dG1fZXVfYmFja29m
Zl9yZXNlcnZhdGlvbigmcGFyc2VyLT50aWNrZXQsCiAJCQkJCSAgICZwYXJzZXItPnZhbGlkYXRl
ZCk7CisJfQogCiAJZm9yIChpID0gMDsgaSA8IHBhcnNlci0+bnVtX3Bvc3RfZGVwczsgaSsrKSB7
CiAJCWRybV9zeW5jb2JqX3B1dChwYXJzZXItPnBvc3RfZGVwc1tpXS5zeW5jb2JqKTsKQEAgLTEy
NjAsNiArMTI3OCwyMCBAQCBzdGF0aWMgaW50IGFtZGdwdV9jc19zdWJtaXQoc3RydWN0IGFtZGdw
dV9jc19wYXJzZXIgKnAsCiAKIAlhbWRncHVfdm1fbW92ZV90b19scnVfdGFpbChwLT5hZGV2LCAm
ZnByaXYtPnZtKTsKIAorCWFtZGdwdV9ib19saXN0X2Zvcl9lYWNoX2VudHJ5KGUsIHAtPmJvX2xp
c3QpIHsKKwkJc3RydWN0IGRtYV9yZXN2ICpyZXN2ID0gZS0+dHYuYm8tPmJhc2UucmVzdjsKKwkJ
c3RydWN0IGRtYV9mZW5jZV9jaGFpbiAqY2hhaW4gPSBlLT5jaGFpbjsKKworCQlpZiAoIWNoYWlu
KQorCQkJY29udGludWU7CisKKwkJZG1hX2ZlbmNlX2NoYWluX2luaXQoY2hhaW4sIGRtYV9yZXN2
X2V4Y2xfZmVuY2UocmVzdiksCisJCQkJICAgICBkbWFfZmVuY2VfZ2V0KHAtPmZlbmNlKSwgMSk7
CisKKwkJcmN1X2Fzc2lnbl9wb2ludGVyKHJlc3YtPmZlbmNlX2V4Y2wsICZjaGFpbi0+YmFzZSk7
CisJCWUtPmNoYWluID0gTlVMTDsKKwl9CisKIAl0dG1fZXVfZmVuY2VfYnVmZmVyX29iamVjdHMo
JnAtPnRpY2tldCwgJnAtPnZhbGlkYXRlZCwgcC0+ZmVuY2UpOwogCW11dGV4X3VubG9jaygmcC0+
YWRldi0+bm90aWZpZXJfbG9jayk7CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9hbWQv
YW1kZ3B1L2FtZGdwdV9kbWFfYnVmLmMgYi9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRn
cHVfZG1hX2J1Zi5jCmluZGV4IGMzMDUzYjgzYjgwYy4uMjMyMTlmYzNiMjhjIDEwMDY0NAotLS0g
YS9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfZG1hX2J1Zi5jCisrKyBiL2RyaXZl
cnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV9kbWFfYnVmLmMKQEAgLTQyLDQ4ICs0Miw2IEBA
CiAjaW5jbHVkZSA8bGludXgvcGNpLXAycGRtYS5oPgogI2luY2x1ZGUgPGxpbnV4L3BtX3J1bnRp
bWUuaD4KIAotc3RhdGljIGludAotX19kbWFfcmVzdl9tYWtlX2V4Y2x1c2l2ZShzdHJ1Y3QgZG1h
X3Jlc3YgKm9iaikKLXsKLQlzdHJ1Y3QgZG1hX2ZlbmNlICoqZmVuY2VzOwotCXVuc2lnbmVkIGlu
dCBjb3VudDsKLQlpbnQgcjsKLQotCWlmICghZG1hX3Jlc3Zfc2hhcmVkX2xpc3Qob2JqKSkgLyog
bm8gc2hhcmVkIGZlbmNlcyB0byBjb252ZXJ0ICovCi0JCXJldHVybiAwOwotCi0JciA9IGRtYV9y
ZXN2X2dldF9mZW5jZXMob2JqLCBOVUxMLCAmY291bnQsICZmZW5jZXMpOwotCWlmIChyKQotCQly
ZXR1cm4gcjsKLQotCWlmIChjb3VudCA9PSAwKSB7Ci0JCS8qIE5vdyB0aGF0IHdhcyB1bmV4cGVj
dGVkLiAqLwotCX0gZWxzZSBpZiAoY291bnQgPT0gMSkgewotCQlkbWFfcmVzdl9hZGRfZXhjbF9m
ZW5jZShvYmosIGZlbmNlc1swXSk7Ci0JCWRtYV9mZW5jZV9wdXQoZmVuY2VzWzBdKTsKLQkJa2Zy
ZWUoZmVuY2VzKTsKLQl9IGVsc2UgewotCQlzdHJ1Y3QgZG1hX2ZlbmNlX2FycmF5ICphcnJheTsK
LQotCQlhcnJheSA9IGRtYV9mZW5jZV9hcnJheV9jcmVhdGUoY291bnQsIGZlbmNlcywKLQkJCQkJ
ICAgICAgIGRtYV9mZW5jZV9jb250ZXh0X2FsbG9jKDEpLCAwLAotCQkJCQkgICAgICAgZmFsc2Up
OwotCQlpZiAoIWFycmF5KQotCQkJZ290byBlcnJfZmVuY2VzX3B1dDsKLQotCQlkbWFfcmVzdl9h
ZGRfZXhjbF9mZW5jZShvYmosICZhcnJheS0+YmFzZSk7Ci0JCWRtYV9mZW5jZV9wdXQoJmFycmF5
LT5iYXNlKTsKLQl9Ci0KLQlyZXR1cm4gMDsKLQotZXJyX2ZlbmNlc19wdXQ6Ci0Jd2hpbGUgKGNv
dW50LS0pCi0JCWRtYV9mZW5jZV9wdXQoZmVuY2VzW2NvdW50XSk7Ci0Ja2ZyZWUoZmVuY2VzKTsK
LQlyZXR1cm4gLUVOT01FTTsKLX0KLQogLyoqCiAgKiBhbWRncHVfZG1hX2J1Zl9hdHRhY2ggLSAm
ZG1hX2J1Zl9vcHMuYXR0YWNoIGltcGxlbWVudGF0aW9uCiAgKgpAQCAtMTEwLDI0ICs2OCw2IEBA
IHN0YXRpYyBpbnQgYW1kZ3B1X2RtYV9idWZfYXR0YWNoKHN0cnVjdCBkbWFfYnVmICpkbWFidWYs
CiAJaWYgKHIgPCAwKQogCQlnb3RvIG91dDsKIAotCXIgPSBhbWRncHVfYm9fcmVzZXJ2ZShibywg
ZmFsc2UpOwotCWlmICh1bmxpa2VseShyICE9IDApKQotCQlnb3RvIG91dDsKLQotCS8qCi0JICog
V2Ugb25seSBjcmVhdGUgc2hhcmVkIGZlbmNlcyBmb3IgaW50ZXJuYWwgdXNlLCBidXQgaW1wb3J0
ZXJzCi0JICogb2YgdGhlIGRtYWJ1ZiByZWx5IG9uIGV4Y2x1c2l2ZSBmZW5jZXMgZm9yIGltcGxp
Y2l0bHkKLQkgKiB0cmFja2luZyB3cml0ZSBoYXphcmRzLiBBcyBhbnkgb2YgdGhlIGN1cnJlbnQg
ZmVuY2VzIG1heQotCSAqIGNvcnJlc3BvbmQgdG8gYSB3cml0ZSwgd2UgbmVlZCB0byBjb252ZXJ0
IGFsbCBleGlzdGluZwotCSAqIGZlbmNlcyBvbiB0aGUgcmVzZXJ2YXRpb24gb2JqZWN0IGludG8g
YSBzaW5nbGUgZXhjbHVzaXZlCi0JICogZmVuY2UuCi0JICovCi0JciA9IF9fZG1hX3Jlc3ZfbWFr
ZV9leGNsdXNpdmUoYm8tPnRiby5iYXNlLnJlc3YpOwotCWlmIChyKQotCQlnb3RvIG91dDsKLQot
CWJvLT5wcmltZV9zaGFyZWRfY291bnQrKzsKLQlhbWRncHVfYm9fdW5yZXNlcnZlKGJvKTsKIAly
ZXR1cm4gMDsKIAogb3V0OgpAQCAtMTUwLDkgKzkwLDYgQEAgc3RhdGljIHZvaWQgYW1kZ3B1X2Rt
YV9idWZfZGV0YWNoKHN0cnVjdCBkbWFfYnVmICpkbWFidWYsCiAJc3RydWN0IGFtZGdwdV9ibyAq
Ym8gPSBnZW1fdG9fYW1kZ3B1X2JvKG9iaik7CiAJc3RydWN0IGFtZGdwdV9kZXZpY2UgKmFkZXYg
PSBhbWRncHVfdHRtX2FkZXYoYm8tPnRiby5iZGV2KTsKIAotCWlmIChhdHRhY2gtPmRldi0+ZHJp
dmVyICE9IGFkZXYtPmRldi0+ZHJpdmVyICYmIGJvLT5wcmltZV9zaGFyZWRfY291bnQpCi0JCWJv
LT5wcmltZV9zaGFyZWRfY291bnQtLTsKLQogCXBtX3J1bnRpbWVfbWFya19sYXN0X2J1c3koYWRl
dl90b19kcm0oYWRldiktPmRldik7CiAJcG1fcnVudGltZV9wdXRfYXV0b3N1c3BlbmQoYWRldl90
b19kcm0oYWRldiktPmRldik7CiB9CkBAIC00MDYsOCArMzQzLDYgQEAgYW1kZ3B1X2RtYV9idWZf
Y3JlYXRlX29iaihzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCBzdHJ1Y3QgZG1hX2J1ZiAqZG1hX2J1
ZikKIAlibyA9IGdlbV90b19hbWRncHVfYm8oZ29iaik7CiAJYm8tPmFsbG93ZWRfZG9tYWlucyA9
IEFNREdQVV9HRU1fRE9NQUlOX0dUVDsKIAliby0+cHJlZmVycmVkX2RvbWFpbnMgPSBBTURHUFVf
R0VNX0RPTUFJTl9HVFQ7Ci0JaWYgKGRtYV9idWYtPm9wcyAhPSAmYW1kZ3B1X2RtYWJ1Zl9vcHMp
Ci0JCWJvLT5wcmltZV9zaGFyZWRfY291bnQgPSAxOwogCiAJZG1hX3Jlc3ZfdW5sb2NrKHJlc3Yp
OwogCXJldHVybiBnb2JqOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUv
YW1kZ3B1X2dlbS5jIGIvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X2dlbS5jCmlu
ZGV4IDFjM2UzYjYwODMzMi4uNWQ4MjEyMGZjMTYwIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9k
cm0vYW1kL2FtZGdwdS9hbWRncHVfZ2VtLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRn
cHUvYW1kZ3B1X2dlbS5jCkBAIC04MjksNyArODI5LDggQEAgaW50IGFtZGdwdV9nZW1fb3BfaW9j
dGwoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKIAkJYnJlYWs7CiAJfQogCWNh
c2UgQU1ER1BVX0dFTV9PUF9TRVRfUExBQ0VNRU5UOgotCQlpZiAocm9iai0+cHJpbWVfc2hhcmVk
X2NvdW50ICYmIChhcmdzLT52YWx1ZSAmIEFNREdQVV9HRU1fRE9NQUlOX1ZSQU0pKSB7CisJCWlm
IChyb2JqLT50Ym8uYmFzZS5pbXBvcnRfYXR0YWNoICYmCisJCSAgICBhcmdzLT52YWx1ZSAmIEFN
REdQVV9HRU1fRE9NQUlOX1ZSQU0pIHsKIAkJCXIgPSAtRUlOVkFMOwogCQkJYW1kZ3B1X2JvX3Vu
cmVzZXJ2ZShyb2JqKTsKIAkJCWJyZWFrOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2Ft
ZC9hbWRncHUvYW1kZ3B1X29iamVjdC5jIGIvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1k
Z3B1X29iamVjdC5jCmluZGV4IDk2NDQ3ZTFkNGM5Yy4uMzA5NTFiNTkzODA5IDEwMDY0NAotLS0g
YS9kcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfb2JqZWN0LmMKKysrIGIvZHJpdmVy
cy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X29iamVjdC5jCkBAIC04NzEsNyArODcxLDcgQEAg
aW50IGFtZGdwdV9ib19waW5fcmVzdHJpY3RlZChzdHJ1Y3QgYW1kZ3B1X2JvICpibywgdTMyIGRv
bWFpbiwKIAkJcmV0dXJuIC1FSU5WQUw7CiAKIAkvKiBBIHNoYXJlZCBibyBjYW5ub3QgYmUgbWln
cmF0ZWQgdG8gVlJBTSAqLwotCWlmIChiby0+cHJpbWVfc2hhcmVkX2NvdW50IHx8IGJvLT50Ym8u
YmFzZS5pbXBvcnRfYXR0YWNoKSB7CisJaWYgKGJvLT50Ym8uYmFzZS5pbXBvcnRfYXR0YWNoKSB7
CiAJCWlmIChkb21haW4gJiBBTURHUFVfR0VNX0RPTUFJTl9HVFQpCiAJCQlkb21haW4gPSBBTURH
UFVfR0VNX0RPTUFJTl9HVFQ7CiAJCWVsc2UKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9h
bWQvYW1kZ3B1L2FtZGdwdV9vYmplY3QuaCBiL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2Ft
ZGdwdV9vYmplY3QuaAppbmRleCBiMzU5NjI3MDIyNzguLjU1ZDdlOTBlYWE3MiAxMDA2NDQKLS0t
IGEvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X29iamVjdC5oCisrKyBiL2RyaXZl
cnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV9vYmplY3QuaApAQCAtOTgsNyArOTgsNiBAQCBz
dHJ1Y3QgYW1kZ3B1X2JvIHsKIAlzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QJdGJvOwogCXN0cnVj
dCB0dG1fYm9fa21hcF9vYmoJCWttYXA7CiAJdTY0CQkJCWZsYWdzOwotCXVuc2lnbmVkCQkJcHJp
bWVfc2hhcmVkX2NvdW50OwogCS8qIHBlciBWTSBzdHJ1Y3R1cmUgZm9yIHBhZ2UgdGFibGVzIGFu
ZCB3aXRoIHZpcnR1YWwgYWRkcmVzc2VzICovCiAJc3RydWN0IGFtZGdwdV92bV9ib19iYXNlCSp2
bV9ibzsKIAkvKiBDb25zdGFudCBhZnRlciBpbml0aWFsaXphdGlvbiAqLwotLSAKMi4yNS4xCgpf
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwphbWQtZ2Z4IG1h
aWxpbmcgbGlzdAphbWQtZ2Z4QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZy
ZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2FtZC1nZngK
